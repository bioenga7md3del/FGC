<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        input, button, select { display: block; width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; }
        button { background-color: #28a745; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #218838; }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: #fff; border-right: 5px solid #007bff; }
        .logout-btn { background-color: #dc3545; width: auto; float: left; }
        h2, h3 { color: #333; }
        .admin-controls { background: #e2e6ea; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px dashed #333; }
        .error { color: red; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="loginSection">
        <h2 style="text-align: center;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</h2>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        <button onclick="signup()" style="background-color: #007bff;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button> 
        <p id="loginError" class="error"></p>
    </div>

    <div id="dashboardSection" class="hidden">
        <button onclick="logout()" class="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <div style="clear: both;"></div>
        
        <h2 id="welcomeMsg">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
        
        <div id="adminPanel" class="hidden admin-controls">
            <h3>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="newSiteName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø«Ø§Ù„: Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ØªØ­Ø±Ùƒ)">
            <input type="number" id="newSiteBudget" placeholder="Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©">
            <button onclick="addNewSite()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        </div>

        <h3>Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ùƒ:</h3>
        <div id="sitesContainer">
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
    </div>

</div>

<script>
    // --------------------------------------------------------------
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
    // --------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI",
        authDomain: "fgcbio.firebaseapp.com",
        projectId: "fgcbio",
        storageBucket: "fgcbio.firebasestorage.app",
        messagingSenderId: "924334872806",
        appId: "1:924334872806:web:fac89ce388b1ff2de24327",
        measurementId: "G-H9VW2MZQG0"
    };

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… syntax Ø§Ù„Ù€ compat Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø³Ù‡Ù„
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --------------------------------------------------------------
    // 2. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth)
    // --------------------------------------------------------------
    
    // Ù…Ø±Ø§Ù‚Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©)
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.email}`;
            
            checkUserRole(user.uid);
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }
    });

    function login() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        if(!email || !pass) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        auth.signInWithEmailAndPassword(email, pass)
            .catch((error) => document.getElementById('loginError').innerText = "Ø®Ø·Ø£: " + error.message);
    }

    function signup() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        if(!email || !pass) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        auth.createUserWithEmailAndPassword(email, pass)
            .then((userCredential) => {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                db.collection("users").doc(userCredential.user.uid).set({
                    email: email,
                    role: "user",
                    assignedSiteId: ""
                });
                alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.");
            })
            .catch((error) => document.getElementById('loginError').innerText = error.message);
    }

    function logout() {
        auth.signOut();
    }

    // --------------------------------------------------------------
    // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ (Logic)
    // --------------------------------------------------------------

    let currentUserRole = null;
    let currentAssignedSite = null;

    function checkUserRole(uid) {
        db.collection('users').doc(uid).get().then((doc) => {
            if (doc.exists) {
                const userData = doc.data();
                currentUserRole = userData.role;
                currentAssignedSite = userData.assignedSiteId;

                if (currentUserRole === 'admin') {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadAllSites(); 
                } else {
                    document.getElementById('adminPanel').classList.add('hidden');
                    loadMySite(currentAssignedSite); 
                }
            } else {
                console.log("No user document found!");
            }
        });
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø£Ø¯Ù…Ù†: ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Real-time)
    function loadAllSites() {
        db.collection("budgets").onSnapshot((querySnapshot) => {
            renderSites(querySnapshot.docs);
        });
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ØªØ­Ù…ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ù‡ ÙÙ‚Ø· (Real-time)
    function loadMySite(siteId) {
        if(!siteId) {
            document.getElementById('sitesContainer').innerHTML = "<p>Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ù„Ùƒ Ø¨Ø¹Ø¯. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±.</p>";
            return;
        }
        db.collection("budgets").doc(siteId).onSnapshot((doc) => {
            if(doc.exists) {
                renderSites([doc]); 
            } else {
                document.getElementById('sitesContainer').innerHTML = "<p>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>";
            }
        });
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
    function renderSites(docs) {
        const container = document.getElementById('sitesContainer');
        container.innerHTML = "";
        
        if (docs.length === 0) {
            container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
            return;
        }

        docs.forEach((doc) => {
            const data = doc.data();
            const totalSpent = data.totalSpent || 0;
            const currentBalance = data.currentBalance !== undefined ? data.currentBalance : data.totalAllocatedAmount;

            const html = `
            <div class="card">
                <h3>ğŸ¢ ${data.itemName}</h3>
                <p><strong>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©:</strong> ${Number(data.totalAllocatedAmount).toLocaleString('ar-EG')}</p>
                <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ:</strong> ${Number(totalSpent).toLocaleString('ar-EG')}</p>
                <p><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> <span style="font-weight: bold; color:${currentBalance < 0 ? 'red' : 'green'}">${Number(currentBalance).toLocaleString('ar-EG')}</span></p>
                <button onclick="openSiteDetails('${doc.id}')">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ¥Ø¶Ø§ÙØ© ÙÙˆØ§ØªÙŠØ±</button>
            </div>
            `;
            container.innerHTML += html;
        });
    }

    function addNewSite() {
        const name = document.getElementById('newSiteName').value;
        const budget = Number(document.getElementById('newSiteBudget').value);

        if (!name || !budget || isNaN(budget) || budget <= 0) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©");

        db.collection("budgets").add({
            itemName: name,
            totalAllocatedAmount: budget,
            currentBalance: budget,
            totalSpent: 0,
            totalProfit: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById('newSiteName').value = "";
            document.getElementById('newSiteBudget').value = "";
        }).catch((error) => {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + error.message);
        });
    }

    function openSiteDetails(siteId) {
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹
        window.location.href = "details.html?id=" + siteId;
    }
</script>

</body>
</html>
