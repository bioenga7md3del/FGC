<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - FGC System</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="login-wrapper">
    <div class="card login-box">
        <h2 style="color: var(--primary); margin-bottom: 5px;">FGC System</h2>
        <p style="color: #7f8c8d; margin-bottom: 30px;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ÙˆØ§Ù„ØªØ¹Ù…ÙŠØ¯Ø§Øª</p>
        
        <h3 id="formTitle" style="color: var(--secondary);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>

        <div style="text-align: right;">
            <label style="font-size: 0.9em; font-weight: bold;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" id="email" placeholder="name@company.com">
            
            <label style="font-size: 0.9em; font-weight: bold;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="password" placeholder="******">
        </div>
        
        <button onclick="handleAuth()" id="actionBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px; padding: 12px;">
            Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
        </button>
        
        <p id="errorMsg" style="color: #c0392b; margin-top: 15px; font-size: 0.9em; font-weight: bold;"></p>

        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            <span id="toggleText">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ </span>
            <a href="#" onclick="toggleMode()" id="toggleLink" style="color: var(--secondary); font-weight: bold; text-decoration: none;">
                Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
            </a>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI",
        authDomain: "fgcbio.firebaseapp.com",
        projectId: "fgcbio",
        storageBucket: "fgcbio.firebasestorage.app",
        messagingSenderId: "924334872806",
        appId: "1:924334872806:web:fac89ce388b1ff2de24327",
        measurementId: "G-H9VW2MZQG0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let isLoginMode = true;
    let isSigningUp = false; // ğŸ›‘ Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…ØªØ³Ø±Ø¹

    // 1. Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    auth.onAuthStateChanged(user => {
        // Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ ÙˆÙ„ÙƒÙ†Ù†Ø§ Ù„Ø³Ù†Ø§ ÙÙŠ ÙˆØ¶Ø¹ "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„"ØŒ Ù‚Ù… Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
        if(user && !isSigningUp) {
            window.location.href = "dashboard.html";
        }
    });

    // 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    function toggleMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('formTitle');
        const btn = document.getElementById('actionBtn');
        const toggleText = document.getElementById('toggleText');
        const toggleLink = document.getElementById('toggleLink');
        
        document.getElementById('errorMsg').innerText = "";

        if (isLoginMode) {
            title.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
            btn.innerText = "Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…";
            btn.className = "btn btn-primary";
            toggleText.innerText = "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ ";
            toggleLink.innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
        } else {
            title.innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
            btn.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨";
            btn.className = "btn btn-success";
            toggleText.innerText = "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ";
            toggleLink.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        }
    }

    // 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('actionBtn');
        const errorMsg = document.getElementById('errorMsg');
        
        if(!email || !pass) return errorMsg.innerText = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
        if (pass.length < 6) return errorMsg.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)";

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...";
        errorMsg.innerText = "";

        if (isLoginMode) {
            // --- ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ---
            auth.signInWithEmailAndPassword(email, pass).catch(err => handleError(err, btn));
        } else {
            // --- Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ---
            isSigningUp = true; // ğŸ›‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø§ÙŠØ©: "Ù†Ø­Ù† Ù†Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†ØŒ Ù„Ø§ ØªÙ†Ù‚Ù„Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"

            auth.createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    // Ø§Ù„Ø¢Ù† Ù†Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ†Ø­Ù† Ù…Ø·Ù…Ø¦Ù†ÙˆÙ† Ø£Ù† Ø§Ù„ØµÙØ­Ø© Ù„Ù† ØªØºÙ„Ù‚
                    return db.collection('users').doc(userCredential.user.uid).set({
                        email: email,
                        role: 'user',        
                        assignedSiteId: '',  
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙŠÙˆØ²Ø± ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ²");
                    // Ø§Ù„Ø¢Ù† ÙÙ‚Ø· Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ÙØ¸
                    window.location.href = "dashboard.html";
                })
                .catch(err => {
                    isSigningUp = false; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø§ÙŠØ© ÙÙŠ Ø­Ø§Ù„ Ø­Ø¯ÙˆØ« Ø®Ø·Ø£
                    handleError(err, btn);
                    // ÙÙŠ Ø­Ø§Ù„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Auth ÙˆÙØ´Ù„ ÙÙŠ DatabaseØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø°ÙÙ‡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
                    if(auth.currentUser) auth.currentUser.delete();
                });
        }
    }

    function handleError(err, btn) {
        btn.disabled = false;
        btn.innerText = isLoginMode ? "Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…" : "ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨";
        let message = err.message;
        if(err.code === 'auth/email-already-in-use') message = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„";
        if(err.code === 'auth/weak-password') message = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©";
        document.getElementById('errorMsg').innerText = "Ø®Ø·Ø£: " + message;
    }
</script>
</body>
</html>
