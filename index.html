<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول - FGC</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="login-wrapper">
    <div class="card login-box">
        <img src="FGC.jpeg" alt="FGC Logo" class="logo-img login-logo">
        
        <h2 style="color: var(--primary-dark); margin-bottom: 5px; font-weight: 800;">نظام إدارة المشاريع</h2>
        <p style="color: var(--text-light); margin-bottom: 30px;">يرجى تسجيل الدخول للمتابعة</p>
        
        <h3 id="formTitle" style="color: var(--accent-orange); margin-bottom: 20px;">تسجيل الدخول</h3>

        <div style="text-align: right;">
            <label>البريد الإلكتروني</label>
            <input type="email" id="email" placeholder="name@fgc.com">
            
            <label>كلمة المرور</label>
            <input type="password" id="password" placeholder="******">
        </div>
        
        <button onclick="handleAuth()" id="actionBtn" class="btn btn-primary" style="width: 100%; margin-top: 25px; font-size: 1.1rem;">
            دخول للنظام
        </button>
        
        <p id="errorMsg" style="color: var(--danger); margin-top: 15px; font-weight: bold;"></p>

        <div style="margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px; font-size: 0.95rem;">
            <span id="toggleText" style="color: var(--text-light);">ليس لديك حساب؟ </span>
            <a href="#" onclick="toggleMode()" id="toggleLink" style="color: var(--primary-light); font-weight: bold; text-decoration: none;">
                إنشاء حساب موظف جديد
            </a>
        </div>
    </div>
</div>

<script>
    // --- نفس كود الجافاسكربت السابق تماماً ---
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327", measurementId: "G-H9VW2MZQG0" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let isLoginMode = true;
    let isSigningUp = false;

    auth.onAuthStateChanged(user => {
        if(user && !isSigningUp) window.location.href = "dashboard.html";
    });

    function toggleMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('formTitle');
        const btn = document.getElementById('actionBtn');
        const toggleText = document.getElementById('toggleText');
        const toggleLink = document.getElementById('toggleLink');
        document.getElementById('errorMsg').innerText = "";

        if (isLoginMode) {
            title.innerText = "تسجيل الدخول";
            btn.innerText = "دخول للنظام";
            btn.className = "btn btn-primary";
            toggleText.innerText = "ليس لديك حساب؟ ";
            toggleLink.innerText = "إنشاء حساب موظف جديد";
        } else {
            title.innerText = "إنشاء حساب جديد";
            btn.innerText = "تسجيل حساب";
            btn.className = "btn btn-success";
            toggleText.innerText = "لديك حساب بالفعل؟ ";
            toggleLink.innerText = "تسجيل الدخول";
        }
    }

    function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('actionBtn');
        const errorMsg = document.getElementById('errorMsg');
        
        if(!email || !pass) return errorMsg.innerText = "يرجى إدخال البيانات";
        if (pass.length < 6) return errorMsg.innerText = "كلمة المرور قصيرة (6 أحرف على الأقل)";

        btn.disabled = true;
        btn.innerText = "جاري العمل...";
        errorMsg.innerText = "";

        if (isLoginMode) {
            auth.signInWithEmailAndPassword(email, pass).catch(err => handleError(err, btn));
        } else {
            isSigningUp = true;
            auth.createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        email: email, role: 'user', assignedSiteId: '', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => window.location.href = "dashboard.html")
                .catch(err => {
                    isSigningUp = false;
                    handleError(err, btn);
                    if(auth.currentUser) auth.currentUser.delete();
                });
        }
    }

    function handleError(err, btn) {
        btn.disabled = false;
        btn.innerText = isLoginMode ? "دخول للنظام" : "تسجيل حساب";
        let message = err.message;
        if(err.code === 'auth/email-already-in-use') message = "البريد مسجل بالفعل";
        if(err.code === 'auth/weak-password') message = "كلمة المرور ضعيفة";
        if(err.code === 'auth/user-not-found') message = "المستخدم غير موجود";
        if(err.code === 'auth/wrong-password') message = "كلمة المرور غير صحيحة";
        document.getElementById('errorMsg').innerText = "خطأ: " + message;
    }
</script>
</body>
</html>
