<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - FGC Enterprise</title> 
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #1a3c6d; --accent: #d4af37; --text-gray: #6c757d; --bg-light: #f8f9fd; }
        body { margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; background-color: var(--bg-light); height: 100vh; overflow: hidden; display: flex; }
        .brand-section { flex: 1.2; background-image: linear-gradient(135deg, rgba(26, 60, 109, 0.9), rgba(26, 60, 109, 0.7)), url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?q=80&w=2070&auto=format&fit=crop'); background-size: cover; background-position: center; color: white; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; padding: 60px; position: relative; }
        .brand-content h1 { font-size: 3.5rem; margin: 0 0 20px 0; font-weight: 800; line-height: 1.2; }
        .brand-content p { font-size: 1.2rem; opacity: 0.8; max-width: 500px; line-height: 1.6; }
        .glass-badge { margin-top: 30px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 50px; border: 1px solid rgba(255, 255, 255, 0.2); display: inline-flex; align-items: center; gap: 10px; font-weight: bold; color: var(--accent); }
        .login-section { flex: 1; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; box-shadow: -10px 0 30px rgba(0,0,0,0.05); }
        .login-container { width: 100%; max-width: 400px; animation: slideInLeft 1s ease-out; }
        .logo-area { text-align: center; margin-bottom: 40px; }
        .logo-img { height: 80px; margin-bottom: 15px; }
        .welcome-text h2 { color: var(--primary); font-size: 1.8rem; margin: 0; }
        .welcome-text p { color: var(--text-gray); margin-top: 5px; }
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--primary); font-weight: 600; font-size: 0.9rem; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #b0b0b0; transition: 0.3s; }
        .input-wrapper input { width: 100%; padding: 14px 50px 14px 15px; border: 2px solid #eee; border-radius: 10px; font-family: 'Tajawal'; font-size: 1rem; transition: all 0.3s; box-sizing: border-box; background: #fdfdfd; }
        .input-wrapper input:focus { border-color: var(--primary); background: white; outline: none; box-shadow: 0 4px 15px rgba(26, 60, 109, 0.1); }
        .btn-main { width: 100%; padding: 16px; background: linear-gradient(to right, var(--primary), #2a5298); color: white; border: none; border-radius: 10px; font-family: 'Tajawal'; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; margin-top: 10px; box-shadow: 0 4px 15px rgba(26, 60, 109, 0.3); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(26, 60, 109, 0.4); }
        .btn-main:disabled { background: #ccc; transform: none; cursor: not-allowed; }
        .switch-mode { text-align: center; margin-top: 25px; color: var(--text-gray); font-size: 0.95rem; }
        .switch-mode a { color: var(--primary); font-weight: bold; text-decoration: none; }
        #errorMsg { text-align: center; color: #dc3545; font-weight: bold; margin-top: 15px; min-height: 20px; font-size: 0.9em; }
        
        /* --- Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Remember me & Forgot Password) --- */
        .options-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 0.9rem; }
        .remember-me { display: flex; align-items: center; gap: 5px; cursor: pointer; color: var(--text-gray); }
        .remember-me input { cursor: pointer; accent-color: var(--primary); width: 16px; height: 16px; }
        .forgot-link { color: var(--primary); text-decoration: none; font-weight: bold; font-size: 0.9rem; transition: 0.3s; }
        .forgot-link:hover { text-decoration: underline; color: var(--accent); }

        @media (max-width: 768px) { body { flex-direction: column; height: auto; overflow-y: auto; } .brand-section { padding: 40px 20px; min-height: 250px; flex: none; align-items: center; text-align: center; } .login-section { padding: 40px 20px; border-radius: 30px 30px 0 0; margin-top: -30px; } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div class="brand-section">
        <div class="brand-content">
            <h1 style="color: var(--accent);">FGC System</h1>
            <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h1>
            <p>Ù…Ù†ØµØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§ØªØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¹Ù…ÙŠØ¯Ø§ØªØŒ ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„ÙŠ Ø¨Ø¯Ù‚Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.</p>
            <div class="glass-badge"><i class="fa-solid fa-shield-halved"></i> <span>Ù†Ø¸Ø§Ù… Ø¢Ù…Ù† ÙˆÙ…Ø­Ù…ÙŠ 100%</span></div>
        </div>
    </div>

    <div class="login-section">
        <div class="login-container">
            <div class="logo-area">
                <img src="FGC.jpeg" alt="FGC Logo" class="logo-img">
                <div class="welcome-text">
                    <h2 id="formTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ğŸ‘‹</h2>
                    <p id="formSubtitle">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                </div>
            </div>

            <div class="input-group">
                <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <div class="input-wrapper">
                    <input type="email" id="email" placeholder="name@fgc.com">
                    <i class="fa-regular fa-envelope"></i>
                </div>
            </div>

            <div class="input-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <div class="input-wrapper">
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    <i class="fa-solid fa-lock"></i>
                </div>
            </div>

            <div class="options-row" id="loginOptions">
                <label class="remember-me">
                    <input type="checkbox" id="rememberMe" checked>
                    <span>Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù…ØªØµÙ„Ø§Ù‹</span>
                </label>
                <a href="#" onclick="forgotPassword()" class="forgot-link">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
            </div>

            <button onclick="handleAuth()" id="actionBtn" class="btn-main">
                Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… <i class="fa-solid fa-arrow-left" style="margin-right: 10px;"></i>
            </button>
            <p id="errorMsg"></p>

            <div class="switch-mode">
                <span id="toggleText">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¸ÙØŸ </span>
                <a href="#" onclick="toggleMode()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let isLoginMode = true;
    let isSigningUp = false;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    auth.onAuthStateChanged(async user => {
        if(user && !isSigningUp) {
            const btn = document.getElementById('actionBtn');
            if(btn) btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...';

            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if(userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.role === 'admin') {
                        window.location.href = "dashboard.html";
                    } else if (userData.role === 'user' && userData.assignedSiteId) {
                        window.location.href = "details.html?id=" + userData.assignedSiteId;
                    } else {
                        window.location.href = "dashboard.html";
                    }
                }
            } catch (error) {
                console.error("Error fetching user role:", error);
                window.location.href = "dashboard.html";
            }
        }
    });

    // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    function forgotPassword() {
        const email = document.getElementById('email').value;
        if (!email) {
            alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ (Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±) Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            document.getElementById('email').focus();
            return;
        }
        
        if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰: ${email}ØŸ`)) return;

        auth.sendPasswordResetEmail(email)
            .then(() => {
                alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ø£Ùˆ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡Ø§).");
            })
            .catch((error) => {
                let msg = error.message;
                if(error.code === 'auth/user-not-found') msg = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§.";
                if(error.code === 'auth/invalid-email') msg = "ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                alert("âŒ Ø®Ø·Ø£: " + msg);
            });
    }

    function toggleMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('formTitle');
        const sub = document.getElementById('formSubtitle');
        const btn = document.getElementById('actionBtn');
        const toggleText = document.getElementById('toggleText');
        const toggleLink = document.querySelector('.switch-mode a');
        const loginOptions = document.getElementById('loginOptions'); // Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        
        document.getElementById('errorMsg').innerText = "";

        if (isLoginMode) {
            title.innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ğŸ‘‹";
            sub.innerText = "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©";
            btn.innerHTML = 'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… <i class="fa-solid fa-arrow-left" style="margin-right: 10px;"></i>';
            toggleText.innerText = "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¸ÙØŸ ";
            toggleLink.innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
            loginOptions.style.display = "flex"; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        } else {
            title.innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸš€";
            sub.innerText = "Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„";
            btn.innerHTML = 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ <i class="fa-solid fa-user-plus" style="margin-right: 10px;"></i>';
            toggleText.innerText = "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ";
            toggleLink.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
            loginOptions.style.display = "none"; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
        }
    }

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('actionBtn');
        const errorMsg = document.getElementById('errorMsg');
        
        if(!email || !pass) return errorMsg.innerText = "ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
        if (pass.length < 6) return errorMsg.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø®Ø§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„";

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        errorMsg.innerText = "";

        if (isLoginMode) {
            // Ù…Ù†Ø·Ù‚ "Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù…ØªØµÙ„Ø§Ù‹"
            const rememberMe = document.getElementById('rememberMe').checked;
            const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;

            auth.setPersistence(persistence)
                .then(() => {
                    return auth.signInWithEmailAndPassword(email, pass);
                })
                .catch(err => handleError(err, btn));
        } else {
            isSigningUp = true;
            auth.createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        email: email, role: 'user', assignedSiteId: '', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    window.location.href = "dashboard.html";
                })
                .catch(err => {
                    isSigningUp = false;
                    handleError(err, btn);
                    if(auth.currentUser) auth.currentUser.delete();
                });
        }
    }

    function handleError(err, btn) {
        btn.disabled = false;
        btn.innerHTML = isLoginMode ? 'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… <i class="fa-solid fa-arrow-left" style="margin-right: 10px;"></i>' : 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ <i class="fa-solid fa-user-plus" style="margin-right: 10px;"></i>';
        let message = err.message;
        if(err.code === 'auth/user-not-found') message = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
        if(err.code === 'auth/wrong-password') message = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©";
        if(err.code === 'auth/email-already-in-use') message = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹";
        if(err.code === 'auth/too-many-requests') message = "Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø®Ø§Ø·Ø¦Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹";
        document.getElementById('errorMsg').innerText = message;
    }
</script>
</body>
</html>
