<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงูุชุญูู - FGC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* ุฅุตูุงุญ ุงูููุฏุฑ ูููุน ุงูุชุฏุงุฎู */
        .contract-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* ูุญุงุฐุงุฉ ููุฃุนูู ุนุดุงู ูู ุงููุต ุทููู */
            flex-wrap: wrap; /* ูุณูุญ ุจูุฒูู ุงูุนูุงุตุฑ ูู ุงููุณุงุญุฉ ุถููุฉ */
            height: auto !important; /* ุฅูุบุงุก ุฃู ุงุฑุชูุงุน ุซุงุจุช */
            min-height: 70px;
            padding: 20px;
            gap: 15px; /* ูุณุงูุฉ ุจูู ุงููุต ูุงูุฒุฑุงูุฑ */
        }

        /* ุชูุณูู ุงูุฌุฒุก ุงูุฎุงุต ุจุงููุตูุต ุฏุงุฎู ุงูููุฏุฑ */
        .contract-info-text {
            flex: 1; 
            min-width: 250px; /* ุถูุงู ูุณุงุญุฉ ูููุต */
            display: flex;
            flex-direction: column;
            gap: 8px; /* ูุณุงูุฉ ุจูู ุงูุนููุงู ูุงูุชูุงุตูู ุงูุตุบูุฑุฉ */
        }

        /* ุชูุณูู ุงูุฌุฒุก ุงูุฎุงุต ุจุงูุฃุฒุฑุงุฑ ุฏุงุฎู ุงูููุฏุฑ */
        .contract-actions-box {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0; /* ููุน ุงูุฒุฑุงูุฑ ูู ุงูุงูููุงุด */
        }

        /* ุชุญุณูู ุดูู ูุงุฑุช ุงููุดุฑูุน ุงููุฌูุน */
        .project-group-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        
        .project-header {
            background: #f8f9fa;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: var(--primary);
            border-bottom: 1px solid #eee;
        }

        .project-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f1f1;
            background: white;
            transition: 0.2s;
        }
        .project-item-row:last-child { border-bottom: none; }
        .project-item-row:hover { background: #fafafa; }
        
        .cat-indicator {
            display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-left: 10px;
        }

        /* ุชุญุณูู ุดูู ุงูููุจุงูู */
        @media (max-width: 768px) {
            .project-item-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .project-item-row > div {
                width: 100%;
                display: flex;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <h3 style="color: var(--primary); margin-top: 20px;">ุฌุงุฑู ุงูุชุญููู...</h3>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span style="font-size: 0.8rem; color: #888;">ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน ูุงูุนููุฏ</span>
            </div>
        </div>
        <button onclick="logout()" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> ุฎุฑูุฌ</button>
    </nav>

    <div class="container">
        
        <div id="adminPanel" style="margin-bottom: 25px; display:none;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="document.getElementById('addContractModal').style.display='flex'" class="btn btn-primary" style="flex: 2; padding: 15px; font-size: 1.1em;">
                    <i class="fa-solid fa-plus-circle"></i> ุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏ
                </button>
                <button onclick="openUsersModal()" class="btn btn-outline" style="flex: 1; min-width: 150px;">
                    <i class="fa-solid fa-users-gear"></i> ุงููุณุชุฎุฏููู
                </button>
            </div>
        </div>

        <h3 style="border-bottom: 3px solid var(--accent); display: inline-block; padding-bottom: 8px; margin-bottom: 25px; color: var(--primary);">
            <i class="fa-solid fa-folder-tree"></i> ุงูุนููุฏ ูุงููุดุงุฑูุน ุงููุดุทุฉ
        </h3>
        
        <div id="contractsGrid">
            </div>
    </div>

    <div id="addContractModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('addContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏ</h2>
            <div class="input-group">
                <div class="input-box">
                    <label>ุงุณู ุงูุนูุฏ (ูุซุงู: ุนูุฏ ููุทูุฉ ุงูุฑูุงุถ)</label>
                    <input type="text" id="newContractName">
                </div>
                <div class="input-box">
                    <label>ุงูุฌูุฉ ุงููุดุฑูุฉ</label>
                    <input type="text" id="newContractAuth">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-box" style="flex:1;"><label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</label><input type="date" id="newContractStart"></div>
                    <div class="input-box" style="flex:1;"><label>ุชุงุฑูุฎ ุงูููุงูุฉ</label><input type="date" id="newContractEnd"></div>
                </div>
                <button onclick="addContract()" class="btn-add">ุญูุธ ุงูุนูุฏ</button>
            </div>
        </div>
    </div>

    <div id="addSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="document.getElementById('addSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ุฅุถุงูุฉ ูุดุฑูุน ุฌุฏูุฏ</h2>
            <p style="color:#666; font-size:0.9em;">ุณูุชู ุฅูุดุงุก 3 ุจููุฏ ูููุดุฑูุน ุชููุงุฆูุงู (ูุทุน ุบูุงุฑุ ุนูุงูุฉุ ููุงูููู).</p>
            
            <input type="hidden" id="targetContractId">
            
            <div class="input-group">
                <div class="input-box">
                    <label>ุงุณู ุงููุดุฑูุน (ูุซุงู: ุงููุฑูู ุงููุชุญุฑู)</label>
                    <input type="text" id="siteNameInput" placeholder="ุงูุชุจ ุงุณู ุงููุดุฑูุน ููุง...">
                </div>
                
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px dashed #ddd; margin-top:10px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--accent-orange);">ุชูุฒูุน ุงูููุฒุงููุฉ:</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div class="input-box">
                            <label style="font-size:0.85em;">โ๏ธ ูุทุน ุบูุงุฑ</label>
                            <input type="number" id="budgetParts" placeholder="0">
                        </div>
                        <div class="input-box">
                            <label style="font-size:0.85em;">๐ท ุนูุงูุฉ</label>
                            <input type="number" id="budgetLabor" placeholder="0">
                        </div>
                        <div class="input-box">
                            <label style="font-size:0.85em;">๐ค ููุงูููู</label>
                            <input type="number" id="budgetSubs" placeholder="0">
                        </div>
                    </div>
                </div>

                <button onclick="addProjectGroup()" class="btn-add">ุญูุธ ุงููุดุฑูุน</button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h2>
            <div class="table-container">
                <table style="width:100%">
                    <thead><tr><th>ุงูุจุฑูุฏ</th><th>ุงูุตูุงุญูุฉ</th><th>ุงููููุน ุงููุฎุตุต</th><th>ุญูุธ</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allContracts = [];
    let allSites = [];

    // --- ุงูุชุญูู ูู ุงูุตูุงุญูุฉ ---
    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const role = userDoc.data().role;
            if (role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
                loadData(); 
            } else {
                 if(userDoc.data().assignedSiteId) window.location.href = "details.html?id=" + userDoc.data().assignedSiteId;
                 else { alert("ููุณ ูุฏูู ุตูุงุญูุฉ."); window.location.href="index.html"; }
            }
        }
    });

    // --- ุฌูุจ ุงูุจูุงูุงุช ---
    function loadData() {
        db.collection("contracts").orderBy("createdAt", "desc").onSnapshot(contractSnap => {
            allContracts = [];
            contractSnap.forEach(doc => allContracts.push({ id: doc.id, ...doc.data() }));
            
            db.collection("budgets").onSnapshot(siteSnap => {
                allSites = [];
                siteSnap.forEach(doc => allSites.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        });
    }

    // --- ุฑุณู ุงูุดุงุดุฉ ---
    function renderDashboard() {
        const container = document.getElementById('contractsGrid');
        container.innerHTML = "";

        if (allContracts.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#888;">ูุง ุชูุฌุฏ ุนููุฏ ุญุงููุงู. ุงุจุฏุฃ ุจุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏ.</div>`;
            return;
        }

        allContracts.forEach(contract => {
            // ููุชุฑุฉ ุงูุจููุฏ
            const contractItems = allSites.filter(site => site.contractId === contract.id);
            
            // ุงูุชุฌููุน ุญุณุจ ุงุณู ุงููุดุฑูุน
            const projectsGrouped = {};
            contractItems.forEach(item => {
                const name = item.itemName;
                if(!projectsGrouped[name]) projectsGrouped[name] = [];
                projectsGrouped[name].push(item);
            });

            const totalContractBudget = contractItems.reduce((sum, i) => sum + (i.totalAllocatedAmount||0), 0);

            let projectsHTML = "";
            const projectNames = Object.keys(projectsGrouped);

            if (projectNames.length === 0) {
                projectsHTML = `<div style="text-align:center; padding:20px; color:#999; border: 1px dashed #ccc; border-radius: 8px;">ูุง ุชูุฌุฏ ูุดุงุฑูุน ูุถุงูุฉ ูู ูุฐุง ุงูุนูุฏ.</div>`;
            } else {
                projectNames.forEach(projName => {
                    const items = projectsGrouped[projName];
                    const sortOrder = ['spare_parts', 'labor', 'subcontractors'];
                    items.sort((a, b) => sortOrder.indexOf(a.category) - sortOrder.indexOf(b.category));

                    let itemsRows = "";
                    items.forEach(item => {
                        const cat = getCatDetails(item.category);
                        itemsRows += `
                        <div class="project-item-row">
                            <div style="flex:1.5; display:flex; align-items:center;">
                                <span class="cat-indicator" style="background:${cat.color}"></span>
                                <span style="font-weight:500;">${cat.text}</span>
                            </div>
                            <div style="flex:1; font-size:0.9em; color:#555;">
                                ุงูููุฒุงููุฉ: <b>${fmt(item.totalAllocatedAmount)}</b>
                            </div>
                            <div style="flex:1; font-size:0.9em; color:#555;">
                                ุงููุตุฑูู: <b style="color:var(--danger)">${fmt(item.totalSpent)}</b>
                            </div>
                            <div>
                                <a href="details.html?id=${item.id}" class="btn btn-outline" style="padding:6px 15px; font-size:0.85em; text-decoration:none; border-radius: 6px;">ุงูุชูุงุตูู</a>
                            </div>
                        </div>`;
                    });

                    projectsHTML += `
                    <div class="project-group-card">
                        <div class="project-header">
                            <span><i class="fa-solid fa-layer-group" style="margin-left:8px;"></i> ${projName}</span>
                            <button onclick="deleteProjectGroup('${contract.id}', '${projName}')" class="btn btn-danger" style="padding:5px 12px; font-size:0.8em; display:flex; align-items:center; gap:5px;" title="ุญุฐู ุงููุดุฑูุน ุจุงููุงูู">
                                <i class="fa-solid fa-trash"></i> ุญุฐู ุงููุดุฑูุน
                            </button>
                        </div>
                        <div>${itemsRows}</div>
                    </div>`;
                });
            }

            // --- ููุง ุงูุฅุตูุงุญ ุงูุฃุณุงุณู ููู Header ---
            const contractHTML = `
            <div class="contract-card">
                <div class="contract-header" onclick="toggleContract('${contract.id}')">
                    
                    <div class="contract-info-text">
                        <div class="contract-title">
                            <i class="fa-solid fa-file-contract"></i> ${contract.name}
                        </div>
                        <div style="font-size:0.9em; color:#666; display:flex; gap:15px; flex-wrap:wrap;">
                            <span><i class="fa-solid fa-coins"></i> ุงูุฅุฌูุงูู: <b>${fmt(totalContractBudget)}</b></span>
                            <span><i class="fa-solid fa-building-columns"></i> ุงูุฌูุฉ: ${contract.supervisingAuthority || 'ุบูุฑ ูุญุฏุฏ'}</span>
                        </div>
                    </div>

                    <div class="contract-actions-box" onclick="event.stopPropagation()">
                        <a href="contract-details.html?id=${contract.id}" class="btn-outline" style="padding:6px 12px; text-decoration:none; display:flex; align-items:center; gap:5px; border-radius:6px; font-size:0.9em; background:white;">
                            <i class="fa-solid fa-chart-pie"></i> ุชูุฑูุฑ
                        </a>
                        <button onclick="deleteContract('${contract.id}', '${contract.name}')" class="btn-delete-icon" style="width:36px; height:36px;" title="ุญุฐู ุงูุนูุฏ">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <i id="icon-${contract.id}" class="fa-solid fa-chevron-down" style="margin-right:10px; color:#aaa; font-size:1.1em;"></i>
                    </div>
                </div>

                <div id="body-${contract.id}" class="sites-container" style="padding-top: 15px;">
                    ${projectsHTML}
                    <div style="text-align:center; margin-top:20px;">
                        <button onclick="openAddSiteModal('${contract.id}')" class="btn btn-warning" style="width:100%; padding: 12px; font-size:1em;">
                            <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ ูุดุฑูุน ุฌุฏูุฏ
                        </button>
                    </div>
                </div>
            </div>`;
            
            container.innerHTML += contractHTML;
        });
    }

    // --- ุฏูุงู ุงูุฅุถุงูุฉ ูุงูุญุฐู (ุงูููุทู ุงูุจุฑูุฌู) ---

    function openAddSiteModal(contractId) {
        document.getElementById('targetContractId').value = contractId;
        document.getElementById('siteNameInput').value = "";
        document.getElementById('budgetParts').value = "";
        document.getElementById('budgetLabor').value = "";
        document.getElementById('budgetSubs').value = "";
        document.getElementById('addSiteModal').style.display = 'flex';
    }

    async function addProjectGroup() {
        const contractId = document.getElementById('targetContractId').value;
        const name = document.getElementById('siteNameInput').value;
        const bParts = Number(document.getElementById('budgetParts').value);
        const bLabor = Number(document.getElementById('budgetLabor').value);
        const bSubs = Number(document.getElementById('budgetSubs').value);

        if(!name) return alert("ุงุณู ุงููุดุฑูุน ูุทููุจ");

        const btn = event.target; btn.disabled = true; btn.innerText = "ุฌุงุฑู ุงูุญูุธ...";
        const batch = db.batch();

        createBudgetItem(batch, contractId, name, 'spare_parts', bParts);
        createBudgetItem(batch, contractId, name, 'labor', bLabor);
        createBudgetItem(batch, contractId, name, 'subcontractors', bSubs);

        try {
            await batch.commit();
            document.getElementById('addSiteModal').style.display = 'none';
            alert("โ ุชู ุฅุถุงูุฉ ุงููุดุฑูุน ูุจููุฏู ุงูุซูุงุซุฉ ุจูุฌุงุญ");
        } catch(e) { alert("ุญุฏุซ ุฎุทุฃ: " + e.message); } 
        finally { btn.disabled = false; btn.innerText = "ุญูุธ ุงููุดุฑูุน"; }
    }

    function createBudgetItem(batch, contractId, name, cat, amount) {
        const ref = db.collection('budgets').doc();
        batch.set(ref, {
            contractId: contractId, itemName: name, category: cat,
            totalAllocatedAmount: amount || 0, currentBalance: amount || 0,
            totalSpent: 0, totalProfit: 0, createdAt: new Date()
        });
    }

    function addContract() {
        const name = document.getElementById('newContractName').value;
        const auth = document.getElementById('newContractAuth').value;
        const start = document.getElementById('newContractStart').value;
        const end = document.getElementById('newContractEnd').value;
        if(!name) return alert("ุงูุงุณู ูุทููุจ");
        db.collection("contracts").add({
            name: name, supervisingAuthority: auth, startDate: start, endDate: end, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { document.getElementById('addContractModal').style.display='none'; });
    }

    async function deleteProjectGroup(contractId, projectName) {
        if(!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุดุฑูุน: (${projectName})ุ\nุณูุชู ุญุฐู (ูุทุน ุงูุบูุงุฑุ ุงูุนูุงูุฉุ ุงูููุงูููู) ุงูุฎุงุตุฉ ุจู.`)) return;
        const snap = await db.collection('budgets').where('contractId', '==', contractId).where('itemName', '==', projectName).get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        try { await batch.commit(); alert("ุชู ุญุฐู ุงููุดุฑูุน."); } catch(e) { alert(e.message); }
    }

    async function deleteContract(contractId, name) {
        if(!confirm(`ุชุญุฐูุฑ ุฎุทูุฑ!\nูู ุชุฑูุฏ ุญุฐู ุงูุนูุฏ (${name}) ููู ุงููุดุงุฑูุน ุงูุชุงุจุนุฉ ูู ููุงุฆูุงูุ`)) return;
        const batch = db.batch();
        batch.delete(db.collection('contracts').doc(contractId));
        const snap = await db.collection('budgets').where('contractId', '==', contractId).get();
        snap.forEach(doc => batch.delete(doc.ref));
        try { await batch.commit(); alert("ุชู ุงูุญุฐู ุจูุฌุงุญ."); } catch(e) { alert(e.message); }
    }

    function getCatDetails(cat) {
        if(cat === 'labor') return {text: 'ุนูุงูุฉ', color: '#e67e22'};
        if(cat === 'subcontractors') return {text: 'ููุงููู ุจุงุทู', color: '#6c757d'};
        return {text: 'ูุทุน ุบูุงุฑ', color: '#1a3c6d'};
    }
    
    function toggleContract(id) {
        const el = document.getElementById(`body-${id}`);
        const icon = document.getElementById(`icon-${id}`);
        if(el.style.display === 'block') { el.style.display='none'; icon.classList.replace('fa-chevron-up','fa-chevron-down'); }
        else { el.style.display='block'; el.classList.add('open'); icon.classList.replace('fa-chevron-down','fa-chevron-up'); }
    }
    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG'); }
    function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    
    // ูุณุชุฎุฏููู (ููุณ ุงูููุทู)
    async function openUsersModal() {
        document.getElementById('usersModal').style.display='flex';
        // (ุงูููุฏ ููุง ูุฎุชุตุฑ ููุนุฑุถุ ุงูููุทู ููุฌูุฏ ูู ุงููุณุฎ ุงูุณุงุจูุฉ ููุนูู ุจููุณ ุงูุทุฑููุฉ)
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="4">ุชุญููู...</td></tr>';
        const snaps = await db.collection('users').get();
        tbody.innerHTML = '';
        snaps.forEach(doc => {
            const u = doc.data();
            tbody.innerHTML += `<tr><td>${u.email}</td><td>${u.role}</td><td>-</td><td>-</td></tr>`; 
        });
    }
</script>
</body>
</html>
