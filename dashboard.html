<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฑุฆูุณูุฉ - FGC Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body> 

    <div id="loader">
        <div class="loader-spinner"></div>
        <h3 style="color: var(--primary); margin-top: 20px;">ุฌุงุฑู ุงููุนุงูุฌุฉ...</h3>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span style="font-size: 0.8rem; color: #888;">ููุญุฉ ุงูุชุญูู ูุงููุดุงุฑูุน</span>
            </div>
        </div>
        <button onclick="logout()" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> ุฎุฑูุฌ</button>
    </nav>

    <div class="container">
        
        <div id="adminPanel" class="admin-panel">
            <h3 style="margin-top: 0; color: var(--primary);">๐ ููุญุฉ ุชุญูู ุงููุฏูุฑ</h3>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex: 1;">
                     <button onclick="openUsersModal()" class="btn-users">
                        <i class="fa-solid fa-users-gear"></i> ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช
                    </button>
                </div>
                <div style="flex: 1;">
                    <button onclick="recalculateAllProjects()" class="btn-sync">
                        <i class="fa-solid fa-rotate"></i> ุชุญุฏูุซ ูุชุตุญูุญ ุงูุฃุฑุตุฏุฉ
                    </button>
                </div>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ddd;">

            <div class="input-group">
                <div class="input-box" style="flex: 2;">
                    <label>ุงุณู ุงููุดุฑูุน ุงูุฌุฏูุฏ</label>
                    <input type="text" id="newSiteName" placeholder="ุงุณู ุงููุดุฑูุน...">
                </div>
                <div class="input-box">
                    <label>ุงูููุฒุงููุฉ ุงููุนุชูุฏุฉ</label>
                    <input type="number" id="newSiteBudget" placeholder="500000">
                </div>
                <button onclick="addSite()" class="btn-add">ุฅุถุงูุฉ</button>
            </div>
        </div>

        <h3 style="margin-bottom: 20px;">ุงููุดุงุฑูุน ุงูุฌุงุฑูุฉ</h3>
        <div id="sitesGrid" class="projects-grid">
            <p>ุฌุงุฑู ุงูุชุญููู...</p>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช</h2>
            <p style="color: #666; font-size: 0.9em;">
                ูู ุจุชุบููุฑ ุงูุตูุงุญูุฉ ุฃู ุชุนููู ุงููุดุฑูุน ุซู ุงุถุบุท ุนูู ุฒุฑ "ุญูุธ" ุจุฌุงูุจ ูู ูุณุชุฎุฏู.
                <br>
                <small>* ูุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ: ูุฑุฌู ุงูุทูุจ ููู ุฅูุดุงุก ุญุณุงุจ ุนุจุฑ ุตูุญุฉ ุงูุฏุฎููุ ูุณูุธูุฑ ุงุณูู ููุง ุชููุงุฆูุงู.</small>
            </p>
            
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                            <th>ุงูุตูุงุญูุฉ (Role)</th>
                            <th>ุงููุดุฑูุน ุงููุฎุตุต (Site)</th>
                            <th>ุฅุฌุฑุงุก</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // ... (ููุณ ููุฏ ุงูุฌุงูุงุณูุฑูุจุช ุจุงููุงูู ููุง ููุ ุงูุณุฎู ูู ูููู ุงููุฏูู dashboard.html ูุถุนู ููุง) ...
    // ... (ูู ุฃูู ุจุชุบููุฑ ุงูุฌุงูุงุณูุฑูุจุช ุญูุงุธุงู ุนูู ุงููุณุงุญุฉุ ููุท ุงูู HTML ูุงูู CSS ุชู ุชุญุฏูุซูู) ...
    
    // ูุฑุฌู ูุณุฎ ุงูู Script ุงูููุฌูุฏ ูู ูููู ุงููุฏูู dashboard.html ููุตูู ููุง ูุจู ุฅุบูุงู ุงูู body
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allBudgets = []; 

    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            if(userData.role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                loadAllSites();
                loadBudgetsForDropdown(); 
            } else {
                loadMySite(userData.assignedSiteId);
            }
        }
    });

    function loadBudgetsForDropdown() {
        db.collection('budgets').onSnapshot(snapshot => {
            allBudgets = [];
            snapshot.forEach(doc => {
                allBudgets.push({ id: doc.id, name: doc.data().itemName });
            });
        });
    }

   async function openUsersModal() {
        document.getElementById('usersModal').style.display = 'flex';
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">ุฌุงุฑู ุชุญููู ุงููุณุชุฎุฏููู...</td></tr>';

        try {
            const usersSnap = await db.collection('users').orderBy('createdAt', 'desc').get();
            tbody.innerHTML = '';

            usersSnap.forEach(doc => {
                const u = doc.data();
                const userId = doc.id;
                
                let sitesOptions = `<option value="">-- ุจุฏูู ูุดุฑูุน --</option>`;
                allBudgets.forEach(site => {
                    const selected = u.assignedSiteId === site.id ? 'selected' : '';
                    sitesOptions += `<option value="${site.id}" ${selected}>${site.name}</option>`;
                });

                // ุชุญุฏูุฏ ุงูุฎูุงุฑ ุงููุฎุชุงุฑ ุจูุงุกู ุนูู ุงูุฏูุฑ ุงูุญุงูู
                const r = u.role;
                const selUser = r === 'user' ? 'selected' : '';
                const selAdmin = r === 'admin' ? 'selected' : '';
                const selViewer = r === 'viewer' ? 'selected' : '';
                const selViewerPro = r === 'viewer_pro' ? 'selected' : '';

                const row = `
                <tr>
                    <td>${u.email} <br> <small style="color:#999">${userId.substring(0,5)}...</small></td>
                    <td>
                        <select id="role-${userId}" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; width: 100%;">
                            <option value="user" ${selUser}>ูุณุชุฎุฏู (ุฅุฏุฎุงู ุจูุงูุงุช)</option>
                            <option value="viewer" ${selViewer}>ูุดุงูุฏ ููุท (ุจุฏูู ุฃุฑุจุงุญ)</option>
                            <option value="viewer_pro" ${selViewerPro}>ูุดุงูุฏ (ูุน ุฃุฑุจุงุญ)</option>
                            <option value="admin" ${selAdmin}>ูุฏูุฑ (Admin)</option>
                        </select>
                    </td>
                    <td>
                        <select id="site-${userId}" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; width: 100%;">
                            ${sitesOptions}
                        </select>
                    </td>
                    <td>
                        <button onclick="saveUserChanges('${userId}')" class="save-user-btn">
                            <i class="fa-solid fa-save"></i> ุญูุธ
                        </button>
                    </td>
                </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="4" style="color:red">ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช</td></tr>';
        }
    }
    async function saveUserChanges(userId) {
        const newRole = document.getElementById(`role-${userId}`).value;
        const newSite = document.getElementById(`site-${userId}`).value;
        
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '...';
        btn.disabled = true;

        try {
            await db.collection('users').doc(userId).update({
                role: newRole,
                assignedSiteId: newSite
            });
            alert("ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ุจูุฌุงุญ");
        } catch (e) {
            alert("ุฎุทุฃ: " + e.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function loadAllSites() {
        db.collection("budgets").orderBy("createdAt", "desc").onSnapshot(snap => renderSites(snap.docs));
    }

    function loadMySite(siteId) {
        if(!siteId) return document.getElementById('sitesGrid').innerHTML = "<p>ูู ูุชู ุชุนููู ูุดุฑูุน ูู.</p>";
        db.collection("budgets").doc(siteId).onSnapshot(doc => {
            if(doc.exists) renderSites([doc]);
            else document.getElementById('sitesGrid').innerHTML = "<p>ุงููุดุฑูุน ุบูุฑ ููุฌูุฏ.</p>";
        });
    }

    function renderSites(docs) {
        const container = document.getElementById('sitesGrid');
        container.innerHTML = "";
        if(docs.length === 0) return container.innerHTML = "<p>ูุง ุชูุฌุฏ ูุดุงุฑูุน.</p>";

        docs.forEach(doc => {
            const d = doc.data();
            const percent = d.totalAllocatedAmount ? (d.currentBalance / d.totalAllocatedAmount) * 100 : 0;
            const balanceColor = percent < 20 ? 'var(--danger)' : 'var(--success)';
            const profit = d.totalProfit || 0;
            const spent = d.totalSpent || 0;

            const html = `
            <div class="project-card">
                <div class="card-header">
                    <h3>${d.itemName}</h3>
                    <div class="icon-box"><i class="fa-solid fa-building"></i></div>
                </div>
                <div class="card-body">
                    <div class="stat-row">
                        <div class="stat-item"><label>ุงูููุฒุงููุฉ</label><br><b>${fmt(d.totalAllocatedAmount)}</b></div>
                        <div class="stat-item"><label>ุงููุตุฑูู</label><br><b style="color:var(--danger)">${fmt(spent)}</b></div>
                    </div>
                    <div class="profit-badge"><label>ูุจูุบ ุงูุชูููู</label><br><b>${fmt(profit)} ุฑูุงู</b></div>
                    <div style="text-align: center;"><span style="color:#888; font-size:0.9em">ุงููุชุจูู</span><div style="font-size:1.8em; font-weight:800; color:${balanceColor}">${fmt(d.currentBalance)}</div></div>
                </div>
                <div class="card-footer"><a href="details.html?id=${doc.id}" class="btn-view">ุงูุชูุงุตูู ูุงูุนูููุงุช</a></div>
            </div>`;
            container.innerHTML += html;
        });
    }

    function addSite() {
        const name = document.getElementById('newSiteName').value;
        const budget = Number(document.getElementById('newSiteBudget').value);
        if(!name || !budget) return alert("ุงูุจูุงูุงุช ูุงูุตุฉ");
        db.collection("budgets").add({
            itemName: name, totalAllocatedAmount: budget, currentBalance: budget, totalSpent: 0, totalProfit: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { alert("ุชู"); document.getElementById('newSiteName').value=""; document.getElementById('newSiteBudget').value=""; });
    }

    async function recalculateAllProjects() {
        if(!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงูุฃุฑุตุฏุฉุ")) return;
        document.getElementById('loader').style.display = 'flex';
        try {
            const budgets = await db.collection('budgets').get();
            const promises = budgets.docs.map(async b => {
                const trans = await b.ref.collection('transactions').get();
                let p = 0, s = 0;
                trans.forEach(t => { s += Number(t.data().amountExclTax)||0; p += Number(t.data().companyProfit)||0; });
                return b.ref.update({ totalSpent: s, totalProfit: p, currentBalance: (b.data().totalAllocatedAmount||0) - s });
            });
            await Promise.all(promises);
            alert("ุชู ุงูุชุญุฏูุซ!");
        } catch(e) { alert("ุฎุทุฃ: " + e.message); } 
        finally { document.getElementById('loader').style.display = 'none'; }
    }

    function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits: 2}); }
</script>
</body>
</html>
