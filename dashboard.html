<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة العقود والمواقع - FGC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <h3 style="color: var(--primary); margin-top: 20px;">جاري التحميل...</h3>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span style="font-size: 0.8rem; color: #888;">نظام إدارة العقود الموحد</span>
            </div>
        </div>
        <button onclick="logoutWithEffect()" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> خروج</button>
    </nav>

    <div class="container">
        
        <div class="dashboard-stats">
            <div class="stat-box" style="border-bottom-color: var(--primary);">
                <div class="stat-icon" style="background: var(--primary);"><i class="fa-solid fa-file-contract"></i></div>
                <div><h3 style="margin:0" id="totalContracts">0</h3><small>عقود نشطة</small></div>
            </div>
            <div class="stat-box" style="border-bottom-color: var(--accent);">
                <div class="stat-icon" style="background: var(--accent);"><i class="fa-solid fa-coins"></i></div>
                <div><h3 style="margin:0" id="totalValueDisplay">0</h3><small>إجمالي الميزانيات</small></div>
            </div>
        </div>

        <div id="adminPanel" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 15px;">
                <button onclick="document.getElementById('addContractModal').style.display='flex'" class="btn btn-primary" style="flex: 1; padding: 15px;">
                    <i class="fa-solid fa-plus-circle"></i> إضافة عقد جديد
                </button>
                <button onclick="openUsersModal()" class="btn btn-outline" style="flex: 0.5;">
                    <i class="fa-solid fa-users-gear"></i> المستخدمين
                </button>
            </div>
        </div>

        <h3 style="border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px; margin-bottom: 20px;">
            <i class="fa-solid fa-folder-tree"></i> سجل العقود والمشاريع
        </h3>
        
        <div id="contractsGrid">
            </div>
    </div>

    <div id="addContractModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('addContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">إضافة عقد جديد</h2>
            <div class="input-group">
                <div class="input-box">
                    <label>اسم العقد (المنطقة/المشروع الرئيسي)</label>
                    <input type="text" id="newContractName" placeholder="مثال: عقد منطقة الرياض">
                </div>
                <div class="input-box">
                    <label>الجهة المشرفة</label>
                    <input type="text" id="newContractAuth" placeholder="مثال: وزارة الصحة">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-box" style="flex:1;"><label>تاريخ البداية</label><input type="date" id="newContractStart"></div>
                    <div class="input-box" style="flex:1;"><label>تاريخ النهاية</label><input type="date" id="newContractEnd"></div>
                </div>
                <button onclick="addContract()" class="btn-add">حفظ وإنشاء العقد</button>
            </div>
        </div>
    </div>

    <div id="addSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 650px;">
            <span class="close-modal" onclick="document.getElementById('addSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">إضافة موقع جديد للعقد</h2>
            <p style="color:#666; font-size:0.9em; margin-bottom:15px;">سيتم إنشاء 3 بنود تلقائياً لهذا الموقع (قطع غيار، عمالة، مقاولين).</p>
            
            <input type="hidden" id="targetContractId">
            
            <div class="input-group">
                <div class="input-box">
                    <label>اسم الموقع (المستشفى/المركز)</label>
                    <input type="text" id="siteNameInput" placeholder="مثال: مستشفى الملك فهد">
                </div>
                
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px dashed #ddd;">
                    <h4 style="margin: 0 0 10px 0; color: var(--accent-orange);">توزيع الميزانية:</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div class="input-box">
                            <label><i class="fa-solid fa-cogs"></i> قطع غيار</label>
                            <input type="number" id="budgetParts" placeholder="0">
                        </div>
                        <div class="input-box">
                            <label><i class="fa-solid fa-hard-hat"></i> عمالة</label>
                            <input type="number" id="budgetLabor" placeholder="0">
                        </div>
                        <div class="input-box">
                            <label><i class="fa-solid fa-handshake"></i> مقاولين</label>
                            <input type="number" id="budgetSubs" placeholder="0">
                        </div>
                    </div>
                </div>

                <button onclick="addProjectItems()" class="btn-add">حفظ الموقع والبنود</button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">إدارة المستخدمين</h2>
            <div class="table-container">
                <table class="users-table">
                    <thead><tr><th>البريد</th><th>الصلاحية</th><th>الموقع المخصص</th><th>حفظ</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // --- إعدادات فايربيس ---
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allContracts = [];
    let allSites = [];

    // --- التحقق من المستخدم ---
    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists && userDoc.data().role === 'admin') {
            document.getElementById('loader').style.display = 'none';
            loadData(); 
        } else {
             // لو مستخدم عادي حوله لصفحته
             if(userDoc.exists && userDoc.data().assignedSiteId) window.location.href = "details.html?id=" + userDoc.data().assignedSiteId;
             else alert("ليس لديك صلاحية.");
        }
    });

    // --- تحميل البيانات ---
    function loadData() {
        db.collection("contracts").orderBy("createdAt", "desc").onSnapshot(contractSnap => {
            allContracts = [];
            contractSnap.forEach(doc => allContracts.push({ id: doc.id, ...doc.data() }));
            
            db.collection("budgets").onSnapshot(siteSnap => {
                allSites = [];
                siteSnap.forEach(doc => allSites.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        });
    }

    // --- رسم الداشبورد ---
    function renderDashboard() {
        const container = document.getElementById('contractsGrid');
        container.innerHTML = "";
        
        let totalVal = 0;
        
        // تحديث الإحصائيات العلوية
        document.getElementById('totalContracts').innerText = allContracts.length;

        allContracts.forEach(contract => {
            // تصفية المواقع التابعة للعقد
            const contractSites = allSites.filter(site => site.contractId === contract.id);
            
            // حساب إجمالي العقد
            const contractTotal = contractSites.reduce((sum, s) => sum + (s.totalAllocatedAmount || 0), 0);
            const contractSpent = contractSites.reduce((sum, s) => sum + (s.totalSpent || 0), 0);
            totalVal += contractTotal;

            // توليد HTML العقد
            let sitesHTML = "";
            if (contractSites.length === 0) {
                sitesHTML = `<div style="text-align:center; padding:20px; color:#999;">لا توجد مواقع مضافة. ابدأ بإضافة موقع.</div>`;
            } else {
                contractSites.forEach(site => {
                    const catInfo = getCatInfo(site.category);
                    sitesHTML += `
                    <div class="site-mini-card">
                        <div style="flex:1;">
                            <div style="font-weight:bold; margin-bottom:5px;">
                                ${site.itemName} <span class="category-badge ${catInfo.class}">${catInfo.text}</span>
                            </div>
                            <div style="font-size:0.85em; color:#666;">
                                الميزانية: ${fmt(site.totalAllocatedAmount)} | المصروف: <span style="color:var(--danger)">${fmt(site.totalSpent)}</span>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <a href="details.html?id=${site.id}" class="btn-outline" style="padding:5px 10px; border-radius:5px; text-decoration:none; font-size:0.8em;">التفاصيل</a>
                            <button onclick="deleteBudget('${site.id}', '${site.itemName}')" class="btn-delete-icon" title="حذف البند"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                });
            }

            const html = `
            <div class="contract-card">
                <div class="contract-header" onclick="toggleSites('${contract.id}')">
                    <div style="flex:1;">
                        <div class="contract-title">
                            <i class="fa-solid fa-file-contract"></i> ${contract.name}
                        </div>
                        <div style="font-size:0.9em; color:#555; margin-top:5px;">
                            <span style="margin-left:15px;"><i class="fa-solid fa-building-columns"></i> ${contract.supervisingAuthority || '-'}</span>
                            <span><i class="fa-solid fa-coins"></i> الإجمالي: ${fmt(contractTotal)}</span>
                        </div>
                    </div>
                    <div class="contract-actions" onclick="event.stopPropagation()">
                        <a href="contract-details.html?id=${contract.id}" class="btn-outline" style="padding:5px 10px; border-radius:5px; text-decoration:none; display:flex; align-items:center; gap:5px;">
                            <i class="fa-solid fa-chart-pie"></i> تحليل
                        </a>
                        <button onclick="deleteContract('${contract.id}', '${contract.name}')" class="btn-delete-icon" style="width:35px; height:35px;" title="حذف العقد بالكامل">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <i id="icon-${contract.id}" class="fa-solid fa-chevron-down" style="margin-right:10px; color:#aaa;"></i>
                    </div>
                </div>
                <div id="sites-${contract.id}" class="sites-container">
                    ${sitesHTML}
                    <div style="text-align:center; margin-top:15px;">
                        <button onclick="openAddSiteModal('${contract.id}')" class="btn btn-warning" style="width:100%;">
                            <i class="fa-solid fa-map-location-dot"></i> إضافة موقع جديد (3 بنود)
                        </button>
                    </div>
                </div>
            </div>`;
            container.innerHTML += html;
        });

        document.getElementById('totalValueDisplay').innerText = fmt(totalVal);
    }

    // --- Helpers ---
    function getCatInfo(cat) {
        if(cat === 'labor') return {text: 'عمالة', class: 'cat-labor'};
        if(cat === 'subcontractors') return {text: 'مقاولي باطن', class: 'cat-subcontractors'};
        return {text: 'قطع غيار', class: 'cat-spare_parts'};
    }
    function toggleSites(id) {
        const el = document.getElementById(`sites-${id}`);
        const icon = document.getElementById(`icon-${id}`);
        if(el.style.display === 'block') {
            el.style.display = 'none';
            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        } else {
            el.style.display = 'block';
            el.classList.add('open');
            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        }
    }
    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG'); }

    // --- إضافة عقد ---
    function addContract() {
        const name = document.getElementById('newContractName').value;
        const authName = document.getElementById('newContractAuth').value;
        const start = document.getElementById('newContractStart').value;
        const end = document.getElementById('newContractEnd').value;
        
        if(!name) return alert("اسم العقد مطلوب");
        
        const btn = event.target; btn.innerText = "..."; btn.disabled = true;

        db.collection("contracts").add({
            name: name, supervisingAuthority: authName, startDate: start, endDate: end,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById('addContractModal').style.display='none';
            document.getElementById('newContractName').value="";
            alert("تم إنشاء العقد");
            btn.innerText = "حفظ"; btn.disabled = false;
        });
    }

    // --- إضافة موقع (3 بنود دفعة واحدة) ---
    function openAddSiteModal(contractId) {
        document.getElementById('targetContractId').value = contractId;
        document.getElementById('siteNameInput').value = "";
        document.getElementById('budgetParts').value = "";
        document.getElementById('budgetLabor').value = "";
        document.getElementById('budgetSubs').value = "";
        document.getElementById('addSiteModal').style.display = 'flex';
    }

    async function addProjectItems() {
        const contractId = document.getElementById('targetContractId').value;
        const siteName = document.getElementById('siteNameInput').value;
        const bParts = Number(document.getElementById('budgetParts').value) || 0;
        const bLabor = Number(document.getElementById('budgetLabor').value) || 0;
        const bSubs = Number(document.getElementById('budgetSubs').value) || 0;

        if(!siteName) return alert("يرجى كتابة اسم الموقع");

        const btn = event.target; 
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> جاري الإنشاء...'; 
        btn.disabled = true;

        const batch = db.batch();
        
        // 1. قطع غيار
        const ref1 = db.collection("budgets").doc();
        batch.set(ref1, {
            contractId, itemName: siteName, category: 'spare_parts',
            totalAllocatedAmount: bParts, currentBalance: bParts, totalSpent: 0, totalProfit: 0, createdAt: new Date()
        });

        // 2. عمالة
        const ref2 = db.collection("budgets").doc();
        batch.set(ref2, {
            contractId, itemName: siteName, category: 'labor',
            totalAllocatedAmount: bLabor, currentBalance: bLabor, totalSpent: 0, totalProfit: 0, createdAt: new Date()
        });

        // 3. مقاولي باطن
        const ref3 = db.collection("budgets").doc();
        batch.set(ref3, {
            contractId, itemName: siteName, category: 'subcontractors',
            totalAllocatedAmount: bSubs, currentBalance: bSubs, totalSpent: 0, totalProfit: 0, createdAt: new Date()
        });

        try {
            await batch.commit();
            document.getElementById('addSiteModal').style.display='none';
            alert("تم إضافة الموقع وبنوده الثلاثة بنجاح ✅");
        } catch(e) {
            alert("حدث خطأ: " + e.message);
        } finally {
            btn.innerText = "حفظ الموقع والبنود"; btn.disabled = false;
        }
    }

    // --- حذف عقد بالكامل ---
    async function deleteContract(id, name) {
        if(!confirm(`هل أنت متأكد من حذف العقد: (${name})؟\n⚠️ تحذير: سيتم حذف جميع المواقع والبيانات المالية التابعة له نهائياً!`)) return;

        const btn = event.target.closest('button'); 
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

        try {
            // 1. حذف كل البنود المرتبطة بالعقد
            const snapshot = await db.collection('budgets').where('contractId', '==', id).get();
            const batch = db.batch();
            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();

            // 2. حذف وثيقة العقد نفسها
            await db.collection('contracts').doc(id).delete();
            alert("تم حذف العقد وجميع محتوياته.");
        } catch(e) {
            alert("خطأ أثناء الحذف: " + e.message);
            btn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
        }
    }

    // --- حذف بند واحد ---
    async function deleteBudget(id, name) {
        if(!confirm(`حذف البند: ${name}؟ \nلا يمكن التراجع عن هذا الإجراء.`)) return;
        try {
            await db.collection('budgets').doc(id).delete();
            // ملاحظة: الحركات الفرعية في فايربيس لا تحذف تلقائياً لكن لن تظهر في الواجهة
        } catch(e) {
            alert("خطأ: " + e.message);
        }
    }

    // --- المستخدمين (نفس المنطق السابق مع تحسين الشكل) ---
    async function openUsersModal() {
        document.getElementById('usersModal').style.display = 'flex';
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">تحميل...</td></tr>';
        
        const usersSnap = await db.collection('users').get();
        tbody.innerHTML = '';
        usersSnap.forEach(doc => {
            const u = doc.data();
            // ... (نفس كود بناء جدول المستخدمين السابق لعدم الإطالة، أو يمكن نسخه من الملف القديم) ...
            // عشان الكود ما يطولش زيادة، المنطق هنا نفس القديم بالظبط بس الستايل في CSS اتحسن
            // لو محتاج الكود بالتفصيل هنا قولي.
             let sitesOptions = `<option value="">-- بدون موقع --</option>`;
                allContracts.forEach(contract => {
                    const contractSites = allSites.filter(s => s.contractId === contract.id);
                    if(contractSites.length > 0) {
                        sitesOptions += `<optgroup label="${contract.name}">`;
                        contractSites.forEach(site => {
                            const selected = u.assignedSiteId === site.id ? 'selected' : '';
                            const cat = getCatInfo(site.category).text;
                            sitesOptions += `<option value="${site.id}" ${selected}>${site.itemName} (${cat})</option>`;
                        });
                        sitesOptions += `</optgroup>`;
                    }
                });
                
                tbody.innerHTML += `
                <tr>
                    <td>${u.email}</td>
                    <td>
                        <select id="role-${doc.id}" style="padding:5px;">
                            <option value="user" ${u.role==='user'?'selected':''}>موظف إدخال</option>
                            <option value="admin" ${u.role==='admin'?'selected':''}>مدير عام</option>
                            <option value="viewer" ${u.role==='viewer'?'selected':''}>مشاهد</option>
                        </select>
                    </td>
                    <td><select id="site-${doc.id}" style="width:100%">${sitesOptions}</select></td>
                    <td><button onclick="saveUser('${doc.id}')" class="save-user-btn">حفظ</button></td>
                </tr>`;
        });
    }

    async function saveUser(uid) {
        const r = document.getElementById(`role-${uid}`).value;
        const s = document.getElementById(`site-${uid}`).value;
        await db.collection('users').doc(uid).update({role: r, assignedSiteId: s});
        alert("تم الحفظ");
    }

    function logoutWithEffect() {
        document.body.style.opacity = '0'; // تأثير الخروج
        setTimeout(() => {
            auth.signOut().then(() => window.location.href = "index.html");
        }, 500);
    }
</script>
</body>
</html>
