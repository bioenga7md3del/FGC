<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ - FGC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        .contract-card {
            background: white; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden;
            border: 1px solid #eee; transition: 0.3s;
        }
        .contract-header {
            background: linear-gradient(to left, #f8f9fa, #fff);
            padding: 20px; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 3px solid var(--primary);
        }
        .contract-header:hover { background: #f1f3f5; }
        .contract-title { font-size: 1.3rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .contract-meta { font-size: 0.9rem; color: #777; }
        
        .sites-container {
            padding: 20px; background: #fafafa; display: none;
            border-top: 1px solid #ddd;
        }
        .sites-container.open { display: block; animation: slideDown 0.3s ease-out; }
        
        .site-mini-card {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; transition: 0.2s;
        }
        .site-mini-card:hover { transform: translateX(-5px); border-color: var(--accent); }
        .site-info h4 { margin: 0 0 5px 0; color: var(--text-dark); }
        .site-stats { font-size: 0.85rem; color: #666; display: flex; gap: 15px; }
        .site-balance { font-weight: bold; }
        
        .empty-sites { text-align: center; color: #999; padding: 20px; font-style: italic; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµØºÙŠØ± */
        .btn-edit-sm {
            background: white; border: 1px solid #ccc; color: #555;
            padding: 5px 10px; border-radius: 5px; cursor: pointer;
            font-size: 0.8em; margin-left: 5px; transition: 0.2s;
        }
        .btn-edit-sm:hover { border-color: var(--primary); color: var(--primary); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <h3 style="color: var(--primary); margin-top: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h3>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span style="font-size: 0.8rem; color: #888;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹</span>
            </div>
        </div>
        <button onclick="logout()" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</button>
    </nav>

    <div class="container">
        
        <div id="adminPanel" class="admin-panel">
            <h3 style="margin-top: 0; color: var(--primary);">ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                <div style="flex: 1;">
                     <button onclick="openUsersModal()" class="btn-users">
                        <i class="fa-solid fa-users-gear"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    </button>
                </div>
                <div style="flex: 1;">
                    <button onclick="recalculateAllProjects()" class="btn-sync">
                        <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø©
                    </button>
                </div>
            </div>
            
            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="document.getElementById('addContractModal').style.display='flex'" class="btn btn-primary" style="flex: 1; padding: 15px;">
                    <i class="fa-solid fa-file-contract" style="font-size: 1.2rem;"></i><br> Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯
                </button>
                <button onclick="openAddSiteModal()" class="btn btn-warning" style="flex: 1; padding: 15px; color: white;">
                    <i class="fa-solid fa-map-location-dot" style="font-size: 1.2rem;"></i><br> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ù„Ø¹Ù‚Ø¯
                </button>
            </div>
        </div>

        <h3 style="margin-bottom: 20px; color: var(--text-dark); border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px;">
            <i class="fa-solid fa-folder-tree"></i> Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
        </h3>
        
        <div id="contractsGrid">
            <p style="text-align:center; color:#888;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯...</p>
        </div>
    </div>

    <div id="addContractModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="document.getElementById('addContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯ (Ù…Ø«Ø§Ù„: Ø¹Ù‚Ø¯ Ù…Ù†Ø·Ù‚Ø© ØªØ¨ÙˆÙƒ)</label>
                    <input type="text" id="newContractName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯...">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø¹Ù‚Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="number" id="newContractValue" placeholder="0">
                </div>
                <button onclick="addContract()" class="btn-add" style="margin-top: 10px; width: 100%;">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</button>
            </div>
        </div>
    </div>

    <div id="addSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="document.getElementById('addSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡</label>
                    <select id="contractSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                </div>
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø«Ø§Ù„: Ù…Ø³ØªØ´ÙÙ‰ Ø¶Ø¨Ø§Ø¡)</label>
                    <input type="text" id="newSiteName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹...">
                </div>
                <div class="input-box">
                    <label>Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØµØµØ©</label>
                    <input type="number" id="newSiteBudget" placeholder="0">
                </div>
                <button onclick="addSite()" class="btn-add" style="margin-top: 10px; width: 100%;">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
            </div>
        </div>
    </div>

    <div id="editSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="document.getElementById('editSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ØªØ¹Ø¯ÙŠÙ„ ÙˆØ±Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
            <input type="hidden" id="editSiteId">
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label>Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡</label>
                    <select id="editSiteContractSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fffbe6;">
                        </select>
                </div>
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                    <input type="text" id="editSiteName">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</label>
                    <input type="number" id="editSiteBudget">
                </div>
                <button onclick="updateSite()" class="btn-add" style="margin-top: 10px; width: 100%;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                            <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØµØµ</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allContracts = [];
    let allSites = [];

    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            if(userData.role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                loadData(); 
            } else {
                if(userData.assignedSiteId) window.location.href = "details.html?id=" + userData.assignedSiteId;
                else document.getElementById('contractsGrid').innerHTML = "<p style='text-align:center'>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„.</p>";
            }
        }
    });

    function loadData() {
        db.collection("contracts").orderBy("createdAt", "desc").onSnapshot(contractSnap => {
            allContracts = [];
            contractSnap.forEach(doc => allContracts.push({ id: doc.id, ...doc.data() }));
            
            db.collection("budgets").onSnapshot(siteSnap => {
                allSites = [];
                siteSnap.forEach(doc => allSites.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        });
    }

    function renderDashboard() {
        const container = document.getElementById('contractsGrid');
        container.innerHTML = "";

        if (allContracts.length === 0 && allSites.length > 0) {
            renderContractCard({ id: 'legacy', name: 'Ø¹Ù‚ÙˆØ¯ Ø£Ø®Ø±Ù‰ / ØºÙŠØ± Ù…ØµÙ†ÙØ©', totalValue: 0 }, allSites, container);
            return;
        }

        if (allContracts.length === 0) {
            container.innerHTML = "<p style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯.</p>";
            return;
        }

        allContracts.forEach(contract => {
            const contractSites = allSites.filter(site => site.contractId === contract.id);
            renderContractCard(contract, contractSites, container);
        });

        const orphanSites = allSites.filter(site => !site.contractId);
        if (orphanSites.length > 0) {
            renderContractCard({ id: 'orphans', name: 'Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù‚Ø¯ (ÙŠØ¬Ø¨ Ø±Ø¨Ø·Ù‡Ø§)', totalValue: 0 }, orphanSites, container, true);
        }
    }

    function renderContractCard(contract, sites, container, isOrphan = false) {
        const allocatedTotal = sites.reduce((sum, s) => sum + (s.totalAllocatedAmount || 0), 0);
        const spentTotal = sites.reduce((sum, s) => sum + (s.totalSpent || 0), 0);
        
        let sitesHTML = "";
        if (sites.length === 0) {
            sitesHTML = `<div class="empty-sites">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ø¯.</div>`;
        } else {
            sites.forEach(site => {
                const percent = site.totalAllocatedAmount ? (site.currentBalance / site.totalAllocatedAmount) * 100 : 0;
                const balanceColor = percent < 20 ? 'var(--danger)' : 'var(--success)';
                
                sitesHTML += `
                <div class="site-mini-card">
                    <div class="site-info">
                        <h4><i class="fa-solid fa-location-dot" style="color:var(--accent); margin-left:5px;"></i> ${site.itemName}</h4>
                        <div class="site-stats">
                            <span>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${fmt(site.totalAllocatedAmount)}</span>
                            <span>Ø§Ù„Ù…ØµØ±ÙˆÙ: <span style="color:var(--danger)">${fmt(site.totalSpent)}</span></span>
                        </div>
                    </div>
                    <div style="text-align:left">
                        <div class="site-balance" style="color:${balanceColor}">${fmt(site.currentBalance)}</div>
                        <div style="margin-top:5px;">
                            <a href="details.html?id=${site.id}" class="btn btn-outline" style="font-size:0.8em; padding:5px 10px; display:inline-block;">Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                            <button onclick="openEditSiteModal('${site.id}')" class="btn-edit-sm" title="ØªØ¹Ø¯ÙŠÙ„ ÙˆØ±Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯">
                                <i class="fa-solid fa-pen-to-square"></i> ØªØ¹Ø¯ÙŠÙ„
                            </button>
                        </div>
                    </div>
                </div>
                `;
            });
        }

        const headerStyle = isOrphan ? 'background: #fff0f0; border-bottom-color: var(--danger);' : '';
        const titleStyle = isOrphan ? 'color: var(--danger);' : '';

        const html = `
        <div class="contract-card">
            <div class="contract-header" onclick="toggleSites('${contract.id}')" style="${headerStyle}">
                <div class="contract-title" style="${titleStyle}">
                    <i class="fa-solid ${isOrphan ? 'fa-triangle-exclamation' : 'fa-file-signature'}"></i>
                    <div>
                        ${contract.name}
                        <div class="contract-meta">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹: ${sites.length} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ: ${fmt(spentTotal)}</div>
                    </div>
                </div>
                <div>
                    <i id="icon-${contract.id}" class="fa-solid fa-chevron-down" style="color:#aaa;"></i>
                </div>
            </div>
            <div id="sites-${contract.id}" class="sites-container" style="${isOrphan ? 'display:block;' : ''}">
                ${sitesHTML}
                ${!isOrphan ? `<div style="text-align:center; margin-top:10px;">
                    <button onclick="openAddSiteModal('${contract.id}')" class="btn btn-warning" style="font-size:0.9em;">
                        <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯
                    </button>
                </div>` : ''}
            </div>
        </div>
        `;
        container.innerHTML += html;
    }

    function toggleSites(id) {
        const el = document.getElementById(`sites-${id}`);
        const icon = document.getElementById(`icon-${id}`);
        if (el.style.display === 'block') {
            el.style.display = 'none';
            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            el.classList.remove('open');
        } else {
            el.style.display = 'block';
            el.classList.add('open');
            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        }
    }

    function addContract() {
        const name = document.getElementById('newContractName').value;
        const value = Number(document.getElementById('newContractValue').value);
        if(!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯");

        const btn = event.target;
        btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;

        db.collection("contracts").add({
            name: name, totalValue: value, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById('addContractModal').style.display='none';
            document.getElementById('newContractName').value="";
            btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯"; btn.disabled = false;
        });
    }

    function openAddSiteModal(preSelectedContractId = null) {
        const select = document.getElementById('contractSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ --</option>';
        allContracts.forEach(c => {
            const sel = preSelectedContractId === c.id ? 'selected' : '';
            select.innerHTML += `<option value="${c.id}" ${sel}>${c.name}</option>`;
        });
        document.getElementById('addSiteModal').style.display = 'flex';
    }

    function addSite() {
        const contractId = document.getElementById('contractSelect').value;
        const name = document.getElementById('newSiteName').value;
        const budget = Number(document.getElementById('newSiteBudget').value);
        if(!contractId || !name || !budget) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

        const btn = event.target;
        btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;

        db.collection("budgets").add({
            contractId: contractId, itemName: name, totalAllocatedAmount: budget, currentBalance: budget, totalSpent: 0, totalProfit: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById('addSiteModal').style.display='none';
            document.getElementById('newSiteName').value=""; document.getElementById('newSiteBudget').value="";
            btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹"; btn.disabled = false;
        });
    }

    // --- Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
    function openEditSiteModal(siteId) {
        const site = allSites.find(s => s.id === siteId);
        if(!site) return;

        document.getElementById('editSiteId').value = siteId;
        document.getElementById('editSiteName').value = site.itemName;
        document.getElementById('editSiteBudget').value = site.totalAllocatedAmount;

        // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const select = document.getElementById('editSiteContractSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ --</option>';
        allContracts.forEach(c => {
            const selected = site.contractId === c.id ? 'selected' : '';
            select.innerHTML += `<option value="${c.id}" ${selected}>${c.name}</option>`;
        });

        document.getElementById('editSiteModal').style.display = 'flex';
    }

    // --- Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
    async function updateSite() {
        const siteId = document.getElementById('editSiteId').value;
        const contractId = document.getElementById('editSiteContractSelect').value;
        const name = document.getElementById('editSiteName').value;
        const budget = Number(document.getElementById('editSiteBudget').value);

        if(!siteId || !contractId || !name) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

        const btn = event.target;
        btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;

        try {
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await db.collection('budgets').doc(siteId).update({
                contractId: contractId,
                itemName: name,
                totalAllocatedAmount: budget
            });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById('editSiteModal').style.display = 'none';
        } catch (e) {
            alert("Ø®Ø·Ø£: " + e.message);
        } finally {
            btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"; btn.disabled = false;
        }
    }

    async function openUsersModal() {
        document.getElementById('usersModal').style.display = 'flex';
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

        try {
            const usersSnap = await db.collection('users').orderBy('createdAt', 'desc').get();
            tbody.innerHTML = '';
            usersSnap.forEach(doc => {
                const u = doc.data();
                const userId = doc.id;
                
                let sitesOptions = `<option value="">-- Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹ --</option>`;
                allContracts.forEach(contract => {
                    const contractSites = allSites.filter(s => s.contractId === contract.id);
                    if(contractSites.length > 0) {
                        sitesOptions += `<optgroup label="${contract.name}">`;
                        contractSites.forEach(site => {
                            const selected = u.assignedSiteId === site.id ? 'selected' : '';
                            sitesOptions += `<option value="${site.id}" ${selected}>${site.itemName}</option>`;
                        });
                        sitesOptions += `</optgroup>`;
                    }
                });
                
                const orphans = allSites.filter(s => !s.contractId);
                if(orphans.length > 0) {
                     sitesOptions += `<optgroup label="Ø£Ø®Ø±Ù‰">`;
                     orphans.forEach(site => {
                        const selected = u.assignedSiteId === site.id ? 'selected' : '';
                        sitesOptions += `<option value="${site.id}" ${selected}>${site.itemName}</option>`;
                     });
                     sitesOptions += `</optgroup>`;
                }

                const r = u.role;
                const selUser = r === 'user' ? 'selected' : '';
                const selAdmin = r === 'admin' ? 'selected' : '';
                const selViewer = r === 'viewer' ? 'selected' : '';
                const selViewerPro = r === 'viewer_pro' ? 'selected' : '';

                const row = `
                <tr>
                    <td>${u.email} <br> <small style="color:#999">${userId.substring(0,5)}...</small></td>
                    <td>
                        <select id="role-${userId}" style="padding: 8px; width: 100%;">
                            <option value="user" ${selUser}>Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø¯Ø®Ø§Ù„)</option>
                            <option value="viewer" ${selViewer}>Ù…Ø´Ø§Ù‡Ø¯ ÙÙ‚Ø·</option>
                            <option value="viewer_pro" ${selViewerPro}>Ù…Ø´Ø§Ù‡Ø¯ + Ø£Ø±Ø¨Ø§Ø­</option>
                            <option value="admin" ${selAdmin}>Ù…Ø¯ÙŠØ± (Admin)</option>
                        </select>
                    </td>
                    <td><select id="site-${userId}" style="padding: 8px; width: 100%;">${sitesOptions}</select></td>
                    <td><button onclick="saveUserChanges('${userId}')" class="save-user-btn">Ø­ÙØ¸</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        } catch (e) { console.error(e); }
    }

    async function saveUserChanges(userId) {
        const newRole = document.getElementById(`role-${userId}`).value;
        const newSite = document.getElementById(`site-${userId}`).value;
        const btn = event.target;
        btn.innerText = "..."; btn.disabled = true;
        try {
            await db.collection('users').doc(userId).update({ role: newRole, assignedSiteId: newSite });
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
        } catch (e) { alert("Ø®Ø·Ø£: " + e.message); } 
        finally { btn.innerText = "Ø­ÙØ¸"; btn.disabled = false; }
    }

    async function recalculateAllProjects() {
        if(!confirm("Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø©ØŸ")) return;
        document.getElementById('loader').style.display = 'flex';
        try {
            const bs = await db.collection('budgets').get();
            const promises = bs.docs.map(async b => {
                const trans = await b.ref.collection('transactions').get();
                let p = 0, s = 0;
                trans.forEach(t => { s += Number(t.data().amountExclTax)||0; p += Number(t.data().companyProfit)||0; });
                return b.ref.update({ totalSpent: s, totalProfit: p, currentBalance: (b.data().totalAllocatedAmount||0) - s });
            });
            await Promise.all(promises);
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!");
        } catch(e) { alert(e.message); } 
        finally { document.getElementById('loader').style.display = 'none'; }
    }

    function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits: 2}); }
</script>
</body>
</html>
