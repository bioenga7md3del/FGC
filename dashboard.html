<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ - FGC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        .contract-card {
            background: white; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden;
            border: 1px solid #eee; transition: 0.3s;
        }
        .contract-header {
            background: linear-gradient(to left, #f8f9fa, #fff);
            padding: 20px; cursor: pointer; display: flex;
            justify-content: space-between; align-items: flex-start;
            border-bottom: 3px solid var(--primary);
        }
        .contract-header:hover { background: #f1f3f5; }
        .contract-info-block { flex: 1; }
        .contract-title { font-size: 1.3rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 8px;}
        .contract-details { font-size: 0.9rem; color: #555; display: flex; flex-wrap: wrap; gap: 15px; }
        .contract-details span { background: #eef2f7; padding: 4px 8px; border-radius: 4px; border: 1px solid #dee2e6; }
        
        .sites-container {
            padding: 20px; background: #fafafa; display: none;
            border-top: 1px solid #ddd;
        }
        .sites-container.open { display: block; animation: slideDown 0.3s ease-out; }
        
        .site-mini-card {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; transition: 0.2s; position: relative;
        }
        .site-mini-card:hover { transform: translateX(-5px); border-color: var(--accent); }
        .site-info h4 { margin: 0 0 5px 0; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
        .site-stats { font-size: 0.85rem; color: #666; display: flex; gap: 15px; }
        .site-balance { font-weight: bold; }
        
        .category-badge {
            font-size: 0.7em; padding: 2px 8px; border-radius: 10px; color: white;
            background: #999; vertical-align: middle;
        }
        .cat-spare_parts { background: var(--primary); }
        .cat-labor { background: var(--accent-orange); }
        .cat-subcontractors { background: #6c757d; }

        .empty-sites { text-align: center; color: #999; padding: 20px; font-style: italic; }
        
        .btn-edit-sm {
            background: white; border: 1px solid #ccc; color: #555;
            padding: 5px 10px; border-radius: 5px; cursor: pointer;
            font-size: 0.8em; margin-left: 5px; transition: 0.2s;
        }
        .btn-edit-sm:hover { border-color: var(--primary); color: var(--primary); }
        
        .btn-edit-contract {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            width: 30px; height: 30px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; cursor: pointer; text-decoration: none;
        }
        .btn-edit-contract:hover { background: var(--accent); color: white; }

        /* Ø³ØªØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù„Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ */
        .btn-delete {
            background: transparent; border: 1px solid var(--danger); color: var(--danger);
            width: 30px; height: 30px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; cursor: pointer; margin-right: 5px;
        }
        .btn-delete:hover { background: var(--danger); color: white; }

        /* Ø³ØªØ§ÙŠÙ„ Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ */
        .project-group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 5px; border-bottom: 2px solid #eee; margin-bottom: 10px; margin-top: 15px;
        }
        .project-group-title { font-weight: bold; color: var(--primary); font-size: 1.1em; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <h3 style="color: var(--primary); margin-top: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h3>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span style="font-size: 0.8rem; color: #888;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹</span>
            </div>
        </div>
        <button onclick="logout()" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</button>
    </nav>

    <div class="container">
        
        <div id="adminPanel" class="admin-panel">
            <h3 style="margin-top: 0; color: var(--primary);">ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                <div style="flex: 1;">
                     <button onclick="openUsersModal()" class="btn-users">
                        <i class="fa-solid fa-users-gear"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    </button>
                </div>
                <div style="flex: 1;">
                    <button onclick="recalculateAllProjects()" class="btn-sync">
                        <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø©
                    </button>
                </div>
            </div>
            
            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="document.getElementById('addContractModal').style.display='flex'" class="btn btn-primary" style="flex: 1; padding: 15px;">
                    <i class="fa-solid fa-file-contract" style="font-size: 1.2rem;"></i><br> Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯
                </button>
                <button onclick="openAddSiteModal()" class="btn btn-warning" style="flex: 1; padding: 15px; color: white;">
                    <i class="fa-solid fa-map-location-dot" style="font-size: 1.2rem;"></i><br> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ / Ø¨Ù†Ø¯
                </button>
            </div>
        </div>

        <h3 style="margin-bottom: 20px; color: var(--text-dark); border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px;">
            <i class="fa-solid fa-folder-tree"></i> Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
        </h3>
        
        <div id="contractsGrid">
            <p style="text-align:center; color:#888;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯...</p>
        </div>
    </div>

    <div id="addContractModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="document.getElementById('addContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯ (Ù…Ø«Ø§Ù„: Ø¹Ù‚Ø¯ Ù…Ù†Ø·Ù‚Ø© ØªØ¨ÙˆÙƒ)</label>
                    <input type="text" id="newContractName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯...">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ© (Ù…Ø«Ø§Ù„: ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©)</label>
                    <input type="text" id="newContractAuth" placeholder="Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©...">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-box" style="flex:1;">
                        <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
                        <input type="date" id="newContractStart">
                    </div>
                    <div class="input-box" style="flex:1;">
                        <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
                        <input type="date" id="newContractEnd">
                    </div>
                </div>
                <p style="font-size:0.85em; color:#888; margin-top:5px;">* Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø³ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹/Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù‡.</p>
                <button onclick="addContract()" class="btn-add" style="margin-top: 10px; width: 100%;">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</button>
            </div>
        </div>
    </div>

    <div id="editContractModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="document.getElementById('editContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</h2>
            <input type="hidden" id="editContractId">
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯</label>
                    <input type="text" id="editContractName">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©</label>
                    <input type="text" id="editContractAuth">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-box" style="flex:1;">
                        <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
                        <input type="date" id="editContractStart">
                    </div>
                    <div class="input-box" style="flex:1;">
                        <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
                        <input type="date" id="editContractEnd">
                    </div>
                </div>
                <button onclick="updateContract()" class="btn-add" style="margin-top: 10px; width: 100%;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="addSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="document.getElementById('addSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù„Ù„Ø¹Ù‚Ø¯</h2>
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡</label>
                    <select id="contractSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                </div>
                <div class="input-box">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
                    <select id="newSiteCategory" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-weight:bold;">
                        <option value="spare_parts" selected>âš™ï¸ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</option>
                        <option value="labor">ğŸ‘· Ø¹Ù…Ø§Ù„Ø©</option>
                        <option value="subcontractors">ğŸ¤ Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø¨Ø§Ø·Ù†</option>
                    </select>
                </div>
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù…Ø«Ø§Ù„: Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ØªØ­Ø±Ùƒ)</label>
                    <input type="text" id="newSiteName" placeholder="Ø§Ù„Ø§Ø³Ù…...">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯</label>
                    <input type="number" id="newSiteBudget" placeholder="Ù…Ø«Ø§Ù„: 6000000">
                </div>
                <button onclick="addSite()" class="btn-add" style="margin-top: 10px; width: 100%;">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <div id="editSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="document.getElementById('editSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ø¯</h2>
            <input type="hidden" id="editSiteId">
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label>Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡</label>
                    <select id="editSiteContractSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fffbe6;">
                    </select>
                </div>
                <div class="input-box">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
                    <select id="editSiteCategory" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="spare_parts">âš™ï¸ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
                        <option value="labor">ğŸ‘· Ø¹Ù…Ø§Ù„Ø©</option>
                        <option value="subcontractors">ğŸ¤ Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø¨Ø§Ø·Ù†</option>
                    </select>
                </div>
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                    <input type="text" id="editSiteName">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</label>
                    <input type="number" id="editSiteBudget">
                </div>
                <button onclick="updateSite()" class="btn-add" style="margin-top: 10px; width: 100%;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                            <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØµØµ</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allContracts = [];
    let allSites = [];

    const categoryLabels = {
        'spare_parts': { text: 'Ù‚Ø·Ø¹ ØºÙŠØ§Ø±', icon: 'fa-cogs', class: 'cat-spare_parts' },
        'labor': { text: 'Ø¹Ù…Ø§Ù„Ø©', icon: 'fa-hard-hat', class: 'cat-labor' },
        'subcontractors': { text: 'Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø¨Ø§Ø·Ù†', icon: 'fa-handshake', class: 'cat-subcontractors' }
    };

    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            if(userData.role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                loadData(); 
            } else {
                if(userData.assignedSiteId) window.location.href = "details.html?id=" + userData.assignedSiteId;
                else document.getElementById('contractsGrid').innerHTML = "<p style='text-align:center'>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„.</p>";
            }
        }
    });

    function loadData() {
        db.collection("contracts").orderBy("createdAt", "desc").onSnapshot(contractSnap => {
            allContracts = [];
            contractSnap.forEach(doc => allContracts.push({ id: doc.id, ...doc.data() }));
            
            db.collection("budgets").onSnapshot(siteSnap => {
                allSites = [];
                siteSnap.forEach(doc => allSites.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        });
    }

    function renderDashboard() {
        const container = document.getElementById('contractsGrid');
        container.innerHTML = "";

        if (allContracts.length === 0 && allSites.length > 0) {
            renderContractCard({ id: 'legacy', name: 'Ø¹Ù‚ÙˆØ¯ Ø£Ø®Ø±Ù‰ / ØºÙŠØ± Ù…ØµÙ†ÙØ©', totalValue: 0 }, allSites, container);
            return;
        }

        if (allContracts.length === 0) {
            container.innerHTML = "<p style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯.</p>";
            return;
        }

        allContracts.forEach(contract => {
            const contractSites = allSites.filter(site => site.contractId === contract.id);
            renderContractCard(contract, contractSites, container);
        });

        const orphanSites = allSites.filter(site => !site.contractId);
        if (orphanSites.length > 0) {
            renderContractCard({ id: 'orphans', name: 'Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù‚Ø¯ (ÙŠØ¬Ø¨ Ø±Ø¨Ø·Ù‡Ø§)', totalValue: 0 }, orphanSites, container, true);
        }
    }

    function renderContractCard(contract, sites, container, isOrphan = false) {
        const allocatedTotal = sites.reduce((sum, s) => sum + (s.totalAllocatedAmount || 0), 0);
        const spentTotal = sites.reduce((sum, s) => sum + (s.totalSpent || 0), 0);
        
        let sitesHTML = "";

        // -------------------------
        //  Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Grouping)
        // -------------------------
        if (sites.length === 0) {
            sitesHTML = `<div class="empty-sites">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ø¯.</div>`;
        } else {
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
            const groupedProjects = {};
            sites.forEach(site => {
                const name = site.itemName;
                if (!groupedProjects[name]) groupedProjects[name] = [];
                groupedProjects[name].push(site);
            });

            // Ø§Ù„Ø±Ø³Ù…
            Object.keys(groupedProjects).forEach(projectName => {
                const projectItems = groupedProjects[projectName];
                
                // Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…Ø¹ Ù…Ø¹ Ø²Ø± Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡
                sitesHTML += `
                <div class="project-group-header">
                    <span class="project-group-title"><i class="fa-solid fa-layer-group"></i> ${projectName}</span>
                    <button onclick="deleteProjectGroup('${contract.id}', '${projectName}')" class="btn btn-outline" style="border-color:var(--danger); color:var(--danger); font-size:0.8em; padding:3px 10px;">
                        <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                    </button>
                </div>
                `;

                // Ø±Ø³Ù… Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù‚Ø·Ø¹ ØºÙŠØ§Ø±ØŒ Ø¹Ù…Ø§Ù„Ø©ØŒ Ø§Ù„Ø®)
                projectItems.forEach(site => {
                    const percent = site.totalAllocatedAmount ? (site.currentBalance / site.totalAllocatedAmount) * 100 : 0;
                    const balanceColor = percent < 20 ? 'var(--danger)' : 'var(--success)';
                    const catKey = site.category || 'spare_parts';
                    const catInfo = categoryLabels[catKey] || categoryLabels['spare_parts'];

                    sitesHTML += `
                    <div class="site-mini-card">
                        <div class="site-info">
                            <h4>
                                <i class="fa-solid ${catInfo.icon}" style="color:var(--primary);"></i> 
                                ${catInfo.text} <span class="category-badge ${catInfo.class}">${catInfo.text}</span>
                            </h4>
                            <div class="site-stats">
                                <span>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${fmt(site.totalAllocatedAmount)}</span>
                                <span>Ø§Ù„Ù…ØµØ±ÙˆÙ: <span style="color:var(--danger)">${fmt(site.totalSpent)}</span></span>
                            </div>
                        </div>
                        <div style="text-align:left">
                            <div class="site-balance" style="color:${balanceColor}">${fmt(site.currentBalance)}</div>
                            <div style="margin-top:5px; display:flex; gap:5px; justify-content:flex-end;">
                                <a href="details.html?id=${site.id}" class="btn btn-outline" style="font-size:0.8em; padding:5px 10px; display:inline-block;">Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                                <button onclick="openEditSiteModal('${site.id}')" class="btn-edit-sm" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fa-solid fa-pen-to-square"></i></button>
                            </div>
                        </div>
                    </div>
                    `;
                });
            });
        }

        const headerStyle = isOrphan ? 'background: #fff0f0; border-bottom-color: var(--danger);' : '';
        const titleStyle = isOrphan ? 'color: var(--danger);' : '';

        const authority = contract.supervisingAuthority ? `<span title="Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©"><i class="fa-solid fa-building-columns"></i> ${contract.supervisingAuthority}</span>` : '';
        const dateRange = (contract.startDate || contract.endDate) ? 
            `<span title="Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯"><i class="fa-regular fa-calendar"></i> ${contract.startDate || '?'} <i class="fa-solid fa-arrow-left" style="font-size:0.7em"></i> ${contract.endDate || '?'}</span>` : '';

        const html = `
        <div class="contract-card">
            <div class="contract-header" onclick="toggleSites('${contract.id}')" style="${headerStyle}">
                <div class="contract-info-block">
                    <div class="contract-title" style="${titleStyle}">
                        <i class="fa-solid ${isOrphan ? 'fa-triangle-exclamation' : 'fa-file-signature'}"></i>
                        ${contract.name}
                        
                        ${!isOrphan ? `
                            <div style="display:flex; gap:5px; margin-right:10px;">
                                <a href="contract-details.html?id=${contract.id}" onclick="event.stopPropagation();" class="btn-edit-contract" title="Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯" style="border-color:var(--primary); color:var(--primary);">
                                    <i class="fa-solid fa-chart-pie"></i>
                                </a>
                                <button onclick="openEditContractModal('${contract.id}'); event.stopPropagation();" class="btn-edit-contract" title="ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="deleteContract('${contract.id}', '${contract.name}'); event.stopPropagation();" class="btn-delete" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}

                    </div>
                    <div class="contract-details">
                         ${authority}
                         ${dateRange}
                         <span style="border-color:var(--accent); color:var(--primary); font-weight:bold;"><i class="fa-solid fa-calculator"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯: ${fmt(allocatedTotal)}</span>
                         <span><i class="fa-solid fa-chart-pie"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ: ${fmt(spentTotal)}</span>
                    </div>
                </div>
                <div>
                    <i id="icon-${contract.id}" class="fa-solid fa-chevron-down" style="color:#aaa; font-size:1.2em; margin-top:10px;"></i>
                </div>
            </div>
            <div id="sites-${contract.id}" class="sites-container" style="${isOrphan ? 'display:block;' : ''}">
                ${sitesHTML}
                ${!isOrphan ? `<div style="text-align:center; margin-top:10px;">
                    <button onclick="openAddSiteModal('${contract.id}')" class="btn btn-warning" style="font-size:0.9em;">
                        <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯/Ù…ÙˆÙ‚Ø¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯
                    </button>
                </div>` : ''}
            </div>
        </div>
        `;
        container.innerHTML += html;
    }

    function toggleSites(id) {
        const el = document.getElementById(`sites-${id}`);
        const icon = document.getElementById(`icon-${id}`);
        if (el.style.display === 'block') {
            el.style.display = 'none';
            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            el.classList.remove('open');
        } else {
            el.style.display = 'block';
            el.classList.add('open');
            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        }
    }

    // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù) ---

    // 1. Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯
    async function deleteContract(contractId, name) {
        if(!confirm(`ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…!\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ (${name}) ÙˆÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ø¯Ø§Ø®Ù„Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;
        
        try {
            // Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯
            await db.collection("contracts").doc(contractId).delete();
            
            // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯
            const snap = await db.collection("budgets").where("contractId", "==", contractId).get();
            const batch = db.batch();
            snap.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
        } catch(e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
        }
    }

    // 2. Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯)
    async function deleteProjectGroup(contractId, projectName) {
        if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (${projectName})ØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø«Ù„Ø§Ø«Ø© (Ù‚Ø·Ø¹ ØºÙŠØ§Ø±ØŒ Ø¹Ù…Ø§Ù„Ø©ØŒ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†) Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡.`)) return;

        try {
            const snap = await db.collection("budgets")
                .where("contractId", "==", contractId)
                .where("itemName", "==", projectName)
                .get();

            const batch = db.batch();
            snap.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­.");
        } catch(e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
        }
    }

    // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ ---
    function addContract() {
        const name = document.getElementById('newContractName').value;
        const auth = document.getElementById('newContractAuth').value;
        const start = document.getElementById('newContractStart').value;
        const end = document.getElementById('newContractEnd').value;
        if(!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯");
        const btn = event.target; btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;
        db.collection("contracts").add({
            name: name, supervisingAuthority: auth, startDate: start, endDate: end,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById('addContractModal').style.display='none';
            document.getElementById('newContractName').value="";
            btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯"; btn.disabled = false;
        });
    }

    function openEditContractModal(contractId) {
        const contract = allContracts.find(c => c.id === contractId);
        if(!contract) return;
        document.getElementById('editContractId').value = contractId;
        document.getElementById('editContractName').value = contract.name;
        document.getElementById('editContractAuth').value = contract.supervisingAuthority || '';
        document.getElementById('editContractStart').value = contract.startDate || '';
        document.getElementById('editContractEnd').value = contract.endDate || '';
        document.getElementById('editContractModal').style.display = 'flex';
    }

    async function updateContract() {
        const id = document.getElementById('editContractId').value;
        const name = document.getElementById('editContractName').value;
        const auth = document.getElementById('editContractAuth').value;
        const start = document.getElementById('editContractStart').value;
        const end = document.getElementById('editContractEnd').value;
        if(!id || !name) return alert("Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø·Ù„ÙˆØ¨");
        const btn = event.target; btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;
        try {
            await db.collection("contracts").doc(id).update({ name: name, supervisingAuthority: auth, startDate: start, endDate: end });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯"); document.getElementById('editContractModal').style.display='none';
        } catch(e) { alert("Ø®Ø·Ø£: " + e.message); } finally { btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"; btn.disabled = false; }
    }

    function openAddSiteModal(preSelectedContractId = null) {
        const select = document.getElementById('contractSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ --</option>';
        allContracts.forEach(c => {
            const sel = preSelectedContractId === c.id ? 'selected' : '';
            select.innerHTML += `<option value="${c.id}" ${sel}>${c.name}</option>`;
        });
        document.getElementById('addSiteModal').style.display = 'flex';
    }

    function addSite() {
        const contractId = document.getElementById('contractSelect').value;
        const category = document.getElementById('newSiteCategory').value;
        const name = document.getElementById('newSiteName').value;
        const budget = Number(document.getElementById('newSiteBudget').value);
        if(!contractId || !name || !budget) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        const btn = event.target; btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;
        db.collection("budgets").add({
            contractId: contractId, category: category, itemName: name, totalAllocatedAmount: budget, currentBalance: budget,
            totalSpent: 0, totalProfit: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­"); document.getElementById('addSiteModal').style.display='none';
            document.getElementById('newSiteName').value=""; document.getElementById('newSiteBudget').value="";
            btn.innerHTML = "Ø­ÙØ¸"; btn.disabled = false;
        });
    }

    function openEditSiteModal(siteId) {
        const site = allSites.find(s => s.id === siteId); if(!site) return;
        document.getElementById('editSiteId').value = siteId;
        document.getElementById('editSiteName').value = site.itemName;
        document.getElementById('editSiteBudget').value = site.totalAllocatedAmount;
        document.getElementById('editSiteCategory').value = site.category || 'spare_parts';
        const select = document.getElementById('editSiteContractSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ --</option>';
        allContracts.forEach(c => {
            const selected = site.contractId === c.id ? 'selected' : '';
            select.innerHTML += `<option value="${c.id}" ${selected}>${c.name}</option>`;
        });
        document.getElementById('editSiteModal').style.display = 'flex';
    }

    async function updateSite() {
        const siteId = document.getElementById('editSiteId').value;
        const contractId = document.getElementById('editSiteContractSelect').value;
        const category = document.getElementById('editSiteCategory').value;
        const name = document.getElementById('editSiteName').value;
        const budget = Number(document.getElementById('editSiteBudget').value);
        if(!siteId || !contractId || !name) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        const btn = event.target; btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;
        try {
            await db.collection('budgets').doc(siteId).update({ contractId: contractId, category: category, itemName: name, totalAllocatedAmount: budget });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­"); document.getElementById('editSiteModal').style.display = 'none';
        } catch (e) { alert("Ø®Ø·Ø£: " + e.message); } finally { btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"; btn.disabled = false; }
    }
/// Ø§Ù„ÙŠÙˆØ²Ø±Ø²
    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„) ---
    async function openUsersModal() {
        document.getElementById('usersModal').style.display = 'flex';
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø±ØªØ¨ÙŠÙ† Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
            const usersSnap = await db.collection('users').orderBy('createdAt', 'desc').get();
            tbody.innerHTML = '';
            
            usersSnap.forEach(doc => {
                const u = doc.data();
                const userId = doc.id;
                
                // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Dropdown) Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
                let sitesOptions = `<option value="">-- Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹ --</option>`;
                
                // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù‚ÙˆØ¯
                allContracts.forEach(contract => {
                    const contractSites = allSites.filter(s => s.contractId === contract.id);
                    if(contractSites.length > 0) {
                        sitesOptions += `<optgroup label="${contract.name}">`;
                        contractSites.forEach(site => {
                            const selected = u.assignedSiteId === site.id ? 'selected' : '';
                            // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                            const catKey = site.category || 'spare_parts';
                            const catText = categoryLabels[catKey] ? categoryLabels[catKey].text : 'Ù‚Ø·Ø¹ ØºÙŠØ§Ø±';
                            
                            sitesOptions += `<option value="${site.id}" ${selected}>${site.itemName} (${catText})</option>`;
                        });
                        sitesOptions += `</optgroup>`;
                    }
                });
                
                // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Orphans)
                const orphans = allSites.filter(s => !s.contractId);
                if(orphans.length > 0) {
                     sitesOptions += `<optgroup label="Ø£Ø®Ø±Ù‰">`;
                     orphans.forEach(site => {
                        const selected = u.assignedSiteId === site.id ? 'selected' : '';
                        sitesOptions += `<option value="${site.id}" ${selected}>${site.itemName}</option>`;
                     });
                     sitesOptions += `</optgroup>`;
                }

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const r = u.role;
                const selUser = r === 'user' ? 'selected' : '';
                const selAdmin = r === 'admin' ? 'selected' : '';
                const selViewer = r === 'viewer' ? 'selected' : '';
                const selViewerPro = r === 'viewer_pro' ? 'selected' : '';

                // Ø±Ø³Ù… Ø§Ù„ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                const row = `
                <tr>
                    <td>
                        ${u.email} <br> 
                        <small style="color:#999; font-size:0.8em;">${userId.substring(0,5)}...</small>
                    </td>
                    <td>
                        <select id="role-${userId}" style="padding: 6px; width: 100%; border:1px solid #ddd; border-radius:4px;">
                            <option value="user" ${selUser}>Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø¯Ø®Ø§Ù„)</option>
                            <option value="viewer" ${selViewer}>Ù…Ø´Ø§Ù‡Ø¯ ÙÙ‚Ø·</option>
                            <option value="viewer_pro" ${selViewerPro}>Ù…Ø´Ø§Ù‡Ø¯ + Ø£Ø±Ø¨Ø§Ø­</option>
                            <option value="admin" ${selAdmin}>Ù…Ø¯ÙŠØ± (Admin)</option>
                        </select>
                    </td>
                    <td>
                        <select id="site-${userId}" style="padding: 6px; width: 100%; border:1px solid #ddd; border-radius:4px;">
                            ${sitesOptions}
                        </select>
                    </td>
                    <td>
                        <button onclick="saveUserChanges('${userId}')" class="btn btn-success" style="padding:5px 10px; font-size:0.9em;">Ø­ÙØ¸</button>
                    </td>
                </tr>`;
                
                tbody.innerHTML += row;
            });
            
            if(usersSnap.empty) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†.</td></tr>';
            }

        } catch (e) { 
            console.error(e); 
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Ø®Ø·Ø£: ${e.message}</td></tr>`;
        }
    }

    async function saveUserChanges(userId) {
        const newRole = document.getElementById(`role-${userId}`).value;
        const newSite = document.getElementById(`site-${userId}`).value;
        
        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "..."; 
        btn.disabled = true;
        
        try {
            await db.collection('users').doc(userId).update({ 
                role: newRole, 
                assignedSiteId: newSite 
            });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        } catch (e) { 
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + e.message); 
        } finally { 
            btn.innerText = oldText; 
            btn.disabled = false; 
        }
    }
    // ... Ø¯ÙˆØ§Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙƒÙ…Ø§ Ù‡ÙŠ ...
    async function recalculateAllProjects() {
       if(!confirm("Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø©ØŸ")) return;
       document.getElementById('loader').style.display = 'flex';
       try {
           const bs = await db.collection('budgets').get();
           const promises = bs.docs.map(async b => {
               const trans = await b.ref.collection('transactions').get();
               let p = 0, s = 0;
               trans.forEach(t => { s += Number(t.data().amountExclTax)||0; p += Number(t.data().companyProfit)||0; });
               return b.ref.update({ totalSpent: s, totalProfit: p, currentBalance: (b.data().totalAllocatedAmount||0) - s });
           });
           await Promise.all(promises); alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!");
       } catch(e) { alert(e.message); } finally { document.getElementById('loader').style.display = 'none'; }
    }

    function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits: 2}); }
</script>
</body>
</html>
