<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฑุฆูุณูุฉ - ุงูููุงูุน</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <h2>๐ ููุญุฉ ุงูููุงุฏุฉ ูุงูููุงูุน</h2>
        <button onclick="logout()" class="btn btn-danger">ุชุณุฌูู ุฎุฑูุฌ</button>
    </div>

    <div id="adminPanel" class="card" style="display:none; border-right: 5px solid var(--accent);">
        <h3>๐ ุฅุถุงูุฉ ูููุน ุฌุฏูุฏ</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newSiteName" placeholder="ุงุณู ุงููููุน (ูุซุงู: ูุณุชุดูู ุงูุญุฑุณ)">
            <input type="number" id="newSiteBudget" placeholder="ุงูููุฒุงููุฉ ุงููุนุชูุฏุฉ">
            <button onclick="addSite()" class="btn btn-warning" style="white-space: nowrap;">ุฅุถุงูุฉ +</button>
        </div>
    </div>

    <h3 style="margin-top: 30px;">ุงูููุงูุน ุงููุชุงุญุฉ:</h3>
    <div id="sitesGrid" class="stat-grid">
        <p>ุฌุงุฑู ุงูุชุญููู...</p>
    </div>
</div>

<script>
    // ููุณ ุงูููููุฌุฑูุดู ุฏุงุฆูุงู
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(async user => {
        if(!user) window.location.href = "index.html";
        
        // ุงูุชุญูู ูู ุงูุฃุฏูู
        const userDoc = await db.collection('users').doc(user.uid).get();
        if(userDoc.exists && userDoc.data().role === 'admin') {
            document.getElementById('adminPanel').style.display = 'block';
            loadAllSites();
        } else {
            // ุชุญููู ูููุน ุงููุณุชุฎุฏู ุงููุญุฏุฏ ููุท
            loadMySite(userDoc.data().assignedSiteId);
        }
    });

    function loadAllSites() {
        db.collection("budgets").orderBy("createdAt", "desc").onSnapshot(snap => renderSites(snap.docs));
    }

    function loadMySite(siteId) {
        if(!siteId) return document.getElementById('sitesGrid').innerHTML = "ูู ูุชู ุชุนููู ูููุน ูู.";
        db.collection("budgets").doc(siteId).onSnapshot(doc => renderSites([doc]));
    }

    function renderSites(docs) {
        const container = document.getElementById('sitesGrid');
        container.innerHTML = "";
        docs.forEach(doc => {
            const d = doc.data();
            // ุฃููุงู ุฏููุงููููุฉ ุญุณุจ ูุณุจุฉ ุงููุชุจูู
            const percent = (d.currentBalance / d.totalAllocatedAmount) * 100;
            const color = percent < 20 ? 'red' : 'green';

            const html = `
            <div class="card">
                <h3>๐ข ${d.itemName}</h3>
                <p style="font-size:0.9em; color:#777;">ุงูููุฒุงููุฉ: ${Number(d.totalAllocatedAmount).toLocaleString()}</p>
                <div style="margin: 15px 0;">
                    <span style="display:block; font-size:0.8em;">ุงููุชุจูู</span>
                    <strong style="font-size:1.4em; color:${color}">${Number(d.currentBalance).toLocaleString()}</strong>
                </div>
                <a href="details.html?id=${doc.id}" class="btn btn-secondary" style="width:100%; text-align:center;">ุฅุฏุงุฑุฉ ุงูุนูููุงุช</a>
            </div>`;
            container.innerHTML += html;
        });
    }

    function addSite() {
        const name = document.getElementById('newSiteName').value;
        const budget = Number(document.getElementById('newSiteBudget').value);
        if(!name || !budget) return alert("ุฃููู ุงูุจูุงูุงุช");
        
        db.collection("budgets").add({
            itemName: name, totalAllocatedAmount: budget, currentBalance: budget,
            totalSpent: 0, totalProfit: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { alert("ุชู"); document.getElementById('newSiteName').value=""; });
    }

    function logout() { auth.signOut(); }
</script>
</body>
</html>
