<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FGC Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* (Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„) */
        .contract-card {
            background: white; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden;
            border: 1px solid #eee; transition: 0.3s;
        }
        .contract-header {
            background: linear-gradient(to left, #f8f9fa, #fff);
            padding: 20px; cursor: pointer; display: flex;
            justify-content: space-between; align-items: flex-start;
            border-bottom: 3px solid var(--primary);
        }
        .contract-header:hover { background: #f1f3f5; }
        .contract-info-block { flex: 1; }
        .contract-title { font-size: 1.3rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 8px;}
        .contract-details { font-size: 0.9rem; color: #555; display: flex; flex-wrap: wrap; gap: 15px; }
        .contract-details span { background: #eef2f7; padding: 4px 8px; border-radius: 4px; border: 1px solid #dee2e6; }
        
        .sites-container {
            padding: 20px; background: #fafafa; display: none;
            border-top: 1px solid #ddd;
        }
        .sites-container.open { display: block; animation: slideDown 0.3s ease-out; }
        
        .site-mini-card {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; transition: 0.2s; position: relative;
        }
        .site-mini-card:hover { transform: translateX(-5px); border-color: var(--accent); }
        .site-info h4 { margin: 0 0 5px 0; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
        .site-stats { font-size: 0.85rem; color: #666; display: flex; gap: 15px; }
        .site-balance { font-weight: bold; }
        
        .category-badge {
            font-size: 0.7em; padding: 2px 8px; border-radius: 10px; color: white;
            background: #999; vertical-align: middle;
        }
        .cat-spare_parts { background: var(--primary); }
        .cat-labor { background: var(--accent-orange); }
        .cat-subcontractors { background: #6c757d; }

        .empty-sites { text-align: center; color: #999; padding: 20px; font-style: italic; }
        
        .btn-edit-sm {
            background: white; border: 1px solid #ccc; color: #555;
            padding: 5px 10px; border-radius: 5px; cursor: pointer;
            font-size: 0.8em; margin-left: 5px; transition: 0.2s;
        }
        .btn-edit-sm:hover { border-color: var(--primary); color: var(--primary); }
        
        .btn-edit-contract {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            width: 30px; height: 30px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; cursor: pointer; text-decoration: none;
        }
        .btn-edit-contract:hover { background: var(--accent); color: white; }

        .btn-delete {
            background: transparent; border: 1px solid var(--danger); color: var(--danger);
            width: 30px; height: 30px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; cursor: pointer; margin-right: 5px;
        }
        .btn-delete:hover { background: var(--danger); color: white; }

        .project-group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 5px; border-bottom: 2px solid #eee; margin-bottom: 10px; margin-top: 15px;
        }
        .project-group-title { font-weight: bold; color: var(--primary); font-size: 1.1em; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø³ØªØ§ÙŠÙ„ Ø²Ø± Ø§Ù„Ù„ØºØ© */
        .lang-btn {
            background: transparent; border: 1px solid #fff; color: var(--primary); 
            font-weight: bold; cursor: pointer; padding: 5px 10px; border-radius: 5px; 
            border: 1px solid var(--primary); margin-left: 10px;
        }
        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© */
        html[dir="ltr"] .site-mini-card:hover { transform: translateX(5px); }
        html[dir="ltr"] .nav-brand { gap: 15px; }
        html[dir="ltr"] .contract-title { flex-direction: row; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <h3 id="txt_loading" style="color: var(--primary); margin-top: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h3>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span id="txt_nav_subtitle" style="font-size: 0.8rem; color: #888;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹</span>
            </div>
        </div>
        <div style="display: flex; align-items: center;">
            <button onclick="toggleLanguage()" class="lang-btn">English / Ø¹Ø±Ø¨ÙŠ</button>
            <button onclick="logout()" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> <span id="txt_logout">Ø®Ø±ÙˆØ¬</span></button>
        </div>
    </nav>

    <div class="container">
        
        <div id="adminPanel" class="admin-panel">
            <h3 style="margin-top: 0; color: var(--primary);">ğŸ‘‘ <span id="txt_admin_panel">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</span></h3>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                <div style="flex: 1;">
                     <button onclick="openUsersModal()" class="btn-users">
                        <i class="fa-solid fa-users-gear"></i> <span id="txt_manage_users">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                    </button>
                </div>
                <div style="flex: 1;">
                    <button onclick="recalculateAllProjects()" class="btn-sync">
                        <i class="fa-solid fa-rotate"></i> <span id="txt_refresh_balance">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø©</span>
                    </button>
                </div>
            </div>
            
            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="document.getElementById('addContractModal').style.display='flex'" class="btn btn-primary" style="flex: 1; padding: 15px;">
                    <i class="fa-solid fa-file-contract" style="font-size: 1.2rem;"></i><br> <span id="txt_add_contract">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</span>
                </button>
                <button onclick="openAddSiteModal()" class="btn btn-warning" style="flex: 1; padding: 15px; color: white;">
                    <i class="fa-solid fa-map-location-dot" style="font-size: 1.2rem;"></i><br> <span id="txt_add_site">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ / Ø¨Ù†Ø¯</span>
                </button>
            </div>
        </div>

        <h3 style="margin-bottom: 20px; color: var(--text-dark); border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px;">
            <i class="fa-solid fa-folder-tree"></i> <span id="txt_contracts_title">Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
        </h3>
        
        <div id="contractsGrid">
            <p id="txt_loading_contracts" style="text-align:center; color:#888;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯...</p>
        </div>
    </div>

    <div id="addContractModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="document.getElementById('addContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;"><span id="txt_modal_add_contract">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</span></h2>
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label id="lbl_contract_name">Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯</label>
                    <input type="text" id="newContractName">
                </div>
                <div class="input-box">
                    <label id="lbl_contract_auth">Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©</label>
                    <input type="text" id="newContractAuth">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-box" style="flex:1;">
                        <label id="lbl_start_date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                        <input type="date" id="newContractStart">
                    </div>
                    <div class="input-box" style="flex:1;">
                        <label id="lbl_end_date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
                        <input type="date" id="newContractEnd">
                    </div>
                </div>
                <p id="txt_contract_hint" style="font-size:0.85em; color:#888; margin-top:5px;">* Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
                <button onclick="addContract()" class="btn-add" style="margin-top: 10px; width: 100%;"><span id="btn_save_contract">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</span></button>
            </div>
        </div>
    </div>

    <div id="editContractModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="document.getElementById('editContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;"><span id="txt_modal_edit_contract">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</span></h2>
            <input type="hidden" id="editContractId">
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label id="lbl_edit_contract_name">Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯</label>
                    <input type="text" id="editContractName">
                </div>
                <div class="input-box">
                    <label id="lbl_edit_contract_auth">Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©</label>
                    <input type="text" id="editContractAuth">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-box" style="flex:1;">
                        <label id="lbl_edit_start_date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                        <input type="date" id="editContractStart">
                    </div>
                    <div class="input-box" style="flex:1;">
                        <label id="lbl_edit_end_date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
                        <input type="date" id="editContractEnd">
                    </div>
                </div>
                <button onclick="updateContract()" class="btn-add" style="margin-top: 10px; width: 100%;"><span id="btn_update_contract">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</span></button>
            </div>
        </div>
    </div>

    <div id="addSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="document.getElementById('addSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;"><span id="txt_modal_add_site">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù„Ù„Ø¹Ù‚Ø¯</span></h2>
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label id="lbl_select_contract">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯</label>
                    <select id="contractSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="">...</option>
                    </select>
                </div>
                <div class="input-box">
                    <label id="lbl_site_category">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
                    <select id="newSiteCategory" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-weight:bold;">
                        <option value="spare_parts" selected>âš™ï¸ Spare Parts</option>
                        <option value="labor">ğŸ‘· Labor</option>
                        <option value="subcontractors">ğŸ¤ Subcontractors</option>
                    </select>
                </div>
                <div class="input-box">
                    <label id="lbl_site_name">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                    <input type="text" id="newSiteName">
                </div>
                <div class="input-box">
                    <label id="lbl_site_budget">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</label>
                    <input type="number" id="newSiteBudget">
                </div>
                <button onclick="addSite()" class="btn-add" style="margin-top: 10px; width: 100%;"><span id="btn_save_site">Ø­ÙØ¸</span></button>
            </div>
        </div>
    </div>

    <div id="editSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="document.getElementById('editSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;"><span id="txt_modal_edit_site">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ø¯</span></h2>
            <input type="hidden" id="editSiteId">
            <div class="input-group" style="flex-direction: column; align-items: stretch;">
                <div class="input-box">
                    <label id="lbl_edit_site_contract">Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡</label>
                    <select id="editSiteContractSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fffbe6;">
                    </select>
                </div>
                <div class="input-box">
                    <label id="lbl_edit_site_cat">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
                    <select id="editSiteCategory" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="spare_parts">âš™ï¸ Spare Parts</option>
                        <option value="labor">ğŸ‘· Labor</option>
                        <option value="subcontractors">ğŸ¤ Subcontractors</option>
                    </select>
                </div>
                <div class="input-box">
                    <label id="lbl_edit_site_name">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                    <input type="text" id="editSiteName">
                </div>
                <div class="input-box">
                    <label id="lbl_edit_site_budget">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</label>
                    <input type="number" id="editSiteBudget">
                </div>
                <button onclick="updateSite()" class="btn-add" style="margin-top: 10px; width: 100%;"><span id="btn_update_site">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</span></button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;"><span id="txt_modal_users">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></h2>
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th id="th_email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                            <th id="th_role">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                            <th id="th_site">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØµØµ</th>
                            <th id="th_action">Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allContracts = [];
    let allSites = [];
    let currentLang = localStorage.getItem('lang') || 'ar'; // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

    // Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
    const i18n = {
        ar: {
            nav_subtitle: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹",
            logout: "Ø®Ø±ÙˆØ¬",
            admin_panel: "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±",
            manage_users: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
            refresh_balance: "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø©",
            add_contract: "Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯",
            add_site: "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ / Ø¨Ù†Ø¯",
            contracts_title: "Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹",
            loading_contracts: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯...",
            no_contracts: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯.",
            total_contract: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯",
            total_spent: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ",
            budget: "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©",
            spent: "Ø§Ù„Ù…ØµØ±ÙˆÙ",
            details: "Ø§Ù„ØªÙØ§ØµÙŠÙ„",
            delete_project: "Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            delete_contract: "Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯",
            confirm_delete_contract: "ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…!\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ø¯Ø§Ø®Ù„Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ",
            confirm_delete_project: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡.",
            spare_parts: "Ù‚Ø·Ø¹ ØºÙŠØ§Ø±",
            labor: "Ø¹Ù…Ø§Ù„Ø©",
            subcontractors: "Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø¨Ø§Ø·Ù†",
            orphans_title: "Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù‚Ø¯",
            empty_contract: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ø¯.",
            modal_add_contract: "Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯",
            modal_edit_contract: "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯",
            lbl_name: "Ø§Ù„Ø§Ø³Ù…",
            lbl_auth: "Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©",
            lbl_start: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©",
            lbl_end: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©",
            btn_save: "Ø­ÙØ¸",
            btn_update: "ØªØ­Ø¯ÙŠØ«",
            hint_contract: "* Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.",
            modal_add_site: "Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù„Ù„Ø¹Ù‚Ø¯",
            modal_edit_site: "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ø¯",
            lbl_select_contract: "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯",
            lbl_cat: "Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯",
            lbl_site_name: "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            lbl_budget: "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©",
            modal_users: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
            th_email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
            th_role: "Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©",
            th_site: "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØµØµ",
            th_action: "Ø¥Ø¬Ø±Ø§Ø¡",
            role_user: "Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø¯Ø®Ø§Ù„)",
            role_admin: "Ù…Ø¯ÙŠØ± (Admin)",
            role_viewer: "Ù…Ø´Ø§Ù‡Ø¯ ÙÙ‚Ø·",
            role_viewer_pro: "Ù…Ø´Ø§Ù‡Ø¯ + Ø£Ø±Ø¨Ø§Ø­",
            no_site: "-- Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹ --",
            other: "Ø£Ø®Ø±Ù‰",
            msg_success_add: "ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­",
            msg_success_update: "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­",
            msg_success_delete: "ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­",
            msg_confirm_recalc: "Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø©ØŸ",
            msg_incomplete: "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©"
        },
        en: {
            nav_subtitle: "Contract & Site Management",
            logout: "Logout",
            admin_panel: "Admin Control Panel",
            manage_users: "Manage Users",
            refresh_balance: "Refresh Balances",
            add_contract: "Add New Contract",
            add_site: "Add Site / Item",
            contracts_title: "Contracts & Projects",
            loading_contracts: "Loading contracts...",
            no_contracts: "No contracts found. Start by adding a new one.",
            total_contract: "Total Contract",
            total_spent: "Total Spent",
            budget: "Budget",
            spent: "Spent",
            details: "Details",
            delete_project: "Delete Project",
            delete_contract: "Delete Contract",
            confirm_delete_contract: "Important Warning!\nAre you sure you want to delete this contract and all its financial data permanently?",
            confirm_delete_project: "Are you sure you want to delete this project? All associated items will be deleted.",
            spare_parts: "Spare Parts",
            labor: "Labor",
            subcontractors: "Subcontractors",
            orphans_title: "Unlinked Sites",
            empty_contract: "No items added to this contract yet.",
            modal_add_contract: "Add New Contract",
            modal_edit_contract: "Edit Contract",
            lbl_name: "Name",
            lbl_auth: "Supervising Authority",
            lbl_start: "Start Date",
            lbl_end: "End Date",
            btn_save: "Save",
            btn_update: "Update",
            hint_contract: "* Value calculated automatically.",
            modal_add_site: "Add Item to Contract",
            modal_edit_site: "Edit Item",
            lbl_select_contract: "Select Contract",
            lbl_cat: "Category",
            lbl_site_name: "Site/Project Name",
            lbl_budget: "Budget",
            modal_users: "Manage Users",
            th_email: "Email",
            th_role: "Role",
            th_site: "Assigned Site",
            th_action: "Action",
            role_user: "User (Input)",
            role_admin: "Admin",
            role_viewer: "Viewer Only",
            role_viewer_pro: "Viewer + Profit",
            no_site: "-- No Site --",
            other: "Others",
            msg_success_add: "Added Successfully",
            msg_success_update: "Updated Successfully",
            msg_success_delete: "Deleted Successfully",
            msg_confirm_recalc: "Recalculate balances?",
            msg_incomplete: "Incomplete Data"
        }
    };

    function t(key) { return i18n[currentLang][key] || key; }

    function updateLanguageUI() {
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø«Ø§Ø¨ØªØ©
        document.getElementById('txt_nav_subtitle').innerText = t('nav_subtitle');
        document.getElementById('txt_logout').innerText = t('logout');
        document.getElementById('txt_admin_panel').innerText = t('admin_panel');
        document.getElementById('txt_manage_users').innerText = t('manage_users');
        document.getElementById('txt_refresh_balance').innerText = t('refresh_balance');
        document.getElementById('txt_add_contract').innerText = t('add_contract');
        document.getElementById('txt_add_site').innerText = t('add_site');
        document.getElementById('txt_contracts_title').innerText = t('contracts_title');
        document.getElementById('txt_loading_contracts').innerText = t('loading_contracts');
        
        // Modals
        document.getElementById('txt_modal_add_contract').innerText = t('modal_add_contract');
        document.getElementById('lbl_contract_name').innerText = t('lbl_name');
        document.getElementById('lbl_contract_auth').innerText = t('lbl_auth');
        document.getElementById('lbl_start_date').innerText = t('lbl_start');
        document.getElementById('lbl_end_date').innerText = t('lbl_end');
        document.getElementById('txt_contract_hint').innerText = t('hint_contract');
        document.getElementById('btn_save_contract').innerText = t('btn_save');

        document.getElementById('txt_modal_edit_contract').innerText = t('modal_edit_contract');
        document.getElementById('lbl_edit_contract_name').innerText = t('lbl_name');
        document.getElementById('lbl_edit_contract_auth').innerText = t('lbl_auth');
        document.getElementById('lbl_edit_start_date').innerText = t('lbl_start');
        document.getElementById('lbl_edit_end_date').innerText = t('lbl_end');
        document.getElementById('btn_update_contract').innerText = t('btn_update');

        document.getElementById('txt_modal_add_site').innerText = t('modal_add_site');
        document.getElementById('lbl_select_contract').innerText = t('lbl_select_contract');
        document.getElementById('lbl_site_category').innerText = t('lbl_cat');
        document.getElementById('lbl_site_name').innerText = t('lbl_site_name');
        document.getElementById('lbl_site_budget').innerText = t('lbl_budget');
        document.getElementById('btn_save_site').innerText = t('btn_save');

        document.getElementById('txt_modal_edit_site').innerText = t('modal_edit_site');
        document.getElementById('lbl_edit_site_contract').innerText = t('lbl_select_contract');
        document.getElementById('lbl_edit_site_cat').innerText = t('lbl_cat');
        document.getElementById('lbl_edit_site_name').innerText = t('lbl_site_name');
        document.getElementById('lbl_edit_site_budget').innerText = t('lbl_budget');
        document.getElementById('btn_update_site').innerText = t('btn_update');
        
        document.getElementById('txt_modal_users').innerText = t('modal_users');
        document.getElementById('th_email').innerText = t('th_email');
        document.getElementById('th_role').innerText = t('th_role');
        document.getElementById('th_site').innerText = t('th_site');
        document.getElementById('th_action').innerText = t('th_action');

        // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        renderDashboard();
    }

    function toggleLanguage() {
        currentLang = currentLang === 'ar' ? 'en' : 'ar';
        localStorage.setItem('lang', currentLang);
        updateLanguageUI();
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    document.addEventListener('DOMContentLoaded', updateLanguageUI);

    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            if(userData.role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                loadData(); 
            } else {
                if(userData.assignedSiteId) window.location.href = "details.html?id=" + userData.assignedSiteId;
                else document.getElementById('contractsGrid').innerHTML = `<p style='text-align:center'>${t('no_contracts')}</p>`;
            }
        }
    });

    function loadData() {
        db.collection("contracts").orderBy("createdAt", "desc").onSnapshot(contractSnap => {
            allContracts = [];
            contractSnap.forEach(doc => allContracts.push({ id: doc.id, ...doc.data() }));
            
            db.collection("budgets").onSnapshot(siteSnap => {
                allSites = [];
                siteSnap.forEach(doc => allSites.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        });
    }

    function renderDashboard() {
        const container = document.getElementById('contractsGrid');
        container.innerHTML = "";

        if (allContracts.length === 0 && allSites.length > 0) {
            renderContractCard({ id: 'legacy', name: t('other'), totalValue: 0 }, allSites, container);
            return;
        }

        if (allContracts.length === 0) {
            container.innerHTML = `<p style='text-align:center'>${t('no_contracts')}</p>`;
            return;
        }

        allContracts.forEach(contract => {
            const contractSites = allSites.filter(site => site.contractId === contract.id);
            renderContractCard(contract, contractSites, container);
        });

        const orphanSites = allSites.filter(site => !site.contractId);
        if (orphanSites.length > 0) {
            renderContractCard({ id: 'orphans', name: t('orphans_title'), totalValue: 0 }, orphanSites, container, true);
        }
    }

    function renderContractCard(contract, sites, container, isOrphan = false) {
        const allocatedTotal = sites.reduce((sum, s) => sum + (s.totalAllocatedAmount || 0), 0);
        const spentTotal = sites.reduce((sum, s) => sum + (s.totalSpent || 0), 0);
        
        let sitesHTML = "";

        if (sites.length === 0) {
            sitesHTML = `<div class="empty-sites">${t('empty_contract')}</div>`;
        } else {
            const groupedProjects = {};
            sites.forEach(site => {
                const name = site.itemName;
                if (!groupedProjects[name]) groupedProjects[name] = [];
                groupedProjects[name].push(site);
            });

            Object.keys(groupedProjects).forEach(projectName => {
                const projectItems = groupedProjects[projectName];
                
                sitesHTML += `
                <div class="project-group-header">
                    <span class="project-group-title"><i class="fa-solid fa-layer-group"></i> ${projectName}</span>
                    <button onclick="deleteProjectGroup('${contract.id}', '${projectName}')" class="btn btn-outline" style="border-color:var(--danger); color:var(--danger); font-size:0.8em; padding:3px 10px;">
                        <i class="fa-solid fa-trash"></i> ${t('delete_project')}
                    </button>
                </div>
                `;

                projectItems.forEach(site => {
                    const percent = site.totalAllocatedAmount ? (site.currentBalance / site.totalAllocatedAmount) * 100 : 0;
                    const balanceColor = percent < 20 ? 'var(--danger)' : 'var(--success)';
                    const catKey = site.category || 'spare_parts';
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ù„Ù„ØªØ±Ø¬Ù…Ø©
                    const catName = t(catKey);
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„ÙƒÙ„Ø§Ø³
                    let icon = 'fa-cogs';
                    let badgeClass = 'cat-spare_parts';
                    if(catKey === 'labor') { icon = 'fa-hard-hat'; badgeClass = 'cat-labor'; }
                    if(catKey === 'subcontractors') { icon = 'fa-handshake'; badgeClass = 'cat-subcontractors'; }

                    sitesHTML += `
                    <div class="site-mini-card">
                        <div class="site-info">
                            <h4>
                                <i class="fa-solid ${icon}" style="color:var(--primary);"></i> 
                                ${catName}
                                <span class="category-badge ${badgeClass}">${catName}</span>
                            </h4>
                            <div class="site-stats">
                                <span>${t('budget')}: ${fmt(site.totalAllocatedAmount)}</span>
                                <span>${t('spent')}: <span style="color:var(--danger)">${fmt(site.totalSpent)}</span></span>
                            </div>
                        </div>
                        <div style="text-align:left">
                            <div class="site-balance" style="color:${balanceColor}">${fmt(site.currentBalance)}</div>
                            <div style="margin-top:5px; display:flex; gap:5px; justify-content:flex-end;">
                                <a href="details.html?id=${site.id}" class="btn btn-outline" style="font-size:0.8em; padding:5px 10px; display:inline-block;">${t('details')}</a>
                                <button onclick="openEditSiteModal('${site.id}')" class="btn-edit-sm" title="${t('modal_edit_site')}"><i class="fa-solid fa-pen-to-square"></i></button>
                            </div>
                        </div>
                    </div>
                    `;
                });
            });
        }

        const headerStyle = isOrphan ? 'background: #fff0f0; border-bottom-color: var(--danger);' : '';
        const titleStyle = isOrphan ? 'color: var(--danger);' : '';
        const authority = contract.supervisingAuthority ? `<span title="${t('lbl_auth')}"><i class="fa-solid fa-building-columns"></i> ${contract.supervisingAuthority}</span>` : '';
        const dateRange = (contract.startDate || contract.endDate) ? 
            `<span title="Date"><i class="fa-regular fa-calendar"></i> ${contract.startDate || '?'} <i class="fa-solid fa-arrow-left" style="font-size:0.7em"></i> ${contract.endDate || '?'}</span>` : '';

        const html = `
        <div class="contract-card">
            <div class="contract-header" onclick="toggleSites('${contract.id}')" style="${headerStyle}">
                <div class="contract-info-block">
                    <div class="contract-title" style="${titleStyle}">
                        <i class="fa-solid ${isOrphan ? 'fa-triangle-exclamation' : 'fa-file-signature'}"></i>
                        ${contract.name}
                        ${!isOrphan ? `
                            <div style="display:flex; gap:5px; margin-right:10px;">
                                <a href="contract-details.html?id=${contract.id}" onclick="event.stopPropagation();" class="btn-edit-contract" title="Report" style="border-color:var(--primary); color:var(--primary);">
                                    <i class="fa-solid fa-chart-pie"></i>
                                </a>
                                <button onclick="openEditContractModal('${contract.id}'); event.stopPropagation();" class="btn-edit-contract" title="Edit">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="deleteContract('${contract.id}', '${contract.name}'); event.stopPropagation();" class="btn-delete" title="${t('delete_contract')}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="contract-details">
                         ${authority}
                         ${dateRange}
                         <span style="border-color:var(--accent); color:var(--primary); font-weight:bold;"><i class="fa-solid fa-calculator"></i> ${t('total_contract')}: ${fmt(allocatedTotal)}</span>
                         <span><i class="fa-solid fa-chart-pie"></i> ${t('total_spent')}: ${fmt(spentTotal)}</span>
                    </div>
                </div>
                <div><i id="icon-${contract.id}" class="fa-solid fa-chevron-down" style="color:#aaa; font-size:1.2em; margin-top:10px;"></i></div>
            </div>
            <div id="sites-${contract.id}" class="sites-container" style="${isOrphan ? 'display:block;' : ''}">
                ${sitesHTML}
                ${!isOrphan ? `<div style="text-align:center; margin-top:10px;">
                    <button onclick="openAddSiteModal('${contract.id}')" class="btn btn-warning" style="font-size:0.9em;">
                        <i class="fa-solid fa-plus"></i> ${t('add_site')}
                    </button>
                </div>` : ''}
            </div>
        </div>
        `;
        container.innerHTML += html;
    }

    function toggleSites(id) {
        const el = document.getElementById(`sites-${id}`);
        const icon = document.getElementById(`icon-${id}`);
        if (el.style.display === 'block') {
            el.style.display = 'none';
            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            el.classList.remove('open');
        } else {
            el.style.display = 'block';
            el.classList.add('open');
            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        }
    }

    // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù) ---
    async function deleteContract(contractId, name) {
        if(!confirm(t('confirm_delete_contract'))) return;
        try {
            await db.collection("contracts").doc(contractId).delete();
            const snap = await db.collection("budgets").where("contractId", "==", contractId).get();
            const batch = db.batch();
            snap.forEach(doc => { batch.delete(doc.ref); });
            await batch.commit();
            alert(t('msg_success_delete'));
        } catch(e) { alert("Error: " + e.message); }
    }

    async function deleteProjectGroup(contractId, projectName) {
        if(!confirm(t('confirm_delete_project'))) return;
        try {
            const snap = await db.collection("budgets").where("contractId", "==", contractId).where("itemName", "==", projectName).get();
            const batch = db.batch();
            snap.forEach(doc => { batch.delete(doc.ref); });
            await batch.commit();
            alert(t('msg_success_delete'));
        } catch(e) { alert("Error: " + e.message); }
    }

    function addContract() {
        const name = document.getElementById('newContractName').value;
        const auth = document.getElementById('newContractAuth').value;
        const start = document.getElementById('newContractStart').value;
        const end = document.getElementById('newContractEnd').value;
        if(!name) return alert(t('msg_incomplete'));
        const btn = event.target; btn.innerHTML = "..."; btn.disabled = true;
        db.collection("contracts").add({
            name: name, supervisingAuthority: auth, startDate: start, endDate: end,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert(t('msg_success_add'));
            document.getElementById('addContractModal').style.display='none';
            document.getElementById('newContractName').value="";
            btn.innerHTML = t('btn_save'); btn.disabled = false;
        });
    }

    function openEditContractModal(contractId) {
        const contract = allContracts.find(c => c.id === contractId);
        if(!contract) return;
        document.getElementById('editContractId').value = contractId;
        document.getElementById('editContractName').value = contract.name;
        document.getElementById('editContractAuth').value = contract.supervisingAuthority || '';
        document.getElementById('editContractStart').value = contract.startDate || '';
        document.getElementById('editContractEnd').value = contract.endDate || '';
        document.getElementById('editContractModal').style.display = 'flex';
    }

    async function updateContract() {
        const id = document.getElementById('editContractId').value;
        const name = document.getElementById('editContractName').value;
        const auth = document.getElementById('editContractAuth').value;
        const start = document.getElementById('editContractStart').value;
        const end = document.getElementById('editContractEnd').value;
        if(!id || !name) return alert(t('msg_incomplete'));
        const btn = event.target; btn.innerHTML = "..."; btn.disabled = true;
        try {
            await db.collection("contracts").doc(id).update({ name: name, supervisingAuthority: auth, startDate: start, endDate: end });
            alert(t('msg_success_update')); document.getElementById('editContractModal').style.display='none';
        } catch(e) { alert("Error: " + e.message); } finally { btn.innerHTML = t('btn_update'); btn.disabled = false; }
    }

    function openAddSiteModal(preSelectedContractId = null) {
        const select = document.getElementById('contractSelect');
        select.innerHTML = `<option value="">${t('lbl_select_contract')}</option>`;
        allContracts.forEach(c => {
            const sel = preSelectedContractId === c.id ? 'selected' : '';
            select.innerHTML += `<option value="${c.id}" ${sel}>${c.name}</option>`;
        });
        document.getElementById('addSiteModal').style.display = 'flex';
    }

    function addSite() {
        const contractId = document.getElementById('contractSelect').value;
        const category = document.getElementById('newSiteCategory').value;
        const name = document.getElementById('newSiteName').value;
        const budget = Number(document.getElementById('newSiteBudget').value);
        if(!contractId || !name || !budget) return alert(t('msg_incomplete'));
        const btn = event.target; btn.innerHTML = "..."; btn.disabled = true;
        db.collection("budgets").add({
            contractId: contractId, category: category, itemName: name, totalAllocatedAmount: budget, currentBalance: budget,
            totalSpent: 0, totalProfit: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert(t('msg_success_add')); document.getElementById('addSiteModal').style.display='none';
            document.getElementById('newSiteName').value=""; document.getElementById('newSiteBudget').value="";
            btn.innerHTML = t('btn_save'); btn.disabled = false;
        });
    }

    function openEditSiteModal(siteId) {
        const site = allSites.find(s => s.id === siteId); if(!site) return;
        document.getElementById('editSiteId').value = siteId;
        document.getElementById('editSiteName').value = site.itemName;
        document.getElementById('editSiteBudget').value = site.totalAllocatedAmount;
        document.getElementById('editSiteCategory').value = site.category || 'spare_parts';
        const select = document.getElementById('editSiteContractSelect');
        select.innerHTML = `<option value="">${t('lbl_select_contract')}</option>`;
        allContracts.forEach(c => {
            const selected = site.contractId === c.id ? 'selected' : '';
            select.innerHTML += `<option value="${c.id}" ${selected}>${c.name}</option>`;
        });
        document.getElementById('editSiteModal').style.display = 'flex';
    }

    async function updateSite() {
        const siteId = document.getElementById('editSiteId').value;
        const contractId = document.getElementById('editSiteContractSelect').value;
        const category = document.getElementById('editSiteCategory').value;
        const name = document.getElementById('editSiteName').value;
        const budget = Number(document.getElementById('editSiteBudget').value);
        if(!siteId || !contractId || !name) return alert(t('msg_incomplete'));
        const btn = event.target; btn.innerHTML = "..."; btn.disabled = true;
        try {
            await db.collection('budgets').doc(siteId).update({ contractId: contractId, category: category, itemName: name, totalAllocatedAmount: budget });
            alert(t('msg_success_update')); document.getElementById('editSiteModal').style.display = 'none';
        } catch (e) { alert("Error: " + e.message); } finally { btn.innerHTML = t('btn_update'); btn.disabled = false; }
    }

    async function openUsersModal() {
        document.getElementById('usersModal').style.display = 'flex';
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center">...</td></tr>`;

        try {
            const usersSnap = await db.collection('users').orderBy('createdAt', 'desc').get();
            tbody.innerHTML = '';
            usersSnap.forEach(doc => {
                const u = doc.data();
                const userId = doc.id;
                
                let sitesOptions = `<option value="">${t('no_site')}</option>`;
                allContracts.forEach(contract => {
                    const contractSites = allSites.filter(s => s.contractId === contract.id);
                    if(contractSites.length > 0) {
                        sitesOptions += `<optgroup label="${contract.name}">`;
                        contractSites.forEach(site => {
                            const selected = u.assignedSiteId === site.id ? 'selected' : '';
                            const cat = t(site.category || 'spare_parts');
                            sitesOptions += `<option value="${site.id}" ${selected}>${site.itemName} (${cat})</option>`;
                        });
                        sitesOptions += `</optgroup>`;
                    }
                });
                
                const selUser = u.role === 'user' ? 'selected' : '';
                const selAdmin = u.role === 'admin' ? 'selected' : '';
                const selViewer = u.role === 'viewer' ? 'selected' : '';
                const selViewerPro = u.role === 'viewer_pro' ? 'selected' : '';

                const row = `
                <tr>
                    <td>${u.email}</td>
                    <td>
                        <select id="role-${userId}" style="padding: 6px; width: 100%; border:1px solid #ddd; border-radius:4px;">
                            <option value="user" ${selUser}>${t('role_user')}</option>
                            <option value="viewer" ${selViewer}>${t('role_viewer')}</option>
                            <option value="viewer_pro" ${selViewerPro}>${t('role_viewer_pro')}</option>
                            <option value="admin" ${selAdmin}>${t('role_admin')}</option>
                        </select>
                    </td>
                    <td><select id="site-${userId}" style="padding: 6px; width: 100%; border:1px solid #ddd; border-radius:4px;">${sitesOptions}</select></td>
                    <td><button onclick="saveUserChanges('${userId}')" class="btn btn-success" style="padding:5px 10px; font-size:0.9em;">${t('btn_save')}</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        } catch (e) { console.error(e); }
    }

    async function saveUserChanges(userId) {
        const newRole = document.getElementById(`role-${userId}`).value;
        const newSite = document.getElementById(`site-${userId}`).value;
        const btn = event.target; btn.innerText = "..."; btn.disabled = true;
        try {
            await db.collection('users').doc(userId).update({ role: newRole, assignedSiteId: newSite });
            alert(t('msg_success_update'));
        } catch (e) { alert("Error: " + e.message); } finally { btn.innerText = t('btn_save'); btn.disabled = false; }
    }

    async function recalculateAllProjects() {
       if(!confirm(t('msg_confirm_recalc'))) return;
       document.getElementById('loader').style.display = 'flex';
       try {
           const bs = await db.collection('budgets').get();
           const promises = bs.docs.map(async b => {
               const trans = await b.ref.collection('transactions').get();
               let p = 0, s = 0;
               trans.forEach(t => { s += Number(t.data().amountExclTax)||0; p += Number(t.data().companyProfit)||0; });
               return b.ref.update({ totalSpent: s, totalProfit: p, currentBalance: (b.data().totalAllocatedAmount||0) - s });
           });
           await Promise.all(promises); alert(t('msg_success_update'));
       } catch(e) { alert(e.message); } finally { document.getElementById('loader').style.display = 'none'; }
    }

    function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits: 2}); }
</script>
</body>
</html>
