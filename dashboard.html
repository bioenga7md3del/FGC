<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - FGC</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <div class="header-title-box">
            <img src="FGC.jpeg" alt="FGC Logo" class="logo-img">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
        </div>
        <button onclick="logout()" class="btn btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸ”’</button>
    </div>

    <div id="adminPanel" class="card" style="display:none; border-right: 5px solid var(--accent-gold); background: #fffdf5;">
        <h3 style="color: var(--primary-dark);">ğŸ‘‘ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h3>
        <div style="display: flex; gap: 15px; align-items: flex-end;">
            <div style="flex: 2;">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹/Ø§Ù„Ø¨Ù†Ø¯</label>
                <input type="text" id="newSiteName" placeholder="Ù…Ø«Ø§Ù„: ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©">
            </div>
            <div style="flex: 1;">
                <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</label>
                <input type="number" id="newSiteBudget" placeholder="Example: 500000">
            </div>
            <button onclick="addSite()" class="btn btn-warning" style="height: 53px;">Ø¥Ø¶Ø§ÙØ© +</button>
        </div>
    </div>

    <h3 style="margin-top: 30px; color: var(--primary-dark);">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¬Ø§Ø±ÙŠØ©:</h3>
    <div id="sitesGrid" class="stat-grid">
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>
</div>

<script>
    // --- Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ø§Ù„Ù…ØµØ­Ø­) ---
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                if(userData.role === 'admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    loadAllSites();
                } else {
                    loadMySite(userData.assignedSiteId || null);
                }
            } else {
                document.getElementById('sitesGrid').innerHTML = `<div class="card" style="text-align:center;"><p>Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</p></div>`;
            }
        } catch (error) { console.error(error); }
    });

    function loadAllSites() {
        db.collection("budgets").orderBy("createdAt", "desc").onSnapshot(snap => renderSites(snap.docs));
    }

    function loadMySite(siteId) {
        if(!siteId) {
            document.getElementById('sitesGrid').innerHTML = `<div class="card" style="text-align:center; padding:30px;"><h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h3><p style="color:var(--text-light);">Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…Ø´Ø±ÙˆØ¹ Ù„Ùƒ Ø¨Ø¹Ø¯.</p></div>`;
            return;
        }
        db.collection("budgets").doc(siteId).onSnapshot(doc => doc.exists ? renderSites([doc]) : document.getElementById('sitesGrid').innerHTML = "<p>Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>");
    }

    function renderSites(docs) {
        const container = document.getElementById('sitesGrid');
        container.innerHTML = "";
        if(docs.length === 0) { container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>"; return; }

        docs.forEach(doc => {
            const d = doc.data();
            const percent = d.totalAllocatedAmount ? (d.currentBalance / d.totalAllocatedAmount) * 100 : 0;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù†Ø³Ø¨Ø©
            const color = percent < 20 ? 'var(--danger)' : 'var(--success)';
            
            const html = `
            <div class="card" style="border-top: 4px solid var(--primary-light);">
                <h3 style="color: var(--primary-dark); margin-top:0;">ğŸ¢ ${d.itemName}</h3>
                <p style="font-size:0.95em; color:var(--text-light); margin-bottom:15px;">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: <strong>${Number(d.totalAllocatedAmount).toLocaleString('ar-EG')}</strong></p>
                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                    <span style="display:block; font-size:0.9em; color:var(--text-dark); margin-bottom:5px;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
                    <strong style="font-size:1.6em; color:${color}">${Number(d.currentBalance).toLocaleString('ar-EG')}</strong>
                </div>
                <a href="details.html?id=${doc.id}" class="btn btn-secondary" style="width:100%; justify-content: center;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ğŸ“‹</a>
            </div>`;
            container.innerHTML += html;
        });
    }

    function addSite() {
        const name = document.getElementById('newSiteName').value;
        const budget = Number(document.getElementById('newSiteBudget').value);
        if(!name || !budget) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©");
        
        db.collection("budgets").add({
            itemName: name, totalAllocatedAmount: budget, currentBalance: budget,
            totalSpent: 0, totalProfit: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); document.getElementById('newSiteName').value=""; document.getElementById('newSiteBudget').value=""; });
    }

    function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
</script>
</body>
</html>
