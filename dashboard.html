<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - FGC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        .project-group-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .project-header {
            background: #e9ecef;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: var(--primary);
            border-bottom: 1px solid #ddd;
        }
        .project-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            background: white;
            transition: 0.2s;
        }
        .project-item-row:last-child { border-bottom: none; }
        .project-item-row:hover { background: #fdfdfd; }
        
        .cat-indicator {
            display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 8px;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <h3 style="color: var(--primary); margin-top: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span style="font-size: 0.8rem; color: #888;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯</span>
            </div>
        </div>
        <button onclick="logout()" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</button>
    </nav>

    <div class="container">
        
        <div id="adminPanel" style="margin-bottom: 20px; display:none;">
            <div style="display: flex; gap: 15px;">
                <button onclick="document.getElementById('addContractModal').style.display='flex'" class="btn btn-primary" style="flex: 1; padding: 15px;">
                    <i class="fa-solid fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯
                </button>
                <button onclick="openUsersModal()" class="btn btn-outline" style="flex: 0.5;">
                    <i class="fa-solid fa-users-gear"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                </button>
            </div>
        </div>

        <h3 style="border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px; margin-bottom: 20px;">
            <i class="fa-solid fa-folder-tree"></i> Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø©
        </h3>
        
        <div id="contractsGrid">
            </div>
    </div>

    <div id="addContractModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('addContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="input-group">
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯ (Ù…Ø«Ø§Ù„: Ø¹Ù‚Ø¯ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶)</label>
                    <input type="text" id="newContractName">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©</label>
                    <input type="text" id="newContractAuth">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-box" style="flex:1;"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label><input type="date" id="newContractStart"></div>
                    <div class="input-box" style="flex:1;"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label><input type="date" id="newContractEnd"></div>
                </div>
                <button onclick="addContract()" class="btn-add">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</button>
            </div>
        </div>
    </div>

    <div id="addSiteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="document.getElementById('addSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h2>
            <p style="color:#666; font-size:0.9em;">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ 3 Ø¨Ù†ÙˆØ¯ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù‚Ø·Ø¹ ØºÙŠØ§Ø±ØŒ Ø¹Ù…Ø§Ù„Ø©ØŒ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†).</p>
            
            <input type="hidden" id="targetContractId">
            
            <div class="input-group">
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù…Ø«Ø§Ù„: Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ØªØ­Ø±Ùƒ)</label>
                    <input type="text" id="siteNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù‡Ù†Ø§...">
                </div>
                
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px dashed #ddd; margin-top:10px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--accent-orange);">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div class="input-box">
                            <label style="font-size:0.85em;">âš™ï¸ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</label>
                            <input type="number" id="budgetParts" placeholder="0">
                        </div>
                        <div class="input-box">
                            <label style="font-size:0.85em;">ğŸ‘· Ø¹Ù…Ø§Ù„Ø©</label>
                            <input type="number" id="budgetLabor" placeholder="0">
                        </div>
                        <div class="input-box">
                            <label style="font-size:0.85em;">ğŸ¤ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</label>
                            <input type="number" id="budgetSubs" placeholder="0">
                        </div>
                    </div>
                </div>

                <button onclick="addProjectGroup()" class="btn-add">Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <div class="table-container">
                <table style="width:100%">
                    <thead><tr><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØµØµ</th><th>Ø­ÙØ¸</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allContracts = [];
    let allSites = [];

    // --- ØªØ­Ù‚Ù‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ---
    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const role = userDoc.data().role;
            if (role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
                loadData(); 
            } else {
                 if(userDoc.data().assignedSiteId) window.location.href = "details.html?id=" + userDoc.data().assignedSiteId;
                 else { alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©."); window.location.href="index.html"; }
            }
        }
    });

    // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    function loadData() {
        db.collection("contracts").orderBy("createdAt", "desc").onSnapshot(contractSnap => {
            allContracts = [];
            contractSnap.forEach(doc => allContracts.push({ id: doc.id, ...doc.data() }));
            
            db.collection("budgets").onSnapshot(siteSnap => {
                allSites = [];
                siteSnap.forEach(doc => allSites.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        });
    }

    // --- Ø§Ù„Ø¹Ø±Ø¶ (Core Logic) ---
    function renderDashboard() {
        const container = document.getElementById('contractsGrid');
        container.innerHTML = "";

        allContracts.forEach(contract => {
            // 1. ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¹Ù‚Ø¯ Ø¯Ù‡
            const contractItems = allSites.filter(site => site.contractId === contract.id);
            
            // 2. Ø§Ù„ØªØ¬Ù…ÙŠØ¹: ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (itemName)
            // Ø§Ù„Ù†Ø§ØªØ¬ Ù‡ÙŠÙƒÙˆÙ†: object Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨ØªØ§Ø¹Ù‡ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ù…ØµÙÙˆÙØ© ÙÙŠÙ‡Ø§ Ø§Ù„ 3 Ø¨Ù†ÙˆØ¯
            const projectsGrouped = {};
            contractItems.forEach(item => {
                const name = item.itemName; // Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ØªØ­Ø±Ùƒ
                if(!projectsGrouped[name]) projectsGrouped[name] = [];
                projectsGrouped[name].push(item);
            });

            // Ø­Ø³Ø§Ø¨ Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù„Ø¹Ø±Ø¶
            const totalContractBudget = contractItems.reduce((sum, i) => sum + (i.totalAllocatedAmount||0), 0);

            let projectsHTML = "";
            const projectNames = Object.keys(projectsGrouped);

            if (projectNames.length === 0) {
                projectsHTML = `<div style="text-align:center; padding:15px; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¶Ø§ÙØ©.</div>`;
            } else {
                // Ù„ÙˆØ¨ Ø¹Ù„Ù‰ ÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹ (Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ØªØ­Ø±ÙƒØŒ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ØŒ Ø§Ù„Ø®)
                projectNames.forEach(projName => {
                    const items = projectsGrouped[projName]; // Ø¯ÙˆÙ„ Ø§Ù„ 3 Ø¨Ù†ÙˆØ¯ (Ù‚Ø·Ø¹ ØºÙŠØ§Ø±ØŒ Ø¹Ù…Ø§Ù„Ø©ØŒ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†)
                    
                    // ØªÙˆÙ„ÙŠØ¯ ØµÙÙˆÙ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø«Ù„Ø§Ø«Ø©
                    let itemsRows = "";
                    
                    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶: Ù‚Ø·Ø¹ ØºÙŠØ§Ø±ØŒ Ø¹Ù…Ø§Ù„Ø©ØŒ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†
                    const sortOrder = ['spare_parts', 'labor', 'subcontractors'];
                    items.sort((a, b) => sortOrder.indexOf(a.category) - sortOrder.indexOf(b.category));

                    items.forEach(item => {
                        const cat = getCatDetails(item.category);
                        itemsRows += `
                        <div class="project-item-row">
                            <div style="flex:1; display:flex; align-items:center;">
                                <span class="cat-indicator" style="background:${cat.color}"></span>
                                <span style="margin-right:10px; font-size:0.9em;">${cat.text}</span>
                            </div>
                            <div style="flex:1; font-size:0.9em; color:#555;">
                                Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: <b>${fmt(item.totalAllocatedAmount)}</b>
                            </div>
                            <div style="flex:1; font-size:0.9em; color:#555;">
                                Ø§Ù„Ù…ØµØ±ÙˆÙ: <b style="color:var(--danger)">${fmt(item.totalSpent)}</b>
                            </div>
                            <div>
                                <a href="details.html?id=${item.id}" class="btn btn-outline" style="padding:4px 10px; font-size:0.8em; text-decoration:none;">Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                            </div>
                        </div>`;
                    });

                    projectsHTML += `
                    <div class="project-group-card">
                        <div class="project-header">
                            <span><i class="fa-solid fa-layer-group"></i> ${projName}</span>
                            <button onclick="deleteProjectGroup('${contract.id}', '${projName}')" class="btn btn-danger" style="padding:4px 10px; font-size:0.8em;" title="Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
                                <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                            </button>
                        </div>
                        <div>${itemsRows}</div>
                    </div>`;
                });
            }

            // ÙƒØ§Ø±Øª Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            const contractHTML = `
            <div class="contract-card">
                <div class="contract-header" onclick="toggleContract('${contract.id}')">
                    <div style="flex:1;">
                        <div class="contract-title">
                            <i class="fa-solid fa-file-contract"></i> ${contract.name}
                        </div>
                        <small style="color:#666;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(totalContractBudget)} | Ø§Ù„Ø¬Ù‡Ø©: ${contract.supervisingAuthority}</small>
                    </div>
                    <div class="contract-actions" onclick="event.stopPropagation()">
                        <a href="contract-details.html?id=${contract.id}" class="btn-outline" style="padding:5px 10px; text-decoration:none; margin-left:5px;">
                            <i class="fa-solid fa-chart-pie"></i> ØªÙ‚Ø±ÙŠØ±
                        </a>
                        <button onclick="deleteContract('${contract.id}', '${contract.name}')" class="btn btn-danger" style="padding:5px 10px;" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <i id="icon-${contract.id}" class="fa-solid fa-chevron-down" style="margin-right:10px; color:#aaa;"></i>
                    </div>
                </div>
                <div id="body-${contract.id}" class="sites-container">
                    ${projectsHTML}
                    <div style="text-align:center; margin-top:10px;">
                        <button onclick="openAddSiteModal('${contract.id}')" class="btn btn-warning" style="width:100%;">
                            <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            </div>`;
            
            container.innerHTML += contractHTML;
        });
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© ---

    // 1. Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ (3 Ø¨Ù†ÙˆØ¯)
    function openAddSiteModal(contractId) {
        document.getElementById('targetContractId').value = contractId;
        document.getElementById('siteNameInput').value = "";
        document.getElementById('budgetParts').value = "";
        document.getElementById('budgetLabor').value = "";
        document.getElementById('budgetSubs').value = "";
        document.getElementById('addSiteModal').style.display = 'flex';
    }

    async function addProjectGroup() {
        const contractId = document.getElementById('targetContractId').value;
        const name = document.getElementById('siteNameInput').value;
        const bParts = Number(document.getElementById('budgetParts').value);
        const bLabor = Number(document.getElementById('budgetLabor').value);
        const bSubs = Number(document.getElementById('budgetSubs').value);

        if(!name) return alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø·Ù„ÙˆØ¨");

        const btn = event.target; btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
        const batch = db.batch();

        // Ø¥Ù†Ø´Ø§Ø¡ 3 ÙˆØ«Ø§Ø¦Ù‚ (Ø¨Ù†ÙˆØ¯)
        createBudgetItem(batch, contractId, name, 'spare_parts', bParts);
        createBudgetItem(batch, contractId, name, 'labor', bLabor);
        createBudgetItem(batch, contractId, name, 'subcontractors', bSubs);

        try {
            await batch.commit();
            document.getElementById('addSiteModal').style.display = 'none';
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ¨Ù†ÙˆØ¯Ù‡ Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­");
        } catch(e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
        } finally {
            btn.disabled = false; btn.innerText = "Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹";
        }
    }

    function createBudgetItem(batch, contractId, name, cat, amount) {
        const ref = db.collection('budgets').doc();
        batch.set(ref, {
            contractId: contractId,
            itemName: name, // Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ù…Ø´Ø±ÙˆØ¹
            category: cat,
            totalAllocatedAmount: amount || 0,
            currentBalance: amount || 0,
            totalSpent: 0, totalProfit: 0, createdAt: new Date()
        });
    }

    // 2. Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯
    function addContract() {
        const name = document.getElementById('newContractName').value;
        const auth = document.getElementById('newContractAuth').value;
        const start = document.getElementById('newContractStart').value;
        const end = document.getElementById('newContractEnd').value;
        
        if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
        
        db.collection("contracts").add({
            name: name, supervisingAuthority: auth, startDate: start, endDate: end, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById('addContractModal').style.display='none';
        });
    }

    // 3. Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø­Ø°Ù Ø§Ù„ 3 Ø¨Ù†ÙˆØ¯)
    async function deleteProjectGroup(contractId, projectName) {
        if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: (${projectName})ØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù (Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±ØŒ Ø§Ù„Ø¹Ù…Ø§Ù„Ø©ØŒ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†) Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡.`)) return;

        // Ù†Ø¬ÙŠØ¨ ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù„ÙŠ ØªØ¨Ø¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø¯Ù‡ ÙˆØ§Ø³Ù…Ù‡Ø§ Ù†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        const snap = await db.collection('budgets')
            .where('contractId', '==', contractId)
            .where('itemName', '==', projectName)
            .get();

        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));

        try {
            await batch.commit();
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");
        } catch(e) { alert(e.message); }
    }

    // 4. Ø­Ø°Ù Ø¹Ù‚Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    async function deleteContract(contractId, name) {
        if(!confirm(`ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±!\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ (${name}) ÙˆÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;
        
        const batch = db.batch();
        
        // Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯
        batch.delete(db.collection('contracts').doc(contractId));
        
        // Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        const snap = await db.collection('budgets').where('contractId', '==', contractId).get();
        snap.forEach(doc => batch.delete(doc.ref));

        try {
            await batch.commit();
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­.");
        } catch(e) { alert(e.message); }
    }

    // --- Helpers ---
    function getCatDetails(cat) {
        if(cat === 'labor') return {text: 'Ø¹Ù…Ø§Ù„Ø©', color: '#e67e22'};
        if(cat === 'subcontractors') return {text: 'Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø¨Ø§Ø·Ù†', color: '#6c757d'};
        return {text: 'Ù‚Ø·Ø¹ ØºÙŠØ§Ø±', color: '#1a3c6d'};
    }
    function toggleContract(id) {
        const el = document.getElementById(`body-${id}`);
        const icon = document.getElementById(`icon-${id}`);
        if(el.style.display === 'block') { el.style.display='none'; icon.classList.replace('fa-chevron-up','fa-chevron-down'); }
        else { el.style.display='block'; el.classList.add('open'); icon.classList.replace('fa-chevron-down','fa-chevron-up'); }
    }
    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG'); }
    function logout() { auth.signOut().then(() => window.location.href = "index.html"); }

    // --- Users (Code Kept Brief for Logic) ---
    async function openUsersModal() {
        document.getElementById('usersModal').style.display='flex';
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="4">ØªØ­Ù…ÙŠÙ„...</td></tr>';
        const snaps = await db.collection('users').get();
        tbody.innerHTML = '';
        snaps.forEach(doc => {
            const u = doc.data();
            // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù‡Ù†Ø§ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
            tbody.innerHTML += `<tr><td>${u.email}</td><td>${u.role}</td><td>-</td><td>-</td></tr>`; 
        });
    }
</script>
</body>
</html>
