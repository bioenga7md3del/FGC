<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - FGC Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body> 

    <div id="loader">
        <div class="loader-spinner"></div>
        <h3 style="color: var(--primary); margin-top: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h3>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span style="font-size: 0.8rem; color: #888;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
            </div>
        </div>
        <button onclick="logout()" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</button>
    </nav>

    <div class="container">
        
        <div id="adminPanel" class="admin-panel">
            <h3 style="margin-top: 0; color: var(--primary);">ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex: 1;">
                     <button onclick="openUsersModal()" class="btn-users">
                        <i class="fa-solid fa-users-gear"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                    </button>
                </div>
                <div style="flex: 1;">
                    <button onclick="recalculateAllProjects()" class="btn-sync">
                        <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ« ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø±ØµØ¯Ø©
                    </button>
                </div>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ddd;">

            <div class="input-group">
                <div class="input-box" style="flex: 2;">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                    <input type="text" id="newSiteName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</label>
                    <input type="number" id="newSiteBudget" placeholder="500000">
                </div>
                <button onclick="addSite()" class="btn-add">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>

        <h3 style="margin-bottom: 20px;">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</h3>
        <div id="sitesGrid" class="projects-grid">
            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h2>
            <p style="color: #666; font-size: 0.9em;">
                Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø£Ùˆ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø­ÙØ¸" Ø¨Ø¬Ø§Ù†Ø¨ ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù….
                <br>
                <small>* Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù†Ù‡ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø± ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù…Ù‡ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</small>
            </p>
            
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                            <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Role)</th>
                            <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®ØµØµ (Site)</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // ... (Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙƒÙ…Ø§ Ù‡ÙˆØŒ Ø§Ù†Ø³Ø®Ù‡ Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… dashboard.html ÙˆØ¶Ø¹Ù‡ Ù‡Ù†Ø§) ...
    // ... (Ù„Ù… Ø£Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ø­ÙØ§Ø¸Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø­Ø©ØŒ ÙÙ‚Ø· Ø§Ù„Ù€ HTML ÙˆØ§Ù„Ù€ CSS ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ù…) ...
    
    // ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø® Ø§Ù„Ù€ Script Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… dashboard.html ÙˆÙ„ØµÙ‚Ù‡ Ù‡Ù†Ø§ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ body
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allBudgets = []; 

    auth.onAuthStateChanged(async user => {
        if(!user) { window.location.href = "index.html"; return; }
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            if(userData.role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                loadAllSites();
                loadBudgetsForDropdown(); 
            } else {
                loadMySite(userData.assignedSiteId);
            }
        }
    });

    function loadBudgetsForDropdown() {
        db.collection('budgets').onSnapshot(snapshot => {
            allBudgets = [];
            snapshot.forEach(doc => {
                allBudgets.push({ id: doc.id, name: doc.data().itemName });
            });
        });
    }

    async function openUsersModal() {
        document.getElementById('usersModal').style.display = 'flex';
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</td></tr>';

        try {
            const usersSnap = await db.collection('users').orderBy('createdAt', 'desc').get();
            tbody.innerHTML = '';

            usersSnap.forEach(doc => {
                const u = doc.data();
                const userId = doc.id;
                
                let sitesOptions = `<option value="">-- Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø±ÙˆØ¹ --</option>`;
                allBudgets.forEach(site => {
                    const selected = u.assignedSiteId === site.id ? 'selected' : '';
                    sitesOptions += `<option value="${site.id}" ${selected}>${site.name}</option>`;
                });

                const roleUserSel = u.role === 'user' ? 'selected' : '';
                const roleAdminSel = u.role === 'admin' ? 'selected' : '';

                const row = `
                <tr>
                    <td>${u.email} <br> <small style="color:#999">${userId.substring(0,5)}...</small></td>
                    <td>
                        <select id="role-${userId}" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; width: 100%;">
                            <option value="user" ${roleUserSel}>Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                            <option value="admin" ${roleAdminSel}>Ù…Ø¯ÙŠØ± (Admin)</option>
                        </select>
                    </td>
                    <td>
                        <select id="site-${userId}" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; width: 100%;">
                            ${sitesOptions}
                        </select>
                    </td>
                    <td>
                        <button onclick="saveUserChanges('${userId}')" class="save-user-btn">
                            <i class="fa-solid fa-save"></i> Ø­ÙØ¸
                        </button>
                    </td>
                </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="4" style="color:red">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
        }
    }

    async function saveUserChanges(userId) {
        const newRole = document.getElementById(`role-${userId}`).value;
        const newSite = document.getElementById(`site-${userId}`).value;
        
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '...';
        btn.disabled = true;

        try {
            await db.collection('users').doc(userId).update({
                role: newRole,
                assignedSiteId: newSite
            });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
        } catch (e) {
            alert("Ø®Ø·Ø£: " + e.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function loadAllSites() {
        db.collection("budgets").orderBy("createdAt", "desc").onSnapshot(snap => renderSites(snap.docs));
    }

    function loadMySite(siteId) {
        if(!siteId) return document.getElementById('sitesGrid').innerHTML = "<p>Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…Ø´Ø±ÙˆØ¹ Ù„Ùƒ.</p>";
        db.collection("budgets").doc(siteId).onSnapshot(doc => {
            if(doc.exists) renderSites([doc]);
            else document.getElementById('sitesGrid').innerHTML = "<p>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>";
        });
    }

    function renderSites(docs) {
        const container = document.getElementById('sitesGrid');
        container.innerHTML = "";
        if(docs.length === 0) return container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹.</p>";

        docs.forEach(doc => {
            const d = doc.data();
            const percent = d.totalAllocatedAmount ? (d.currentBalance / d.totalAllocatedAmount) * 100 : 0;
            const balanceColor = percent < 20 ? 'var(--danger)' : 'var(--success)';
            const profit = d.totalProfit || 0;
            const spent = d.totalSpent || 0;

            const html = `
            <div class="project-card">
                <div class="card-header">
                    <h3>${d.itemName}</h3>
                    <div class="icon-box"><i class="fa-solid fa-building"></i></div>
                </div>
                <div class="card-body">
                    <div class="stat-row">
                        <div class="stat-item"><label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</label><br><b>${fmt(d.totalAllocatedAmount)}</b></div>
                        <div class="stat-item"><label>Ø§Ù„Ù…ØµØ±ÙˆÙ</label><br><b style="color:var(--danger)">${fmt(spent)}</b></div>
                    </div>
                    <div class="profit-badge"><label>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ø±ÙƒØ©</label><br><b>${fmt(profit)} Ø±ÙŠØ§Ù„</b></div>
                    <div style="text-align: center;"><span style="color:#888; font-size:0.9em">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span><div style="font-size:1.8em; font-weight:800; color:${balanceColor}">${fmt(d.currentBalance)}</div></div>
                </div>
                <div class="card-footer"><a href="details.html?id=${doc.id}" class="btn-view">Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</a></div>
            </div>`;
            container.innerHTML += html;
        });
    }

    function addSite() {
        const name = document.getElementById('newSiteName').value;
        const budget = Number(document.getElementById('newSiteBudget').value);
        if(!name || !budget) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        db.collection("budgets").add({
            itemName: name, totalAllocatedAmount: budget, currentBalance: budget, totalSpent: 0, totalProfit: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { alert("ØªÙ…"); document.getElementById('newSiteName').value=""; document.getElementById('newSiteBudget').value=""; });
    }

    async function recalculateAllProjects() {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±ØµØ¯Ø©ØŸ")) return;
        document.getElementById('loader').style.display = 'flex';
        try {
            const budgets = await db.collection('budgets').get();
            const promises = budgets.docs.map(async b => {
                const trans = await b.ref.collection('transactions').get();
                let p = 0, s = 0;
                trans.forEach(t => { s += Number(t.data().amountExclTax)||0; p += Number(t.data().companyProfit)||0; });
                return b.ref.update({ totalSpent: s, totalProfit: p, currentBalance: (b.data().totalAllocatedAmount||0) - s });
            });
            await Promise.all(promises);
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!");
        } catch(e) { alert("Ø®Ø·Ø£: " + e.message); } 
        finally { document.getElementById('loader').style.display = 'none'; }
    }

    function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits: 2}); }
</script>
</body>
</html>
