<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© - FGC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #1e3a8a;      
            --primary-light: #3b82f6;
            --accent: #f59e0b;       
            --accent-hover: #d97706;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #10b981;
            --bg-body: #f3f4f6;      
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            margin: 0; padding: 0;
            direction: rtl; color: var(--text-main);
        }

        /* --- Navbar --- */
        .navbar {
            background: var(--bg-card);
            padding: 15px 5%;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }
        .nav-brand { display: flex; align-items: center; gap: 15px; }
        .nav-brand img { height: 45px; }
        .nav-brand h2 { margin: 0; color: var(--primary); font-size: 1.2rem; font-weight: 800; }
        
        .btn-logout {
            background: #fee2e2; color: var(--danger); border: none;
            padding: 8px 16px; border-radius: 50px; font-weight: bold;
            font-family: 'Tajawal'; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .btn-logout:hover { background: #fecaca; }

        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }

        /* --- Welcome Section --- */
        .welcome-section { margin-bottom: 30px; }
        .welcome-section h2 { color: var(--primary); margin: 0; font-size: 1.8rem; }
        .welcome-section p { color: var(--text-secondary); margin-top: 5px; }

        /* --- Admin Grid (Quick Actions) --- */
        .admin-panel { display: none; margin-bottom: 50px; } 
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .action-card {
            background: var(--bg-card); padding: 25px;
            border-radius: var(--radius); box-shadow: var(--shadow-md);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; transition: all 0.3s ease;
            border: 1px solid transparent; position: relative; overflow: hidden;
        }
        .action-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .action-card.primary { border-bottom: 4px solid var(--primary); }
        .action-card.accent { border-bottom: 4px solid var(--accent); }

        .action-card i {
            font-size: 2rem; margin-bottom: 15px; padding: 15px; border-radius: 50%;
        }
        .action-card.primary i { background: #eff6ff; color: var(--primary); }
        .action-card.accent i { background: #fffbeb; color: var(--accent); }
        .action-card span { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }

        /* --- Contracts Section --- */
        .section-title {
            font-size: 1.4rem; color: var(--primary); margin-bottom: 25px;
            display: flex; align-items: center; gap: 10px;
            border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;
        }

        .contracts-container { display: flex; flex-direction: column; gap: 20px; }

        .contract-card {
            background: var(--bg-card); border-radius: var(--radius);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
            overflow: hidden; transition: 0.3s; position: relative;
        }
        .contract-card:hover { box-shadow: var(--shadow-md); border-color: var(--primary-light); }
        .contract-card::before {
            content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 6px; background: var(--primary);
        }

        .contract-header {
            padding: 25px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; background: #fff;
        }
        .contract-info { display: flex; flex-direction: column; gap: 10px; margin-right: 15px; flex: 1; }
        
        .contract-title { font-size: 1.3rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .contract-meta-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .meta-badge {
            display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem;
            background: #f8fafc; color: var(--text-secondary); padding: 6px 12px;
            border-radius: 8px; border: 1px solid #e2e8f0;
        }
        .meta-badge i { color: var(--accent); }
        .meta-badge.highlight { background: #eff6ff; color: var(--primary); border-color: #bfdbfe; font-weight: bold; }

        .contract-actions { display: flex; gap: 8px; align-items: center; }
        
        .btn-icon {
            width: 38px; height: 38px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border-color); background: white;
            color: var(--text-secondary); transition: 0.2s; cursor: pointer; text-decoration: none;
        }
        .btn-icon:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-icon.chart:hover { background: var(--accent); border-color: var(--accent); }
        
        /* Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .btn-icon.delete:hover { background: var(--danger); border-color: var(--danger); color: white; }
        
        .btn-icon.toggle { border: none; background: transparent; font-size: 1.2rem; }

        /* --- Sites Inside Contract --- */
        .sites-container { background: #f9fafb; border-top: 1px solid var(--border-color); padding: 25px; display: none; }
        .sites-container.open { display: block; animation: fadeIn 0.3s; }

        .site-mini-card {
            background: white; border-radius: 12px; padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; transition: 0.2s;
        }
        .site-mini-card:hover { transform: translateX(-5px); border-color: var(--primary-light); }
        
        .site-main-info h4 { margin: 0 0 5px 0; color: var(--text-main); font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .site-sub-info { font-size: 0.85rem; color: var(--text-secondary); display: flex; gap: 15px; }
        
        .cat-badge { font-size: 0.7em; padding: 3px 8px; border-radius: 6px; color: white; vertical-align: middle; }
        .cat-spare { background: var(--primary); }
        .cat-labor { background: var(--accent); }
        .cat-sub { background: #6b7280; }

        .btn-small {
            font-size: 0.8em; padding: 6px 12px; border-radius: 6px; text-decoration: none;
            display: inline-block; cursor: pointer; border: 1px solid; transition: 0.2s;
        }
        .btn-view { border-color: var(--primary); color: var(--primary); background: transparent; }
        .btn-view:hover { background: var(--primary); color: white; }
        .btn-edit { border-color: #d1d5db; color: #6b7280; background: white; margin-right: 5px; }
        .btn-edit:hover { border-color: var(--primary); color: var(--primary); }
        
        /* Ø²Ø± Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµØºÙŠØ± */
        .btn-delete-sm { border-color: #fca5a5; color: #ef4444; background: white; margin-right: 5px; }
        .btn-delete-sm:hover { background: #ef4444; color: white; border-color: #ef4444; }

        .btn-add-site {
            background: var(--accent); color: white; border: none; padding: 10px 25px;
            border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-add-site:hover { background: var(--accent-hover); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 58, 138, 0.2); backdrop-filter: blur(4px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative;
        }
        .close-modal { position: absolute; left: 20px; top: 20px; font-size: 24px; cursor: pointer; color: #999; }
        
        .input-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .input-box label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: var(--primary); }
        .input-box input, .input-box select {
            width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px;
            background: #f9fafb; font-family: 'Tajawal'; box-sizing: border-box; transition: 0.3s;
        }
        .input-box input:focus, .input-box select:focus {
            border-color: var(--primary); background: white; outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn-save {
            background: var(--primary); color: white; border: none; padding: 14px;
            border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;
        }
        .btn-save:hover { background: #1e40af; }

        /* Users Table in Modal */
        .users-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .users-table th { text-align: right; color: var(--text-secondary); font-size: 0.85rem; padding: 10px; border-bottom: 2px solid #eee; }
        .users-table td { padding: 12px 10px; border-bottom: 1px solid #f3f4f6; }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loader-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <h4 style="color: var(--primary); margin-top: 15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h4>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="FGC.jpeg" alt="Logo">
            <div>
                <h2>FGC Dashboard</h2>
                <span style="font-size: 0.8rem; color: #888;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
            </div>
        </div>
        <button onclick="logout()" class="btn-logout">
            <i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬
        </button>
    </nav>

    <div class="container">
        
        <div class="welcome-section">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ù‡Ù†Ø§.</p>
        </div>

        <div id="adminPanel" class="admin-panel">
            <div class="actions-grid">
                <div onclick="openUsersModal()" class="action-card primary">
                    <i class="fa-solid fa-users-gear"></i>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                </div>

                <div onclick="recalculateAllProjects()" class="action-card primary">
                    <i class="fa-solid fa-rotate"></i>
                    <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø©</span>
                </div>

                <div onclick="document.getElementById('addContractModal').style.display='flex'" class="action-card accent">
                    <i class="fa-solid fa-file-contract"></i>
                    <span>Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</span>
                </div>

                <div onclick="openAddSiteModal()" class="action-card accent">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <span>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ / Ø¨Ù†Ø¯</span>
                </div>
            </div>
        </div>

        <h3 class="section-title">
            <i class="fa-solid fa-folder-open"></i> Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¬Ø§Ø±ÙŠØ©
        </h3>
        
        <div id="contractsGrid" class="contracts-container">
            <p style="text-align:center; color:#888;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯...</p>
        </div>
    </div>

    <div id="addContractModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('addContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="input-group">
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯ (Ù…Ø«Ø§Ù„: Ø¹Ù‚Ø¯ Ù…Ù†Ø·Ù‚Ø© ØªØ¨ÙˆÙƒ)</label>
                    <input type="text" id="newContractName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯...">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ© (Ù…Ø«Ø§Ù„: ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©)</label>
                    <input type="text" id="newContractAuth" placeholder="Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©...">
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="input-box" style="flex:1;">
                        <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
                        <input type="date" id="newContractStart">
                    </div>
                    <div class="input-box" style="flex:1;">
                        <label>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
                        <input type="date" id="newContractEnd">
                    </div>
                </div>
                <p style="font-size:0.8em; color:#888;">* Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø¹Ù‚Ø¯ ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ù†ÙˆØ¯.</p>
                <button onclick="addContract()" class="btn-save">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</button>
            </div>
        </div>
    </div>

    <div id="editContractModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('editContractModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</h2>
            <input type="hidden" id="editContractId">
            <div class="input-group">
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯</label>
                    <input type="text" id="editContractName">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©</label>
                    <input type="text" id="editContractAuth">
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="input-box" style="flex:1;">
                        <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
                        <input type="date" id="editContractStart">
                    </div>
                    <div class="input-box" style="flex:1;">
                        <label>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
                        <input type="date" id="editContractEnd">
                    </div>
                </div>
                <button onclick="updateContract()" class="btn-save">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="addSiteModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('addSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù„Ù„Ø¹Ù‚Ø¯</h2>
            <div class="input-group">
                <div class="input-box">
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡</label>
                    <select id="contractSelect">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                </div>
                <div class="input-box">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
                    <select id="newSiteCategory" style="font-weight:bold;">
                        <option value="spare_parts" selected>âš™ï¸ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
                        <option value="labor">ğŸ‘· Ø¹Ù…Ø§Ù„Ø©</option>
                        <option value="subcontractors">ğŸ¤ Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø¨Ø§Ø·Ù†</option>
                    </select>
                </div>
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                    <input type="text" id="newSiteName" placeholder="Ø§Ù„Ø§Ø³Ù…...">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</label>
                    <input type="number" id="newSiteBudget" placeholder="0">
                </div>
                <button onclick="addSite()" class="btn-save">Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯</button>
            </div>
        </div>
    </div>

    <div id="editSiteModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('editSiteModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ø¯</h2>
            <input type="hidden" id="editSiteId">
            <div class="input-group">
                <div class="input-box">
                    <label>Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡</label>
                    <select id="editSiteContractSelect" style="background: #fffbeb;"></select>
                </div>
                <div class="input-box">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
                    <select id="editSiteCategory">
                        <option value="spare_parts">âš™ï¸ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
                        <option value="labor">ğŸ‘· Ø¹Ù…Ø§Ù„Ø©</option>
                        <option value="subcontractors">ğŸ¤ Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø¨Ø§Ø·Ù†</option>
                    </select>
                </div>
                <div class="input-box">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                    <input type="text" id="editSiteName">
                </div>
                <div class="input-box">
                    <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</label>
                    <input type="number" id="editSiteBudget">
                </div>
                <button onclick="updateSite()" class="btn-save">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-modal" onclick="document.getElementById('usersModal').style.display='none'">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <div style="overflow-x: auto;">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø­ÙØ¸</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allContracts = [];
        let allSites = [];

        const categoryLabels = {
            'spare_parts': { text: 'Ù‚Ø·Ø¹ ØºÙŠØ§Ø±', icon: 'fa-cogs', class: 'cat-spare' },
            'labor': { text: 'Ø¹Ù…Ø§Ù„Ø©', icon: 'fa-hard-hat', class: 'cat-labor' },
            'subcontractors': { text: 'Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø¨Ø§Ø·Ù†', icon: 'fa-handshake', class: 'cat-sub' }
        };

        // Auth Check
        auth.onAuthStateChanged(async user => {
            document.getElementById('loader').style.display = 'none'; // Hide loader
            if(!user) { window.location.href = "index.html"; return; }
            
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                if(userData.role === 'admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    loadData(); 
                } else {
                    if(userData.assignedSiteId) window.location.href = "details.html?id=" + userData.assignedSiteId;
                    else document.getElementById('contractsGrid').innerHTML = "<p style='text-align:center; padding:20px;'>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„.</p>";
                }
            }
        });

        // Load Data
        function loadData() {
            db.collection("contracts").orderBy("createdAt", "desc").onSnapshot(contractSnap => {
                allContracts = [];
                contractSnap.forEach(doc => allContracts.push({ id: doc.id, ...doc.data() }));
                
                db.collection("budgets").onSnapshot(siteSnap => {
                    allSites = [];
                    siteSnap.forEach(doc => allSites.push({ id: doc.id, ...doc.data() }));
                    renderDashboard();
                });
            });
        }

        // Render Dashboard
        function renderDashboard() {
            const container = document.getElementById('contractsGrid');
            container.innerHTML = "";

            if (allContracts.length === 0 && allSites.length > 0) {
                renderContractCard({ id: 'legacy', name: 'Ø¹Ù‚ÙˆØ¯ Ø£Ø®Ø±Ù‰ / ØºÙŠØ± Ù…ØµÙ†ÙØ©', totalValue: 0 }, allSites, container);
                return;
            }

            if (allContracts.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#888; padding:30px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯.</p>";
                return;
            }

            allContracts.forEach(contract => {
                const contractSites = allSites.filter(site => site.contractId === contract.id);
                renderContractCard(contract, contractSites, container);
            });

            const orphanSites = allSites.filter(site => !site.contractId);
            if (orphanSites.length > 0) {
                renderContractCard({ id: 'orphans', name: 'Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù‚Ø¯', totalValue: 0 }, orphanSites, container, true);
            }
        }

        // Render Single Contract Card (Modern Design)
        function renderContractCard(contract, sites, container, isOrphan = false) {
            const allocatedTotal = sites.reduce((sum, s) => sum + (s.totalAllocatedAmount || 0), 0);
            const spentTotal = sites.reduce((sum, s) => sum + (s.totalSpent || 0), 0);
            
            let sitesHTML = "";
            if (sites.length === 0) {
                sitesHTML = `<div style="text-align:center; color:#9ca3af; padding:15px; font-size:0.9em;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ø¯.</div>`;
            } else {
                sites.forEach(site => {
                    const percent = site.totalAllocatedAmount ? (site.currentBalance / site.totalAllocatedAmount) * 100 : 0;
                    const balanceColor = percent < 20 ? 'var(--danger)' : 'var(--success)';
                    const catKey = site.category || 'spare_parts';
                    const catInfo = categoryLabels[catKey] || categoryLabels['spare_parts'];

                    sitesHTML += `
                    <div class="site-mini-card">
                        <div class="site-main-info">
                            <h4>
                                <span class="cat-badge ${catInfo.class}"><i class="fa-solid ${catInfo.icon}"></i> ${catInfo.text}</span>
                                ${site.itemName}
                            </h4>
                            <div class="site-sub-info">
                                <span><i class="fa-solid fa-coins"></i> ${fmt(site.totalAllocatedAmount)}</span>
                                <span><i class="fa-solid fa-arrow-trend-down"></i> <span style="color:var(--danger)">${fmt(site.totalSpent)}</span></span>
                            </div>
                        </div>
                        <div style="text-align:left;">
                            <div style="font-weight:bold; color:${balanceColor}; margin-bottom:5px;">${fmt(site.currentBalance)}</div>
                            <div>
                                <button onclick="openEditSiteModal('${site.id}')" class="btn-small btn-edit" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteSite('${site.id}')" class="btn-small btn-delete-sm" title="Ø­Ø°Ù"><i class="fa-solid fa-trash"></i></button>
                                <a href="details.html?id=${site.id}" class="btn-small btn-view">Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                            </div>
                        </div>
                    </div>
                    `;
                });
            }

            const authority = contract.supervisingAuthority || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const dateRange = (contract.startDate || contract.endDate) ? `${contract.startDate || '--'} / ${contract.endDate || '--'}` : '-- / --';
            const orphanStyle = isOrphan ? 'border-left: 5px solid var(--danger);' : '';

            const html = `
            <div class="contract-card" style="${orphanStyle}">
                <div class="contract-header" onclick="toggleSites('${contract.id}')">
                    <div class="contract-info">
                        <div class="contract-title">
                            <i class="fa-solid ${isOrphan ? 'fa-triangle-exclamation' : 'fa-file-signature'}"></i>
                            ${contract.name}
                        </div>
                        <div class="contract-meta-row">
                            <span class="meta-badge"><i class="fa-solid fa-building-columns"></i> ${authority}</span>
                            <span class="meta-badge"><i class="fa-regular fa-calendar"></i> ${dateRange}</span>
                            <span class="meta-badge highlight"><i class="fa-solid fa-calculator"></i> ${fmt(allocatedTotal)}</span>
                            <span class="meta-badge"><i class="fa-solid fa-chart-pie"></i> ${fmt(spentTotal)}</span>
                        </div>
                    </div>
                    <div class="contract-actions">
                        ${!isOrphan ? `
                            <a href="contract-details.html?id=${contract.id}" onclick="event.stopPropagation();" class="btn-icon chart" title="ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯"><i class="fa-solid fa-chart-pie"></i></a>
                            <div onclick="openEditContractModal('${contract.id}'); event.stopPropagation();" class="btn-icon" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fa-solid fa-pen"></i></div>
                            <div onclick="deleteContract('${contract.id}'); event.stopPropagation();" class="btn-icon delete" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯"><i class="fa-solid fa-trash"></i></div>
                        ` : ''}
                        <button class="btn-icon toggle"><i id="icon-${contract.id}" class="fa-solid fa-chevron-down"></i></button>
                    </div>
                </div>
                <div id="sites-${contract.id}" class="sites-container" style="${isOrphan ? 'display:block;' : ''}">
                    ${sitesHTML}
                    ${!isOrphan ? `<div style="text-align:center; margin-top:15px;">
                        <button onclick="openAddSiteModal('${contract.id}')" class="btn-add-site">
                            <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>` : ''}
                </div>
            </div>`;
            container.innerHTML += html;
        }

        function toggleSites(id) {
            const el = document.getElementById(`sites-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (el.style.display === 'block') {
                el.style.display = 'none';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                el.classList.remove('open');
            } else {
                el.style.display = 'block';
                el.classList.add('open');
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            }
        }

        // --- CRUD Functions ---
        function addContract() {
            const name = document.getElementById('newContractName').value;
            const authVal = document.getElementById('newContractAuth').value;
            const start = document.getElementById('newContractStart').value;
            const end = document.getElementById('newContractEnd').value;
            
            if(!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯");
            const btn = event.target; btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;

            db.collection("contracts").add({
                name: name, supervisingAuthority: authVal, startDate: start, endDate: end,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
                document.getElementById('addContractModal').style.display='none';
                document.getElementById('newContractName').value="";
                document.getElementById('newContractAuth').value="";
                btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯"; btn.disabled = false;
            });
        }

        function openEditContractModal(contractId) {
            const contract = allContracts.find(c => c.id === contractId);
            if(!contract) return;
            document.getElementById('editContractId').value = contractId;
            document.getElementById('editContractName').value = contract.name;
            document.getElementById('editContractAuth').value = contract.supervisingAuthority || '';
            document.getElementById('editContractStart').value = contract.startDate || '';
            document.getElementById('editContractEnd').value = contract.endDate || '';
            document.getElementById('editContractModal').style.display = 'flex';
        }

        async function updateContract() {
            const id = document.getElementById('editContractId').value;
            const name = document.getElementById('editContractName').value;
            const authVal = document.getElementById('editContractAuth').value;
            const start = document.getElementById('editContractStart').value;
            const end = document.getElementById('editContractEnd').value;
            
            if(!id || !name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
            const btn = event.target; btn.innerHTML = "..."; btn.disabled = true;

            try {
                await db.collection("contracts").doc(id).update({
                    name: name, supervisingAuthority: authVal, startDate: start, endDate: end
                });
                alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); document.getElementById('editContractModal').style.display='none';
            } catch(e) { alert(e.message); } finally { btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"; btn.disabled = false; }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯
        async function deleteContract(contractId) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ØŸ\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡ Ù„Ù† ØªØ­Ø°ÙØŒ Ø¨Ù„ Ø³ØªÙ†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… 'Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø©'.")) return;
            try {
                await db.collection("contracts").doc(contractId).delete();
                alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
            } catch(e) {
                alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + e.message);
            }
        }

        function openAddSiteModal(preSelectedContractId = null) {
            const select = document.getElementById('contractSelect');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ --</option>';
            allContracts.forEach(c => {
                const sel = preSelectedContractId === c.id ? 'selected' : '';
                select.innerHTML += `<option value="${c.id}" ${sel}>${c.name}</option>`;
            });
            document.getElementById('addSiteModal').style.display = 'flex';
        }

        function addSite() {
            const contractId = document.getElementById('contractSelect').value;
            const category = document.getElementById('newSiteCategory').value;
            const name = document.getElementById('newSiteName').value;
            const budget = Number(document.getElementById('newSiteBudget').value);
            if(!contractId || !name || !budget) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

            const btn = event.target; btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;
            db.collection("budgets").add({
                contractId: contractId, category: category, itemName: name,
                totalAllocatedAmount: budget, currentBalance: budget, totalSpent: 0, totalProfit: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); document.getElementById('addSiteModal').style.display='none';
                document.getElementById('newSiteName').value=""; document.getElementById('newSiteBudget').value="";
                btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯"; btn.disabled = false;
            });
        }

        function openEditSiteModal(siteId) {
            const site = allSites.find(s => s.id === siteId);
            if(!site) return;
            document.getElementById('editSiteId').value = siteId;
            document.getElementById('editSiteName').value = site.itemName;
            document.getElementById('editSiteBudget').value = site.totalAllocatedAmount;
            document.getElementById('editSiteCategory').value = site.category || 'spare_parts';

            const select = document.getElementById('editSiteContractSelect');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ --</option>';
            allContracts.forEach(c => {
                const selected = site.contractId === c.id ? 'selected' : '';
                select.innerHTML += `<option value="${c.id}" ${selected}>${c.name}</option>`;
            });
            document.getElementById('editSiteModal').style.display = 'flex';
        }

        async function updateSite() {
            const siteId = document.getElementById('editSiteId').value;
            const contractId = document.getElementById('editSiteContractSelect').value;
            const category = document.getElementById('editSiteCategory').value;
            const name = document.getElementById('editSiteName').value;
            const budget = Number(document.getElementById('editSiteBudget').value);
            
            if(!siteId || !contractId || !name) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
            const btn = event.target; btn.innerHTML = "..."; btn.disabled = true;

            try {
                await db.collection('budgets').doc(siteId).update({
                    contractId: contractId, category: category, itemName: name, totalAllocatedAmount: budget
                });
                alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); document.getElementById('editSiteModal').style.display = 'none';
            } catch (e) { alert(e.message); } finally { btn.innerHTML = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"; btn.disabled = false; }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ø¨Ù†Ø¯
        async function deleteSite(siteId) {
            if(!confirm("ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯/Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nØ³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.")) return;
            try {
                await db.collection("budgets").doc(siteId).delete();
                alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
            } catch(e) {
                alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + e.message);
            }
        }

        // Users & Recalculate
        async function openUsersModal() {
            document.getElementById('usersModal').style.display = 'flex';
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            try {
                const usersSnap = await db.collection('users').orderBy('createdAt', 'desc').get();
                tbody.innerHTML = '';
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    const userId = doc.id;
                    let sitesOptions = `<option value="">-- Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹ --</option>`;
                    allContracts.forEach(contract => {
                        const contractSites = allSites.filter(s => s.contractId === contract.id);
                        if(contractSites.length > 0) {
                            sitesOptions += `<optgroup label="${contract.name}">`;
                            contractSites.forEach(site => {
                                const selected = u.assignedSiteId === site.id ? 'selected' : '';
                                sitesOptions += `<option value="${site.id}" ${selected}>${site.itemName}</option>`;
                            });
                            sitesOptions += `</optgroup>`;
                        }
                    });
                    
                    const r = u.role;
                    const row = `<tr>
                        <td>${u.email}</td>
                        <td>
                            <select id="role-${userId}" style="padding:5px;">
                                <option value="user" ${r==='user'?'selected':''}>Ù…Ø³ØªØ®Ø¯Ù…</option>
                                <option value="viewer" ${r==='viewer'?'selected':''}>Ù…Ø´Ø§Ù‡Ø¯</option>
                                <option value="viewer_pro" ${r==='viewer_pro'?'selected':''}>Ù…Ø´Ø§Ù‡Ø¯+Ø±Ø¨Ø­</option>
                                <option value="admin" ${r==='admin'?'selected':''}>Ù…Ø¯ÙŠØ±</option>
                            </select>
                        </td>
                        <td><select id="site-${userId}" style="padding:5px; width:150px;">${sitesOptions}</select></td>
                        <td><button onclick="saveUserChanges('${userId}')" style="padding:5px 10px; cursor:pointer;">Ø­ÙØ¸</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (e) { console.error(e); }
        }

        async function saveUserChanges(userId) {
            const newRole = document.getElementById(`role-${userId}`).value;
            const newSite = document.getElementById(`site-${userId}`).value;
            try { await db.collection('users').doc(userId).update({ role: newRole, assignedSiteId: newSite }); alert("ØªÙ…"); } 
            catch (e) { alert(e.message); }
        }

        async function recalculateAllProjects() {
            if(!confirm("Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ù„Ù„ÙƒÙ„ØŸ")) return;
            document.getElementById('loader').style.display = 'flex';
            try {
                const bs = await db.collection('budgets').get();
                const promises = bs.docs.map(async b => {
                    const trans = await b.ref.collection('transactions').get();
                    let p = 0, s = 0;
                    trans.forEach(t => { s += Number(t.data().amountExclTax)||0; p += Number(t.data().companyProfit)||0; });
                    return b.ref.update({ totalSpent: s, totalProfit: p, currentBalance: (b.data().totalAllocatedAmount||0) - s });
                });
                await Promise.all(promises); alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!");
            } catch(e) { alert(e.message); } finally { document.getElementById('loader').style.display = 'none'; }
        }

        function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
        function fmt(n) { return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits: 2}); }
    </script>
</body>
</html>
