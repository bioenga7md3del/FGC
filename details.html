<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
        .stat-card h3 { margin: 0 0 10px 0; color: #666; font-size: 0.9em; }
        .stat-card p { margin: 0; font-size: 1.5em; font-weight: bold; color: #333; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #ddd; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-danger { background-color: #dc3545; }
        
        .section { margin-bottom: 30px; padding: 20px; background: #fff; border: 1px solid #eee; border-radius: 5px; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 id="siteName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
        <button onclick="goBack()" class="btn btn-primary">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</h3>
            <p id="totalBudget">0</p>
        </div>
        <div class="stat-card">
            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ</h3>
            <p id="totalSpent" style="color: #dc3545;">0</p>
        </div>
        <div class="stat-card">
            <h3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø¨Ù†Ø¯</h3>
            <p id="currentBalance" style="color: #28a745;">0</p>
        </div>
        <div class="stat-card">
            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ø±ÙƒØ©</h3>
            <p id="totalProfit" style="color: #17a2b8;">0</p>
        </div>
    </div>

    <div id="importSection" class="section hidden" style="border: 2px dashed #ffc107; background-color: #fffbf0;">
        <h3>ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel (Ù…Ù„Ù CSV)</h3>
        <p style="font-size: 0.9em; color: #666;">Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù .csv ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ (Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ù…ÙŠØ¯ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ù…ÙˆØ±Ø¯ØŒ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø§Ù„Ù†Ø³Ø¨Ø©...).</p>
        <input type="file" id="csvFile" accept=".csv" style="display: inline-block; width: auto;">
        <button onclick="processCSV()" class="btn btn-warning">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨</button>
        <p id="importStatus" style="margin-top: 10px; font-weight: bold;"></p>
    </div>

    <div class="section">
        <h3>â• Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù…ÙŠØ¯ / ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <input type="number" id="orderNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ù…ÙŠØ¯">
            <input type="date" id="orderDate">
            <input type="text" id="supplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯">
            <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©)">
            <input type="number" id="ratio" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© (Ù…Ø«Ù„Ø§Ù‹ 0.20)" step="0.01">
            <input type="text" id="batch" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ/Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
        </div>
        <button onclick="addTransaction()" class="btn btn-success" style="width: 100%; margin-top: 10px;">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>

    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
    <table>
        <thead>
            <tr>
                <th>Ù…</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                <th>Ø§Ù„Ø±Ø¨Ø­</th>
                <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th>Ø­Ø°Ù</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI",
        authDomain: "fgcbio.firebaseapp.com",
        projectId: "fgcbio",
        storageBucket: "fgcbio.firebasestorage.app",
        messagingSenderId: "924334872806",
        appId: "1:924334872806:web:fac89ce388b1ff2de24327",
        measurementId: "G-H9VW2MZQG0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Ø¬Ù„Ø¨ Ø§Ù„Ù€ ID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const siteId = urlParams.get('id');

    if (!siteId) {
        alert("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„Ù…ÙˆÙ‚Ø¹");
        window.location.href = "index.html";
    }

    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    let currentSiteData = {};

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ù‡Ùˆ Ø£Ø¯Ù…Ù† Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists && userDoc.data().role === 'admin') {
                document.getElementById('importSection').classList.remove('hidden');
            }
            
            loadSiteInfo();
            loadTransactions();
        } else {
            window.location.href = "index.html";
        }
    });

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…)
    function loadSiteInfo() {
        db.collection("budgets").doc(siteId).onSnapshot((doc) => {
            if (doc.exists) {
                currentSiteData = doc.data();
                document.getElementById('siteName').innerText = currentSiteData.itemName;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                document.getElementById('totalBudget').innerText = formatMoney(currentSiteData.totalAllocatedAmount);
                document.getElementById('totalSpent').innerText = formatMoney(currentSiteData.totalSpent || 0);
                document.getElementById('currentBalance').innerText = formatMoney(currentSiteData.currentBalance);
                document.getElementById('totalProfit').innerText = formatMoney(currentSiteData.totalProfit || 0);
            }
        });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª
    function loadTransactions() {
        db.collection("budgets").doc(siteId).collection("transactions")
          .orderBy("orderNumber", "desc") // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
          .onSnapshot((snapshot) => {
              const tbody = document.getElementById('tableBody');
              tbody.innerHTML = "";
              snapshot.forEach(doc => {
                  const data = doc.data();
                  const row = `
                    <tr>
                        <td>${data.orderNumber}</td>
                        <td>${data.date}</td>
                        <td>${data.supplierName}</td>
                        <td>${formatMoney(data.amountExclTax)}</td>
                        <td>${data.companyRatio}</td>
                        <td>${formatMoney(data.companyProfit)}</td>
                        <td>${data.batchNumber || '-'}</td>
                        <td><button onclick="deleteTrans('${doc.id}', ${data.amountExclTax}, ${data.companyProfit})" style="color:red; background:none; border:none; cursor:pointer;">âŒ</button></td>
                    </tr>
                  `;
                  tbody.innerHTML += row;
              });
          });
    }

    // 3. Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
    async function addTransaction() {
        const orderNum = Number(document.getElementById('orderNum').value);
        const amount = Number(document.getElementById('amount').value);
        const ratio = Number(document.getElementById('ratio').value);
        const date = document.getElementById('orderDate').value;
        const supplier = document.getElementById('supplier').value;
        const batch = document.getElementById('batch').value;

        if (!amount || !date || !orderNum) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

        const profit = amount * ratio;

        try {
            await db.runTransaction(async (transaction) => {
                const siteRef = db.collection("budgets").doc(siteId);
                const siteDoc = await transaction.get(siteRef);
                const siteData = siteDoc.data();

                const newSpent = (siteData.totalSpent || 0) + amount;
                const newBalance = siteData.currentBalance - amount;
                const newProfit = (siteData.totalProfit || 0) + profit;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
                transaction.update(siteRef, {
                    totalSpent: newSpent,
                    currentBalance: newBalance,
                    totalProfit: newProfit
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ©
                const newTransRef = siteRef.collection("transactions").doc();
                transaction.set(newTransRef, {
                    orderNumber: orderNum,
                    date: date,
                    supplierName: supplier,
                    amountExclTax: amount,
                    companyRatio: ratio,
                    companyProfit: profit,
                    batchNumber: batch,
                    createdAt: new Date()
                });
            });
            
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('amount').value = "";
            document.getElementById('supplier').value = "";
        } catch (e) {
            console.error(e);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e);
        }
    }

    // 4. Ø­Ø°Ù Ø­Ø±ÙƒØ© (ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº)
    async function deleteTrans(transId, amount, profit) {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.")) return;

        try {
            await db.runTransaction(async (transaction) => {
                const siteRef = db.collection("budgets").doc(siteId);
                const transRef = siteRef.collection("transactions").doc(transId);
                const siteDoc = await transaction.get(siteRef);
                
                const newSpent = siteDoc.data().totalSpent - amount;
                const newBalance = siteDoc.data().currentBalance + amount;
                const newProfit = siteDoc.data().totalProfit - profit;

                transaction.update(siteRef, { totalSpent: newSpent, currentBalance: newBalance, totalProfit: newProfit });
                transaction.delete(transRef);
            });
        } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù"); }
    }

    // 5. ÙƒÙˆØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV (Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§)
    function processCSV() {
        const fileInput = document.getElementById('csvFile');
        if (!fileInput.files[0]) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù CSV Ø£ÙˆÙ„Ø§Ù‹");

        Papa.parse(fileInput.files[0], {
            header: false, // Ø³Ù†Ù‚Ø±Ø£ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù‚Ø¯ ØªØ®ØªÙ„Ù
            skipEmptyLines: true,
            complete: async function(results) {
                const rows = results.data;
                const batch = db.batch();
                const siteRef = db.collection("budgets").doc(siteId);
                
                let batchTotalSpent = 0;
                let batchTotalProfit = 0;
                let count = 0;

                // Ù†Ø¨Ø¯Ø£ Ù…Ù† ØµÙ 1 (Ø¨Ø§ÙØªØ±Ø§Ø¶ Ø§Ù„ØµÙ 0 Ù‡Ùˆ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)
                // Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ù…Ù„ÙÙƒ: Ø§Ù„Ø¹Ù…ÙˆØ¯ 0=Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ù…ÙŠØ¯ØŒ 1=Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ 2=Ø§Ù„Ù…ÙˆØ±Ø¯ØŒ 3=Ø§Ù„Ù…Ø¨Ù„ØºØŒ 4=Ø§Ù„Ù†Ø³Ø¨Ø©
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    // ØªØ®Ø·ÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ ØµÙÙˆÙ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
                    if (!row[0] || isNaN(row[3])) continue; 

                    const amount = Number(row[3]); // Ø§Ù„Ù…Ø¨Ù„Øº
                    const ratio = Number(row[4]);  // Ø§Ù„Ù†Ø³Ø¨Ø©
                    const profit = amount * ratio;

                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¬Ø¹ Ù„Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯
                    const newRef = siteRef.collection("transactions").doc(); 
                    
                    batch.set(newRef, {
                        orderNumber: Number(row[0]),
                        date: row[1],
                        supplierName: row[2],
                        amountExclTax: amount,
                        companyRatio: ratio,
                        companyProfit: profit,
                        batchNumber: row[7] || '', // Ø§Ù„Ø¹Ù…ÙˆØ¯ 7 Ù‡Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø© Ø­Ø³Ø¨ Ù…Ù„ÙÙƒ
                        importedAt: new Date()
                    });

                    batchTotalSpent += amount;
                    batchTotalProfit += profit;
                    count++;
                }

                // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
                // Ù†Ø­ØªØ§Ø¬ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ (Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù‚Ø¯ ÙŠÙƒÙˆÙ† ØµØ¹Ø¨Ø§Ù‹ ÙÙŠ Batch ÙˆØ­Ø¯Ù‡)
                // Ø§Ù„Ø£ÙØ¶Ù„: Ù†Ø³ØªØ®Ø¯Ù… runTransaction Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŒ Ø£Ùˆ Ù†Ø¶ÙŠÙ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹
                // Ù„Ù„ØªØ¨Ø³ÙŠØ· ÙˆØ§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø£Ù… Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                
                // Ø³Ù†Ù‚Ø±Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§
                const currentDoc = await siteRef.get();
                const currentData = currentDoc.data();
                
                batch.update(siteRef, {
                    totalSpent: (currentData.totalSpent || 0) + batchTotalSpent,
                    currentBalance: currentData.currentBalance - batchTotalSpent,
                    totalProfit: (currentData.totalProfit || 0) + batchTotalProfit
                });

                try {
                    await batch.commit();
                    document.getElementById('importStatus').innerText = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!`;
                    document.getElementById('importStatus').style.color = "green";
                    setTimeout(() => location.reload(), 2000); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
                } catch (e) {
                    console.error(e);
                    document.getElementById('importStatus').innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.";
                    document.getElementById('importStatus').style.color = "red";
                }
            }
        });
    }

    function formatMoney(num) {
        return Number(num).toLocaleString('ar-EG', { maximumFractionDigits: 2 });
    }

    function goBack() {
        window.location.href = "index.html";
    }
</script>

</body>
</html>
