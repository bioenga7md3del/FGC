<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل المشروع - FGC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        /* تنسيقات خاصة بصفحة التفاصيل لتتوافق مع الستايل الجديد */
        .print-header { display: none; text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
        
        .dashboard-top-section { display: flex; gap: 25px; margin-bottom: 30px; flex-wrap: wrap; }
        .stats-area { flex: 2; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        
        /* البطاقات الإحصائية */
        .stat-card {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
            text-align: center; position: relative; overflow: hidden;
        }
        .stat-card h3 { font-size: 0.9rem; color: var(--text-secondary); margin: 0 0 10px 0; }
        .stat-card p { font-size: 1.5rem; font-weight: 800; margin: 0; color: var(--text-main); }
        .stat-card.primary { border-bottom: 4px solid var(--primary); }
        .stat-card.danger { border-bottom: 4px solid var(--danger); }
        .stat-card.success { border-bottom: 4px solid var(--success); }
        .stat-card.accent { border-bottom: 4px solid var(--accent); }

        .chart-area {
            flex: 1; background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
            min-width: 300px; display: flex; flex-direction: column; align-items: center;
        }
        .chart-area h4 { margin-top: 0; color: var(--text-secondary); margin-bottom: 15px; }

        /* شريط الفلاتر */
        .filter-container {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
            display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;
            align-items: flex-end;
        }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px; }
        .filter-group input { 
            width: 100%; padding: 10px; border: 1px solid #d1d5db; 
            border-radius: 8px; background: #f9fafb; 
        }

        /* الجدول */
        .details-table-container {
            background: white; border-radius: var(--radius); 
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); 
            overflow: hidden;
        }
        .details-table { width: 100%; border-collapse: collapse; min-width: 900px; }
        .details-table th {
            background-color: #f8fafc; color: var(--text-secondary); font-weight: 700;
            font-size: 0.9rem; padding: 15px; text-align: right;
            border-bottom: 1px solid var(--border-color); white-space: nowrap;
        }
        .details-table td {
            padding: 12px 15px; border-bottom: 1px solid #f1f5f9;
            color: var(--text-main); font-size: 0.95rem; vertical-align: middle;
        }
        .details-table tr:hover td { background-color: #fcfcfc; }

        /* الأزرار في الهيدر */
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-action {
            padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer;
            border: none; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
            color: white; transition: 0.2s; text-decoration: none;
        }
        .btn-print { background: white; border: 1px solid #d1d5db; color: var(--text-main); }
        .btn-print:hover { background: #f3f4f6; }
        .btn-export { background: #10b981; } .btn-export:hover { background: #059669; }
        .btn-add-new { background: var(--primary); } .btn-add-new:hover { background: #1e40af; }
        .btn-import { background: var(--accent); } .btn-import:hover { background: var(--accent-hover); }
        .btn-reset { background: #fee2e2; color: var(--danger); } .btn-reset:hover { background: #fecaca; }

        /* تنسيق الطباعة */
        @media print {
            body { background: white; font-size: 12pt; }
            .navbar, .action-buttons, .filter-container, .modal-overlay, #actionButtons { display: none !important; }
            .print-header { display: block; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            .stat-card, .chart-area, .details-table-container { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000; padding: 5px; color: black; }
            /* إخفاء عمود التحكم عند الطباعة */
            th:last-child, td:last-child { display: none; }
        }
    </style>
</head>
<body>

<div class="print-header">
    <img src="FGC.jpeg" style="height: 60px; margin-bottom: 10px;">
    <h1>تقرير تفصيلي للبند/الموقع</h1>
    <h2 id="printSiteName" style="color:var(--primary);"></h2>
    <p>تاريخ التقرير: <span id="printDate"></span></p>
</div>

<nav class="navbar">
    <div class="nav-brand">
        <img src="FGC.jpeg" alt="Logo">
        <div>
            <h2>FGC System</h2>
            <span style="font-size: 0.8rem; color: #888;">تفاصيل المشروع</span>
        </div>
    </div>
    <div style="display:flex; gap:10px;">
        <a href="dashboard.html" id="homeBtn" class="btn-logout" style="background:transparent; border:1px solid #ddd; color:var(--text-secondary); display:none;">
            <i class="fa-solid fa-house"></i> الرئيسية
        </a>
        <button onclick="logout()" class="btn-logout">
            <i class="fa-solid fa-right-from-bracket"></i> خروج
        </button>
    </div>
</nav>

<div class="container">
    
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
        <div>
            <h2 id="siteTitle" style="color:var(--primary); font-size: 1.8rem; margin: 0;">جاري التحميل...</h2>
            <p style="color:var(--text-secondary); margin-top:5px;">سجل الحركات والتكاليف</p>
        </div>
        
        <div id="actionButtons" class="action-buttons" style="display:none;">
            <button onclick="window.print()" class="btn-action btn-print">
                <i class="fa-solid fa-print"></i> طباعة
            </button>
            <button onclick="exportTableToCSV('report.csv')" class="btn-action btn-export">
                <i class="fa-solid fa-file-excel"></i> تصدير
            </button>
            
            <span id="editButtons" style="display:none; gap: 10px;">
                <button onclick="openModal()" class="btn-action btn-add-new">
                    <i class="fa-solid fa-plus"></i> إضافة جديد
                </button>
                <button onclick="document.getElementById('importModal').style.display='flex'" class="btn-action btn-import">
                    <i class="fa-solid fa-file-csv"></i> استيراد
                </button>
                <button onclick="clearAllData()" class="btn-action btn-reset">
                    <i class="fa-solid fa-trash"></i> تصفير
                </button>
            </span>
        </div>
    </div>

    <div class="dashboard-top-section">
        <div class="stats-area">
            <div class="stat-card primary">
                <h3>الميزانية المعتمدة</h3>
                <p id="statBudget">0</p>
            </div>
            <div class="stat-card danger">
                <h3>إجمالي المصروف</h3>
                <p id="statSpent" style="color:var(--danger)">0</p>
            </div>
            <div class="stat-card success">
                <h3>الرصيد المتبقي</h3>
                <p id="statBalance" style="color:var(--success)">0</p>
            </div>
            <div class="stat-card accent" id="cardProfit" style="display:none;">
                <h3>الانجاز المالي</h3>
                <p id="statProfit" style="color:var(--accent)">0</p>
            </div>
        </div>

        <div class="chart-area">
            <h4>تحليل الميزانية</h4>
            <div style="position: relative; height: 200px; width: 100%; display:flex; justify-content:center;">
                <canvas id="budgetChart"></canvas>
            </div>
        </div>
    </div>

    <div class="filter-container">
        <div class="filter-group"><label>رقم المستخلص</label><input type="text" id="filterBatch" onkeyup="applyFilters()" placeholder="بحث..."></div>
        <div class="filter-group"><label>رقم الفاتورة</label><input type="text" id="filterInvoice" onkeyup="applyFilters()" placeholder="بحث..."></div>
        <div class="filter-group"><label>رقم أمر الشراء (PO)</label><input type="text" id="filterPO" onkeyup="applyFilters()" placeholder="بحث..."></div>
        <div class="filter-group"><label>المورد</label><input type="text" id="filterSupplier" onkeyup="applyFilters()" placeholder="بحث..."></div>
        <div class="filter-group"><label>التاريخ</label><input type="date" id="filterDate" onchange="applyFilters()"></div>
    </div>

    <div class="details-table-container">
        <div style="overflow-x: auto;">
            <table class="details-table" id="transTable">
                <thead>
                    <tr>
                        <th>التعميد</th><th>التاريخ</th><th>PO #</th>
                        <th>رقم المستخلص</th>
                        <th>المورد</th><th>فاتورة #</th><th>تاريخ الفاتورة</th><th>المبلغ</th>
                        <th id="headerRatio" style="display:none;">النسبة</th>
                        <th id="headerProfit" style="display:none;">الإنجاز</th>
                        <th id="headerActions" style="display:none;">تحكم</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    
    <div style="height: 50px;"></div>
</div>

<div id="transactionModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle" style="color:var(--primary); margin-top:0;">تسجيل معاملة جديدة</h2>
        <input type="hidden" id="editTransId">
        
        <div class="input-group">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                <div class="input-box"><label>رقم التعميد *</label><input type="number" id="orderNum"></div>
                <div class="input-box"><label>تاريخ التعميد *</label><input type="date" id="orderDate"></div>
                <div class="input-box"><label>المورد *</label><input type="text" id="supplier"></div>
            </div>
            
            <div style="background:#f8fafc; padding:15px; border-radius:10px; border: 1px dashed #d1d5db; margin-top:10px;">
                <h4 style="margin:0 0 10px 0; color:var(--text-secondary); font-size: 0.9rem;">بيانات الفاتورة وأمر الشراء</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div class="input-box"><label>رقم الفاتورة</label><input type="text" id="invoiceNum"></div>
                    <div class="input-box"><label>تاريخ الفاتورة</label><input type="date" id="invoiceDate"></div>
                    <div class="input-box"><label>رقم أمر الشراء (PO)</label><input type="text" id="poNumber"></div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div class="input-box"><label>المبلغ (بدون ضريبة) *</label><input type="number" id="amount" style="border-color:var(--accent);"></div>
                <div class="input-box" id="divRatio"><label>النسبة (مثلاً 0.20)</label><input type="number" id="ratio" step="0.01" placeholder="0.20"></div>
                <div class="input-box"><label>رقم المستخلص</label><input type="text" id="batch"></div>
            </div>
            
            <button onclick="saveTransaction()" class="btn-save">حفظ البيانات</button>
        </div>
    </div>
</div>

<div id="importModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <span class="close-modal" onclick="document.getElementById('importModal').style.display='none'">&times;</span>
        <div style="font-size: 3rem; color: var(--success); margin-bottom: 10px;"><i class="fa-solid fa-file-excel"></i></div>
        <h3>استيراد بيانات Excel/CSV</h3>
        <p style="color:#666; font-size:0.9rem;">تأكد أن الملف يحتوي على الأعمدة بالترتيب الصحيح</p>
        <input type="file" id="csvFile" accept=".csv" style="padding: 15px; border: 2px dashed #d1d5db; width: 100%; box-sizing: border-box; margin: 20px 0; background: #f9fafb; border-radius: 10px;">
        <button onclick="processCSV()" class="btn-save" style="background:var(--accent);">بدء الاستيراد</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const siteId = new URLSearchParams(window.location.search).get('id');
    if(!siteId) window.location.href = "dashboard.html";

    let budgetChart = null;
    let currentUserRole = 'user'; 

    function initChart() {
        const ctx = document.getElementById('budgetChart').getContext('2d');
        budgetChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['المصروف', 'المتبقي'],
                datasets: [{ data: [0, 100], backgroundColor: ['#ef4444', '#10b981'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function updateChart(spent, balance) {
        if(budgetChart) {
            const safeBalance = balance > 0 ? balance : 0;
            budgetChart.data.datasets[0].data = [spent, safeBalance];
            budgetChart.update();
        }
    }

    function updatePrintHeader(siteName) {
        document.getElementById('printSiteName').innerText = siteName;
        document.getElementById('printDate').innerText = new Date().toLocaleDateString('ar-EG');
    }

    function exportTableToCSV(filename) {
        let csv = []; csv.push('\uFEFF'); let rows = document.querySelectorAll("table tr");
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) {
                if (cols[j].innerText === 'تحكم' || cols[j].querySelector('button')) continue;
                if (cols[j].style.display === 'none') continue;
                let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/,/g, ""); 
                row.push('"' + data + '"');
            }
            csv.push(row.join(","));
        }
        downloadCSV(csv.join("\n"), filename);
    }

    function downloadCSV(csv, filename) {
        let csvFile = new Blob([csv], {type: "text/csv"});
        let downloadLink = document.createElement("a");
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
    }

    function formatDateForInput(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return ""; 
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); 
        const day = String(date.getDate()).padStart(2, '0');        
        return `${year}-${month}-${day}`;
    }

    auth.onAuthStateChanged(async user => {
        if(user) {
            const u = await db.collection('users').doc(user.uid).get();
            const userData = u.data();
            
            if(u.exists) currentUserRole = userData.role;

            const canSeeProfit = (currentUserRole === 'admin' || currentUserRole === 'viewer_pro');
            const canEdit = (currentUserRole === 'admin' || currentUserRole === 'user');

            document.getElementById('actionButtons').style.display = 'flex';
            
            if(currentUserRole === 'admin') document.getElementById('homeBtn').style.display = 'flex';

            const editBtnGroup = document.getElementById('editButtons');
            if(canEdit) {
                editBtnGroup.style.display = 'flex';
            } else {
                editBtnGroup.style.display = 'none';
            }

            document.getElementById('cardProfit').style.display = canSeeProfit ? 'block' : 'none';
            document.getElementById('headerProfit').style.display = canSeeProfit ? 'table-cell' : 'none';
            document.getElementById('headerRatio').style.display = canSeeProfit ? 'table-cell' : 'none';
            document.getElementById('headerActions').style.display = canEdit ? 'table-cell' : 'none';

            loadPageData(canSeeProfit, canEdit);
            initChart();
        } else {
            window.location.href = "index.html";
        }
    });

    function loadPageData(canSeeProfit, canEdit) {
        db.collection("budgets").doc(siteId).onSnapshot(doc => {
            if(!doc.exists) return;
            const d = doc.data();
            document.getElementById('siteTitle').innerText = d.itemName;
            document.getElementById('statBudget').innerText = fmt(d.totalAllocatedAmount);
            document.getElementById('statSpent').innerText = fmt(d.totalSpent);
            document.getElementById('statBalance').innerText = fmt(d.currentBalance);
            document.getElementById('statProfit').innerText = fmt(d.totalProfit);

            updateChart(d.totalSpent || 0, d.currentBalance || 0);
            updatePrintHeader(d.itemName);
        });

        db.collection("budgets").doc(siteId).collection("transactions").orderBy("orderNumber", "desc").onSnapshot(snap => {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            snap.forEach(doc => {
                const val = doc.data();
                
                let profitCells = '';
                if(canSeeProfit) {
                    profitCells = `<td>${val.companyRatio || 0}</td><td>${fmt(val.companyProfit)}</td>`;
                }

                let actionCell = '';
                if(canEdit) {
                    actionCell = `
                    <td>
                        <div style="display:flex; gap:5px;">
                            <button onclick="editTrans('${doc.id}')" class="btn-small btn-edit" title="تعديل"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteTrans('${doc.id}', ${val.amountExclTax}, ${val.companyProfit})" class="btn-small btn-delete-sm" title="حذف" style="color:var(--danger); border-color:var(--danger);"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>`;
                }

                tbody.innerHTML += `
                <tr class="data-row">
                    <td>${val.orderNumber}</td>
                    <td class="col-date">${val.date}</td>
                    <td class="col-po">${val.poNumber || '-'}</td>
                    <td class="col-batch">${val.batchNumber || '-'}</td> 
                    <td class="col-supplier">${val.supplierName}</td>
                    <td class="col-invoice">${val.invoiceNum || '-'}</td>
                    <td class="col-invoice-date">${val.invoiceDate || '-'}</td>
                    <td style="font-weight:bold;">${fmt(val.amountExclTax)}</td>
                    ${profitCells}
                    ${actionCell}
                </tr>`;
            });
            applyFilters();
        });
    }

    function openModal() { 
        document.getElementById('editTransId').value=""; 
        document.getElementById('modalTitle').innerText="تسجيل معاملة جديدة"; 
        document.querySelectorAll('#transactionModal input').forEach(i=>i.value=""); 
        
        if(currentUserRole === 'admin') {
            document.getElementById('divRatio').style.display = 'block';
        } else {
            document.getElementById('divRatio').style.display = 'none';
        }
        
        document.getElementById('transactionModal').style.display = 'flex'; 
    }
    
    function closeModal() { document.getElementById('transactionModal').style.display = 'none'; }
    
    function applyFilters() { 
        const inv=document.getElementById('filterInvoice').value.toLowerCase();
        const po=document.getElementById('filterPO').value.toLowerCase();
        const sup=document.getElementById('filterSupplier').value.toLowerCase();
        const batch=document.getElementById('filterBatch').value.toLowerCase();
        const date=document.getElementById('filterDate').value;

        document.querySelectorAll('.data-row').forEach(row=>{
            const i=row.querySelector('.col-invoice').innerText.toLowerCase();
            const p=row.querySelector('.col-po').innerText.toLowerCase();
            const s=row.querySelector('.col-supplier').innerText.toLowerCase();
            const b=row.querySelector('.col-batch').innerText.toLowerCase();
            const d=row.querySelector('.col-date').innerText;
            
            row.style.display = (i.includes(inv)&&p.includes(po)&&s.includes(sup)&&b.includes(batch)&&(!date||d===date))?'':'none';
        });
    }

    async function saveTransaction() {
        const id=document.getElementById('editTransId').value;
        const amt=parseFloat(document.getElementById('amount').value)||0;
        let ratio = parseFloat(document.getElementById('ratio').value)||0;
        
        const data={ 
            orderNumber:Number(document.getElementById('orderNum').value), 
            date:document.getElementById('orderDate').value, 
            supplierName:document.getElementById('supplier').value, 
            amountExclTax:amt, 
            companyRatio:ratio, 
            companyProfit:amt*ratio, 
            batchNumber:document.getElementById('batch').value, 
            invoiceNum:document.getElementById('invoiceNum').value, 
            invoiceDate:document.getElementById('invoiceDate').value, 
            poNumber:document.getElementById('poNumber').value 
        };
        
        if(!amt||!data.orderNumber) return alert("بيانات ناقصة");
        
        try {
            await db.runTransaction(async t=>{
                const ref=db.collection("budgets").doc(siteId), doc=await t.get(ref), cur=doc.data();
                let sp=cur.totalSpent||0, pr=cur.totalProfit||0, bl=cur.currentBalance||0;
                
                if(id){ 
                    const oldDoc = await t.get(ref.collection("transactions").doc(id));
                    const od = oldDoc.data();
                    if(currentUserRole !== 'admin') {
                        data.companyRatio = od.companyRatio || 0;
                        data.companyProfit = data.amountExclTax * data.companyRatio;
                    }
                    sp-=(od.amountExclTax||0); pr-=(od.companyProfit||0); bl+=(od.amountExclTax||0); 
                    t.update(ref.collection("transactions").doc(id),data); 
                }
                else { 
                    data.createdAt=new Date(); 
                    t.set(ref.collection("transactions").doc(),data); 
                }
                t.update(ref,{ totalSpent:sp+data.amountExclTax, totalProfit:pr+data.companyProfit, currentBalance:bl-data.amountExclTax });
            });
            closeModal();
        } catch(e){alert("خطأ: "+e.message);}
    }

    async function editTrans(id) {
        const doc=await db.collection("budgets").doc(siteId).collection("transactions").doc(id).get(), d=doc.data();
        document.getElementById('editTransId').value=id; document.getElementById('modalTitle').innerText="تعديل المعاملة";
        document.getElementById('orderNum').value=d.orderNumber; document.getElementById('supplier').value=d.supplierName; document.getElementById('amount').value=d.amountExclTax; document.getElementById('ratio').value=d.companyRatio; document.getElementById('batch').value=d.batchNumber||''; document.getElementById('invoiceNum').value=d.invoiceNum||''; document.getElementById('poNumber').value=d.poNumber||''; 
        document.getElementById('orderDate').value=formatDateForInput(d.date); document.getElementById('invoiceDate').value=formatDateForInput(d.invoiceDate);
        
        if(currentUserRole === 'admin') {
            document.getElementById('divRatio').style.display = 'block';
        } else {
            document.getElementById('divRatio').style.display = 'none';
        }

        document.getElementById('transactionModal').style.display = 'flex';
    }

    async function deleteTrans(id, amt, prf) {
        if(!confirm("حذف؟")) return;
        await db.runTransaction(async t=>{ const r=db.collection("budgets").doc(siteId), d=await t.get(r); t.delete(r.collection("transactions").doc(id)); t.update(r,{ totalSpent:(d.data().totalSpent||0)-amt, totalProfit:(d.data().totalProfit||0)-prf, currentBalance:(d.data().currentBalance||0)+amt }); });
    }

    function processCSV() {
        const f=document.getElementById('csvFile').files[0]; if(!f) return alert("ملف؟");
        Papa.parse(f,{header:false,encoding:"windows-1256",skipEmptyLines:true,complete:async res=>{
            const b=db.batch(), r=db.collection("budgets").doc(siteId); let s=0, p=0;
            res.data.forEach((row,i)=>{
                if(i>0 && row[0] && !isNaN(parseFloat(row[3]))){
                    const a=parseFloat(row[3]), rt=parseFloat(row[4])||0;
                    b.set(r.collection("transactions").doc(),{orderNumber:Number(row[0]),date:row[1],supplierName:row[2],amountExclTax:a,companyRatio:rt,companyProfit:a*rt,invoiceNum:row[5]||'',invoiceDate:row[6]||'',poNumber:row[7]||'',batchNumber:row[8]||'',importedAt:new Date()});
                    s+=a; p+=(a*rt);
                }
            });
            const c=(await r.get()).data(); b.update(r,{totalSpent:(c.totalSpent||0)+s, totalProfit:(c.totalProfit||0)+p, currentBalance:c.currentBalance-s});
            await b.commit(); location.reload();
        }});
    }

    async function clearAllData() {
        if(!confirm("حذف الكل؟")) return;
        const r=db.collection("budgets").doc(siteId), s=await r.collection("transactions").get(), b=db.batch();
        s.forEach(d=>b.delete(d.ref)); const org=(await r.get()).data().totalAllocatedAmount;
        b.update(r,{totalSpent:0,totalProfit:0,currentBalance:org}); await b.commit(); location.reload();
    }

    function logout() { auth.signOut().then(()=>window.location.href="index.html"); }
    function fmt(n) { return Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2}); }
</script>
</body>
</html>
