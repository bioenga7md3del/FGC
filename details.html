<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ - FGC</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <div class="header-title-box">
            <img src="FGC.jpeg" alt="FGC Logo" class="logo-img" style="max-height: 60px;">
            <div>
                <h2 id="siteTitle" style="margin-bottom: 5px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
                <a href="dashboard.html" class="btn btn-outline" style="font-size:0.85em; padding: 6px 15px;">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </div>
        </div>
    </div>

    <div class="stat-grid">
        <div class="card" style="text-align: center; border-bottom: 4px solid var(--primary-dark);">
            <h3>ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</h3>
            <p id="statBudget" style="color: var(--primary-dark);">0</p>
        </div>
        <div class="card" style="text-align: center; border-bottom: 4px solid var(--danger);">
            <h3>ğŸ“‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ</h3>
            <p id="statSpent" class="text-danger">0</p>
        </div>
        <div class="card" style="text-align: center; border-bottom: 4px solid var(--success);">
            <h3>âœ… Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3>
            <p id="statBalance" class="text-success">0</p>
        </div>
        <div class="card" style="text-align: center; border-bottom: 4px solid var(--accent-gold);">
            <h3>ğŸ“Š Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ø±ÙƒØ©</h3>
            <p id="statProfit" class="text-accent">0</p>
        </div>
    </div>

    <div class="card" id="formCard" style="border-top: 4px solid var(--primary-light);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 id="formTitle" style="color: var(--primary-dark); margin: 0;">â• ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        </div>
        
        <input type="hidden" id="editTransId">
        
        <div class="form-grid">
            <div><label>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ù…ÙŠØ¯ *</label><input type="number" id="orderNum"></div>
            <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ù…ÙŠØ¯ *</label><input type="date" id="orderDate"></div>
            <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯ *</label><input type="text" id="supplier"></div>
            
            <div style="background:#f4f7f6; padding:15px; border-radius:10px; grid-column: span 3;">
                <h4 style="margin: 0 0 15px 0; color: var(--primary-dark);">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div><label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input type="text" id="invoiceNum"></div>
                    <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input type="date" id="invoiceDate"></div>
                    <div><label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (PO)</label><input type="text" id="poNumber"></div>
                </div>
            </div>

            <div><label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©) *</label><input type="number" id="amount" style="font-weight: bold;"></div>
            <div><label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© (Ù…Ø«Ù„Ø§Ù‹ 0.20)</label><input type="number" id="ratio" step="0.01" placeholder="0.20"></div>
            <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ù…Ø³ØªØ®Ù„Øµ</label><input type="text" id="batch"></div>
        </div>
        
        <div style="margin-top: 25px; display: flex; gap: 15px;">
            <button onclick="saveTransaction()" class="btn btn-success" id="saveBtn" style="flex:3; font-size: 1.1em;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            <button onclick="cancelEdit()" class="btn btn-danger" id="cancelBtn" style="display:none; flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="card">
        <h3 style="color: var(--primary-dark);">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª ÙˆØ§Ù„ØªØ¹Ù…ÙŠØ¯Ø§Øª</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ØªØ¹Ù…ÙŠØ¯ #</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>PO #</th>
                        <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                        <th>ÙØ§ØªÙˆØ±Ø© #</th>
                        <th>Ù…Ø¨Ù„Øº (Ù‚.Ù…)</th>
                        <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                        <th>Ø§Ù„Ø±Ø¨Ø­</th>
                        <th>ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="adminTools" class="card" style="display:none; background:#fffbf0; border: 2px dashed var(--accent-orange);">
        <h3 style="color: var(--accent-orange);">ğŸ‘‘ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        
        <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="flex: 1;">
                 <label>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel (CSV)</label>
                 <input type="file" id="csvFile" accept=".csv" style="background: white;">
            </div>
            <button onclick="processCSV()" class="btn btn-warning">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        </div>
        
        <div style="border-top: 1px solid #ebd5b3; padding-top: 20px;">
            <button onclick="clearAllData()" class="btn btn-danger" style="width: auto;">âš ï¸ ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ)</button>
        </div>
    </div>

</div>

<script>
    // --- Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø³Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ (Ù„Ø§ ØªØºÙŠÙŠØ±) ---
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const siteId = new URLSearchParams(window.location.search).get('id');
    if(!siteId) window.location.href = "dashboard.html";

    auth.onAuthStateChanged(async user => {
        if(user) {
            const u = await db.collection('users').doc(user.uid).get();
            if(u.exists && u.data().role === 'admin') document.getElementById('adminTools').style.display = 'block';
            
            db.collection("budgets").doc(siteId).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('siteTitle').innerText = d.itemName;
                document.getElementById('statBudget').innerText = fmt(d.totalAllocatedAmount);
                document.getElementById('statSpent').innerText = fmt(d.totalSpent);
                document.getElementById('statBalance').innerText = fmt(d.currentBalance);
                document.getElementById('statProfit').innerText = fmt(d.totalProfit);
            });

            db.collection("budgets").doc(siteId).collection("transactions").orderBy("orderNumber", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = "";
                snap.forEach(doc => {
                    const val = doc.data();
                    tbody.innerHTML += `
                    <tr>
                        <td><strong>${val.orderNumber}</strong></td>
                        <td>${val.date}</td>
                        <td>${val.poNumber || '-'}</td>
                        <td>${val.supplierName}</td>
                        <td>${val.invoiceNum || '-'}</td>
                        <td style="font-weight:bold; color:var(--primary-dark)">${fmt(val.amountExclTax)}</td>
                        <td>${val.companyRatio}</td>
                        <td style="color:var(--accent-gold)">${fmt(val.companyProfit)}</td>
                        <td>
                            <button onclick="editTrans('${doc.id}')" class="btn btn-secondary" style="padding:5px 10px; font-size:0.9em;">âœï¸</button>
                            <button onclick="deleteTrans('${doc.id}', ${val.amountExclTax}, ${val.companyProfit})" class="btn btn-danger" style="padding:5px 10px; font-size:0.9em;">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                });
            });
        }
    });

    async function saveTransaction() {
        const id = document.getElementById('editTransId').value;
        const data = {
            orderNumber: Number(document.getElementById('orderNum').value),
            date: document.getElementById('orderDate').value,
            supplierName: document.getElementById('supplier').value,
            amountExclTax: Number(document.getElementById('amount').value),
            companyRatio: Number(document.getElementById('ratio').value),
            batchNumber: document.getElementById('batch').value,
            invoiceNum: document.getElementById('invoiceNum').value,
            invoiceDate: document.getElementById('invoiceDate').value,
            poNumber: document.getElementById('poNumber').value,
        };

        if(!data.amountExclTax || !data.orderNumber || !data.supplierName || !data.date) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„ØªÙŠ Ø¹Ù„ÙŠÙ‡Ø§ Ù†Ø¬Ù…Ø© *)");
        data.companyProfit = data.amountExclTax * (data.companyRatio || 0);

        try {
            await db.runTransaction(async (t) => {
                const siteRef = db.collection("budgets").doc(siteId);
                const siteDoc = await t.get(siteRef);
                const currentSite = siteDoc.data();
                
                let newSpent = currentSite.totalSpent;
                let newProfit = currentSite.totalProfit;
                let newBalance = currentSite.currentBalance;

                if(id) {
                    const oldDoc = await t.get(siteRef.collection("transactions").doc(id));
                    const oldData = oldDoc.data();
                    newSpent -= oldData.amountExclTax;
                    newProfit -= oldData.companyProfit;
                    newBalance += oldData.amountExclTax;
                    t.update(siteRef.collection("transactions").doc(id), data);
                } else {
                    data.createdAt = new Date();
                    t.set(siteRef.collection("transactions").doc(), data);
                }
                newSpent += data.amountExclTax;
                newProfit += data.companyProfit;
                newBalance -= data.amountExclTax;
                t.update(siteRef, { totalSpent: newSpent, totalProfit: newProfit, currentBalance: newBalance });
            });
            alert(id ? "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" : "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
            cancelEdit();
        } catch(e) { console.error(e); alert("Ø®Ø·Ø£: " + e.message); }
    }

    async function editTrans(id) {
        const doc = await db.collection("budgets").doc(siteId).collection("transactions").doc(id).get();
        const d = doc.data();
        document.getElementById('editTransId').value = id;
        document.getElementById('orderNum').value = d.orderNumber;
        document.getElementById('orderDate').value = d.date;
        document.getElementById('supplier').value = d.supplierName;
        document.getElementById('amount').value = d.amountExclTax;
        document.getElementById('ratio').value = d.companyRatio;
        document.getElementById('batch').value = d.batchNumber || '';
        document.getElementById('invoiceNum').value = d.invoiceNum || '';
        document.getElementById('invoiceDate').value = d.invoiceDate || '';
        document.getElementById('poNumber').value = d.poNumber || '';
        document.getElementById('saveBtn').innerText = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
        document.getElementById('saveBtn').className = "btn btn-warning";
        document.getElementById('formTitle').innerText = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©";
        document.getElementById('cancelBtn').style.display = 'inline-flex';
        document.getElementById('formCard').scrollIntoView({behavior: "smooth"});
    }

    function cancelEdit() {
        document.getElementById('editTransId').value = "";
        document.querySelectorAll('input').forEach(i => i.value = "");
        document.getElementById('saveBtn').innerText = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
        document.getElementById('saveBtn').className = "btn btn-success";
        document.getElementById('formTitle').innerText = "â• ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©";
        document.getElementById('cancelBtn').style.display = 'none';
        document.getElementById('ratio').value = "";
    }

    async function deleteTrans(id, amount, profit) {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.")) return;
        await db.runTransaction(async (t) => {
            const siteRef = db.collection("budgets").doc(siteId);
            const siteDoc = await t.get(siteRef);
            t.delete(siteRef.collection("transactions").doc(id));
            t.update(siteRef, {
                totalSpent: siteDoc.data().totalSpent - amount,
                totalProfit: siteDoc.data().totalProfit - profit,
                currentBalance: siteDoc.data().currentBalance + amount
            });
        });
    }

    function processCSV() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù CSV");
        Papa.parse(file, {
            header: false, encoding: "windows-1256", skipEmptyLines: true,
            complete: async function(results) {
                const rows = results.data;
                const batch = db.batch();
                const siteRef = db.collection("budgets").doc(siteId);
                let bSpent=0, bProfit=0, count=0;
                for(let i=1; i<rows.length; i++){
                    const r = rows[i];
                    if(!r[0] || isNaN(parseFloat(r[3]))) continue;
                    const amount = parseFloat(r[3]);
                    const ratio = parseFloat(r[4]) || 0;
                    const newRef = siteRef.collection("transactions").doc();
                    batch.set(newRef, {
                        orderNumber: Number(r[0]), date: r[1], supplierName: r[2], amountExclTax: amount, companyRatio: ratio, companyProfit: amount * ratio,
                        invoiceNum: r[5] || '', invoiceDate: r[6] || '', poNumber: r[7] || '', batchNumber: r[8] || '', importedAt: new Date()
                    });
                    bSpent += amount; bProfit += (amount*ratio); count++;
                }
                const cur = (await siteRef.get()).data();
                batch.update(siteRef, { totalSpent: (cur.totalSpent||0) + bSpent, totalProfit: (cur.totalProfit||0) + bProfit, currentBalance: cur.currentBalance - bSpent });
                await batch.commit();
                alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­`);
                location.reload();
            }
        });
    }

    async function clearAllData() {
        if(!confirm("ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±! ğŸ›‘\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) return;
        const siteRef = db.collection("budgets").doc(siteId);
        const snaps = await siteRef.collection("transactions").get();
        const batch = db.batch();
        snaps.forEach(d => batch.delete(d.ref));
        const origin = (await siteRef.get()).data().totalAllocatedAmount;
        batch.update(siteRef, { totalSpent: 0, totalProfit: 0, currentBalance: origin });
        await batch.commit();
        alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
        location.reload();
    }

    function fmt(n) { return Number(n).toLocaleString('ar-EG', {minimumFractionDigits: 2, maximumFractionDigits:2}); }
</script>
</body>
</html>
