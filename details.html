<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل المشروع - FGC</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="container">
    <div class="header-bar">
        <div class="header-title-box">
            <img src="FGC.jpeg" alt="Logo" class="logo-img" style="max-height: 60px;">
            <div>
                <h2 id="siteTitle" style="margin:0;">جاري التحميل...</h2>
                <a href="dashboard.html" class="btn btn-outline" style="font-size:0.8em; padding: 5px 10px; margin-top:5px;">
                    <i class="fa-solid fa-house"></i> الرئيسية
                </a>
            </div>
        </div>
        
        <div id="adminButtons" style="display:none;">
            <button onclick="openModal()" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i> إضافة جديد
            </button>
            <button onclick="document.getElementById('importModal').style.display='flex'" class="btn btn-warning">
                <i class="fa-solid fa-file-csv"></i> استيراد Excel
            </button>
            <button onclick="clearAllData()" class="btn btn-danger">
                <i class="fa-solid fa-trash"></i> تصفير
            </button>
        </div>
    </div>

    <div class="stat-grid" style="margin-bottom: 30px;">
        <div class="card" style="text-align:center; border-bottom:4px solid var(--primary-dark);">
            <h3>الميزانية</h3><p id="statBudget">0</p>
        </div>
        <div class="card" style="text-align:center; border-bottom:4px solid var(--danger);">
            <h3>المصروف</h3><p id="statSpent" style="color:var(--danger)">0</p>
        </div>
        <div class="card" style="text-align:center; border-bottom:4px solid var(--success);">
            <h3>المتبقي</h3><p id="statBalance" style="color:var(--success)">0</p>
        </div>
        <div class="card" style="text-align:center; border-bottom:4px solid var(--accent-gold);">
            <h3>الربح</h3><p id="statProfit" style="color:var(--accent-gold)">0</p>
        </div>
    </div>

    <div class="action-bar">
        <div class="filter-container">
            <div class="filter-group">
                <label>بحث برقم الفاتورة</label>
                <input type="text" id="filterInvoice" onkeyup="applyFilters()" placeholder="اكتب الرقم...">
            </div>
            <div class="filter-group">
                <label>بحث برقم أمر الشراء (PO)</label>
                <input type="text" id="filterPO" onkeyup="applyFilters()" placeholder="اكتب رقم الـ PO...">
            </div>
            <div class="filter-group">
                <label>بحث باسم المورد</label>
                <input type="text" id="filterSupplier" onkeyup="applyFilters()" placeholder="اسم المورد...">
            </div>
            <div class="filter-group">
                <label>فلترة بالتاريخ</label>
                <input type="date" id="filterDate" onchange="applyFilters()">
            </div>
        </div>
    </div>

    <div class="card">
        <h3><i class="fa-solid fa-list"></i> سجل الحركات</h3>
        <div class="table-container">
            <table id="transTable">
                <thead>
                    <tr>
                        <th>التعميد</th>
                        <th>التاريخ</th>
                        <th>PO #</th>
                        <th>المورد</th>
                        <th>فاتورة #</th>
                        <th>تاريخ الفاتورة</th>
                        <th>المبلغ</th>
                        <th>النسبة</th>
                        <th>الربح</th>
                        <th>تحكم</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="transactionModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle" style="color:var(--primary-dark); margin-top:0;">تسجيل معاملة جديدة</h3>
        
        <input type="hidden" id="editTransId">
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div><label>رقم التعميد *</label><input type="number" id="orderNum"></div>
            <div><label>تاريخ التعميد *</label><input type="date" id="orderDate"></div>
            <div><label>المورد *</label><input type="text" id="supplier"></div>
        </div>

        <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin: 15px 0;">
            <h4 style="margin:0 0 10px 0; color:var(--primary-light);">بيانات الفاتورة وأمر الشراء</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                <div><label>رقم الفاتورة</label><input type="text" id="invoiceNum"></div>
                <div><label>تاريخ الفاتورة</label><input type="date" id="invoiceDate"></div>
                <div><label>رقم أمر الشراء (PO)</label><input type="text" id="poNumber"></div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div><label>المبلغ (بدون ضريبة) *</label><input type="number" id="amount" style="border-color:var(--accent-gold);"></div>
            <div><label>النسبة (0.20)</label><input type="number" id="ratio" step="0.01" placeholder="0.20"></div>
            <div><label>مستخلص / ملاحظات</label><input type="text" id="batch"></div>
        </div>

        <div style="margin-top: 20px; text-align: left;">
            <button onclick="closeModal()" class="btn btn-outline" style="margin-left:10px;">إلغاء</button>
            <button onclick="saveTransaction()" class="btn btn-success" style="width: 150px; justify-content: center;">حفظ</button>
        </div>
    </div>
</div>

<div id="importModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close-modal" onclick="document.getElementById('importModal').style.display='none'">&times;</span>
        <h3>استيراد بيانات Excel</h3>
        <p>اختر ملف CSV يحتوي على البيانات</p>
        <input type="file" id="csvFile" accept=".csv">
        <button onclick="processCSV()" class="btn btn-warning" style="width:100%; margin-top:15px;">بدء الاستيراد</button>
    </div>
</div>

<script>
    // -----------------------------------------------------------
    // 1. إعدادات Firebase
    // -----------------------------------------------------------
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const siteId = new URLSearchParams(window.location.search).get('id');
    if(!siteId) window.location.href = "dashboard.html";

    // -----------------------------------------------------------
    // 2. دالة مساعدة لإصلاح التاريخ (الحل للمشكلة)
    // -----------------------------------------------------------
    function formatDateForInput(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return ""; // لو التاريخ غير صالح
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // إضافة 0 للشهر الفردي
        const day = String(date.getDate()).padStart(2, '0');       // إضافة 0 لليوم الفردي
        
        return `${year}-${month}-${day}`;
    }

    // -----------------------------------------------------------
    // 3. تحميل البيانات ومراقبتها
    // -----------------------------------------------------------
    auth.onAuthStateChanged(async user => {
        if(user) {
            const u = await db.collection('users').doc(user.uid).get();
            if(u.exists && u.data().role === 'admin') {
                document.getElementById('adminButtons').style.display = 'flex';
                document.getElementById('adminButtons').style.gap = '10px';
            }
            
            // مراقبة بيانات الموقع الرئيسية
            db.collection("budgets").doc(siteId).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('siteTitle').innerText = d.itemName;
                document.getElementById('statBudget').innerText = fmt(d.totalAllocatedAmount);
                document.getElementById('statSpent').innerText = fmt(d.totalSpent);
                document.getElementById('statBalance').innerText = fmt(d.currentBalance);
                document.getElementById('statProfit').innerText = fmt(d.totalProfit);
            });

            // مراقبة جدول الحركات
            db.collection("budgets").doc(siteId).collection("transactions").orderBy("orderNumber", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = "";
                snap.forEach(doc => {
                    const val = doc.data();
                    tbody.innerHTML += `
                    <tr class="data-row">
                        <td>${val.orderNumber}</td>
                        <td class="col-date">${val.date}</td>
                        <td class="col-po">${val.poNumber || '-'}</td>
                        <td class="col-supplier">${val.supplierName}</td>
                        <td class="col-invoice">${val.invoiceNum || '-'}</td>
                        <td class="col-invoice-date">${val.invoiceDate || '-'}</td>
                        <td>${fmt(val.amountExclTax)}</td>
                        <td>${val.companyRatio}</td>
                        <td>${fmt(val.companyProfit)}</td>
                        <td>
                            <button onclick="editTrans('${doc.id}')" class="btn btn-secondary" style="padding:5px 8px; font-size:0.8em;"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteTrans('${doc.id}', ${val.amountExclTax}, ${val.companyProfit})" class="btn btn-danger" style="padding:5px 8px; font-size:0.8em;"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                applyFilters(); // تطبيق الفلتر تلقائياً عند تحديث البيانات
            });
        }
    });

    // -----------------------------------------------------------
    // 4. دوال النافذة المنبثقة (Modal)
    // -----------------------------------------------------------
    function openModal() {
        document.getElementById('editTransId').value = "";
        document.getElementById('modalTitle').innerText = "تسجيل معاملة جديدة";
        document.querySelectorAll('#transactionModal input').forEach(i => i.value = "");
        document.getElementById('transactionModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('transactionModal').classList.remove('show');
    }

    // -----------------------------------------------------------
    // 5. دوال الفلترة (Filtering)
    // -----------------------------------------------------------
    function applyFilters() {
        const invFilter = document.getElementById('filterInvoice').value.toLowerCase();
        const poFilter = document.getElementById('filterPO').value.toLowerCase();
        const supFilter = document.getElementById('filterSupplier').value.toLowerCase();
        const dateFilter = document.getElementById('filterDate').value;

        const rows = document.querySelectorAll('.data-row');

        rows.forEach(row => {
            const invText = row.querySelector('.col-invoice').innerText.toLowerCase();
            const poText = row.querySelector('.col-po').innerText.toLowerCase();
            const supText = row.querySelector('.col-supplier').innerText.toLowerCase();
            const dateText = row.querySelector('.col-date').innerText;

            let show = true;

            if(invFilter && !invText.includes(invFilter)) show = false;
            if(poFilter && !poText.includes(poFilter)) show = false;
            if(supFilter && !supText.includes(supFilter)) show = false;
            if(dateFilter && dateText !== dateFilter) show = false;

            row.style.display = show ? '' : 'none';
        });
    }

    // -----------------------------------------------------------
    // 6. العمليات (حفظ / تعديل / حذف / استيراد)
    // -----------------------------------------------------------
    
    // حفظ (جديد أو تعديل)
    async function saveTransaction() {
        const id = document.getElementById('editTransId').value;
        const data = {
            orderNumber: Number(document.getElementById('orderNum').value),
            date: document.getElementById('orderDate').value,
            supplierName: document.getElementById('supplier').value,
            amountExclTax: Number(document.getElementById('amount').value),
            companyRatio: Number(document.getElementById('ratio').value),
            batchNumber: document.getElementById('batch').value,
            invoiceNum: document.getElementById('invoiceNum').value,
            invoiceDate: document.getElementById('invoiceDate').value,
            poNumber: document.getElementById('poNumber').value,
        };

        if(!data.amountExclTax || !data.orderNumber) return alert("أكمل البيانات الأساسية");
        data.companyProfit = data.amountExclTax * (data.companyRatio || 0);

        try {
            await db.runTransaction(async (t) => {
                const siteRef = db.collection("budgets").doc(siteId);
                const siteDoc = await t.get(siteRef);
                const currentSite = siteDoc.data();
                
                let newSpent = currentSite.totalSpent;
                let newProfit = currentSite.totalProfit;
                let newBalance = currentSite.currentBalance;

                if(id) {
                    // تعديل: نعكس القديم ونطبق الجديد
                    const oldDoc = await t.get(siteRef.collection("transactions").doc(id));
                    const oldData = oldDoc.data();
                    newSpent -= oldData.amountExclTax;
                    newProfit -= oldData.companyProfit;
                    newBalance += oldData.amountExclTax;
                    t.update(siteRef.collection("transactions").doc(id), data);
                } else {
                    // إضافة جديد
                    data.createdAt = new Date();
                    t.set(siteRef.collection("transactions").doc(), data);
                }
                
                newSpent += data.amountExclTax;
                newProfit += data.companyProfit;
                newBalance -= data.amountExclTax;
                
                t.update(siteRef, { totalSpent: newSpent, totalProfit: newProfit, currentBalance: newBalance });
            });
            
            closeModal();
            alert(id ? "تم التعديل بنجاح" : "تمت الإضافة بنجاح");
        } catch(e) { console.error(e); alert("خطأ: " + e.message); }
    }

    // فتح نافذة التعديل (مع إصلاح التاريخ)
    async function editTrans(id) {
        // إظهار النافذة وعنوان التحميل
        document.getElementById('modalTitle').innerText = "جاري جلب البيانات...";
        document.getElementById('transactionModal').classList.add('show');

        try {
            const doc = await db.collection("budgets").doc(siteId).collection("transactions").doc(id).get();
            if(!doc.exists) { alert("المعاملة غير موجودة"); closeModal(); return; }

            const d = doc.data();
            
            document.getElementById('editTransId').value = id;
            document.getElementById('modalTitle').innerText = "تعديل المعاملة";
            
            document.getElementById('orderNum').value = d.orderNumber;
            document.getElementById('supplier').value = d.supplierName;
            document.getElementById('amount').value = d.amountExclTax;
            document.getElementById('ratio').value = d.companyRatio;
            document.getElementById('batch').value = d.batchNumber || '';
            document.getElementById('invoiceNum').value = d.invoiceNum || '';
            document.getElementById('poNumber').value = d.poNumber || '';

            // استخدام الدالة المساعدة لضبط التواريخ
            document.getElementById('orderDate').value = formatDateForInput(d.date);
            document.getElementById('invoiceDate').value = formatDateForInput(d.invoiceDate);

        } catch(e) { console.error(e); closeModal(); alert("خطأ في التحميل"); }
    }

    // حذف
    async function deleteTrans(id, amount, profit) {
        if(!confirm("هل أنت متأكد من الحذف؟")) return;
        try {
            await db.runTransaction(async (t) => {
                const siteRef = db.collection("budgets").doc(siteId);
                const siteDoc = await t.get(siteRef);
                t.delete(siteRef.collection("transactions").doc(id));
                t.update(siteRef, {
                    totalSpent: siteDoc.data().totalSpent - amount,
                    totalProfit: siteDoc.data().totalProfit - profit,
                    currentBalance: siteDoc.data().currentBalance + amount
                });
            });
        } catch(e) { alert("خطأ في الحذف"); }
    }

    // استيراد CSV
    function processCSV() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert("اختر الملف");
        Papa.parse(file, {
            header: false, encoding: "windows-1256", skipEmptyLines: true,
            complete: async function(results) {
                const rows = results.data;
                const batch = db.batch();
                const siteRef = db.collection("budgets").doc(siteId);
                let bSpent=0, bProfit=0;
                
                for(let i=1; i<rows.length; i++){
                    const r = rows[i];
                    if(!r[0] || isNaN(parseFloat(r[3]))) continue;
                    const amount = parseFloat(r[3]);
                    const ratio = parseFloat(r[4]);
                    const newRef = siteRef.collection("transactions").doc();
                    batch.set(newRef, {
                        orderNumber: Number(r[0]), date: r[1], supplierName: r[2], amountExclTax: amount, companyRatio: ratio, companyProfit: amount * ratio,
                        invoiceNum: r[5] || '', invoiceDate: r[6] || '', poNumber: r[7] || '', batchNumber: r[8] || '', importedAt: new Date()
                    });
                    bSpent += amount; bProfit += (amount*ratio);
                }
                const cur = (await siteRef.get()).data();
                batch.update(siteRef, { totalSpent: (cur.totalSpent||0) + bSpent, totalProfit: (cur.totalProfit||0) + bProfit, currentBalance: cur.currentBalance - bSpent });
                await batch.commit();
                alert("تم الاستيراد");
                location.reload();
            }
        });
    }

    // تصفير الموقع
    async function clearAllData() {
        if(!confirm("تحذير: حذف الكل؟")) return;
        const siteRef = db.collection("budgets").doc(siteId);
        const snaps = await siteRef.collection("transactions").get();
        const batch = db.batch();
        snaps.forEach(d => batch.delete(d.ref));
        const origin = (await siteRef.get()).data().totalAllocatedAmount;
        batch.update(siteRef, { totalSpent: 0, totalProfit: 0, currentBalance: origin });
        await batch.commit();
        alert("تم التصفير");
        location.reload();
    }

    function fmt(n) { return Number(n).toLocaleString('ar-EG', {minimumFractionDigits: 2, maximumFractionDigits:2}); }
</script>
</body>
</html>
