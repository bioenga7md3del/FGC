<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <div>
            <h2 id="siteTitle">...</h2>
            <a href="dashboard.html" class="btn btn-warning" style="font-size:0.8em;">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>
        <div id="siteStats" style="text-align: left;">
            </div>
    </div>

    <div class="stat-grid">
        <div class="card"><h3>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h3><p id="statBudget">0</p></div>
        <div class="card"><h3>Ø§Ù„Ù…ØµØ±ÙˆÙ</h3><p id="statSpent" style="color:var(--danger)">0</p></div>
        <div class="card"><h3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3><p id="statBalance" style="color:var(--success)">0</p></div>
        <div class="card"><h3>Ø§Ù„Ø±Ø¨Ø­</h3><p id="statProfit" style="color:var(--secondary)">0</p></div>
    </div>

    <div class="card" id="formCard" style="border-top: 5px solid var(--primary);">
        <h3 id="formTitle">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <input type="hidden" id="editTransId"> <div class="form-grid">
            <div><label>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ù…ÙŠØ¯</label><input type="number" id="orderNum"></div>
            <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ù…ÙŠØ¯</label><input type="date" id="orderDate"></div>
            <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><input type="text" id="supplier"></div>
            
            <div style="background:#f9f9f9; padding:5px; border-radius:5px;">
                <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input type="text" id="invoiceNum">
            </div>
            <div style="background:#f9f9f9; padding:5px; border-radius:5px;">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input type="date" id="invoiceDate">
            </div>
            <div style="background:#f9f9f9; padding:5px; border-radius:5px;">
                <label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (PO)</label><input type="text" id="poNumber">
            </div>

            <div><label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©)</label><input type="number" id="amount"></div>
            <div><label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© (0.20)</label><input type="number" id="ratio" step="0.01"></div>
            <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ù…Ø³ØªØ®Ù„Øµ</label><input type="text" id="batch"></div>
        </div>
        
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button onclick="saveTransaction()" class="btn btn-success" id="saveBtn" style="flex:2;">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            <button onclick="cancelEdit()" class="btn btn-danger" id="cancelBtn" style="display:none; flex:1;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>
    </div>

    <div class="card">
        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ¹Ù…ÙŠØ¯</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>PO #</th>
                        <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                        <th>ÙØ§ØªÙˆØ±Ø© #</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                        <th>Ø§Ù„Ø±Ø¨Ø­</th>
                        <th>ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="adminTools" class="card" style="display:none; background:#fffbf0; border:2px dashed orange;">
        <h3>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
        <input type="file" id="csvFile" accept=".csv">
        <button onclick="processCSV()" class="btn btn-warning">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</button>
        <button onclick="clearAllData()" class="btn btn-danger" style="float:left;">ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
        <p style="font-size:0.8em; color:#666; margin-top:5px;">
            * ØªØ±ØªÙŠØ¨ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù€ CSV Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†:<br>
            [1:Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ù…ÙŠØ¯] [2:ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ù…ÙŠØ¯] [3:Ø§Ù„Ù…ÙˆØ±Ø¯] [4:Ø§Ù„Ù…Ø¨Ù„Øº] [5:Ø§Ù„Ù†Ø³Ø¨Ø©] [6:Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©] [7:ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©] [8:PO#] [9:Ù…Ù„Ø§Ø­Ø¸Ø§Øª]
        </p>
    </div>

</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const siteId = new URLSearchParams(window.location.search).get('id');
    if(!siteId) window.location.href = "dashboard.html";

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    auth.onAuthStateChanged(async user => {
        if(user) {
            const u = await db.collection('users').doc(user.uid).get();
            if(u.exists && u.data().role === 'admin') document.getElementById('adminTools').style.display = 'block';
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
            db.collection("budgets").doc(siteId).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('siteTitle').innerText = d.itemName;
                document.getElementById('statBudget').innerText = fmt(d.totalAllocatedAmount);
                document.getElementById('statSpent').innerText = fmt(d.totalSpent);
                document.getElementById('statBalance').innerText = fmt(d.currentBalance);
                document.getElementById('statProfit').innerText = fmt(d.totalProfit);
            });

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
            db.collection("budgets").doc(siteId).collection("transactions").orderBy("orderNumber", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = "";
                snap.forEach(doc => {
                    const val = doc.data();
                    tbody.innerHTML += `
                    <tr>
                        <td>${val.orderNumber}</td>
                        <td>${val.date}</td>
                        <td><small>${val.poNumber || '-'}</small></td>
                        <td>${val.supplierName}</td>
                        <td>${val.invoiceNum || '-'}</td>
                        <td>${val.invoiceDate || '-'}</td>
                        <td>${fmt(val.amountExclTax)}</td>
                        <td>${val.companyRatio}</td>
                        <td>${fmt(val.companyProfit)}</td>
                        <td>
                            <button onclick="editTrans('${doc.id}')" class="btn btn-secondary" style="padding:2px 8px; font-size:12px;">âœï¸</button>
                            <button onclick="deleteTrans('${doc.id}', ${val.amountExclTax}, ${val.companyProfit})" class="btn btn-danger" style="padding:2px 8px; font-size:12px;">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                });
            });
        }
    });

    // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„) ---
    async function saveTransaction() {
        const id = document.getElementById('editTransId').value;
        const data = {
            orderNumber: Number(document.getElementById('orderNum').value),
            date: document.getElementById('orderDate').value,
            supplierName: document.getElementById('supplier').value,
            amountExclTax: Number(document.getElementById('amount').value),
            companyRatio: Number(document.getElementById('ratio').value),
            batchNumber: document.getElementById('batch').value,
            // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            invoiceNum: document.getElementById('invoiceNum').value,
            invoiceDate: document.getElementById('invoiceDate').value,
            poNumber: document.getElementById('poNumber').value,
        };

        if(!data.amountExclTax || !data.orderNumber) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");
        data.companyProfit = data.amountExclTax * data.companyRatio;

        try {
            await db.runTransaction(async (t) => {
                const siteRef = db.collection("budgets").doc(siteId);
                const siteDoc = await t.get(siteRef);
                const currentSite = siteDoc.data();
                
                let newSpent = currentSite.totalSpent;
                let newProfit = currentSite.totalProfit;
                let newBalance = currentSite.currentBalance;

                if(id) {
                    // ** Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ **: Ù†Ø¹ÙƒØ³ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹
                    const oldDoc = await t.get(siteRef.collection("transactions").doc(id));
                    const oldData = oldDoc.data();
                    newSpent -= oldData.amountExclTax;
                    newProfit -= oldData.companyProfit;
                    newBalance += oldData.amountExclTax;
                    
                    // Ø«Ù… Ù†Ø·Ø¨Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    t.update(siteRef.collection("transactions").doc(id), data);
                } else {
                    // ** Ø­Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯ **
                    data.createdAt = new Date();
                    t.set(siteRef.collection("transactions").doc(), data);
                }

                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                newSpent += data.amountExclTax;
                newProfit += data.companyProfit;
                newBalance -= data.amountExclTax;

                t.update(siteRef, { totalSpent: newSpent, totalProfit: newProfit, currentBalance: newBalance });
            });
            
            alert(id ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
            cancelEdit(); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        } catch(e) { console.error(e); alert("Ø®Ø·Ø£: " + e.message); }
    }

    // --- ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---
    async function editTrans(id) {
        const doc = await db.collection("budgets").doc(siteId).collection("transactions").doc(id).get();
        const d = doc.data();
        
        document.getElementById('editTransId').value = id;
        document.getElementById('orderNum').value = d.orderNumber;
        document.getElementById('orderDate').value = d.date;
        document.getElementById('supplier').value = d.supplierName;
        document.getElementById('amount').value = d.amountExclTax;
        document.getElementById('ratio').value = d.companyRatio;
        document.getElementById('batch').value = d.batchNumber || '';
        document.getElementById('invoiceNum').value = d.invoiceNum || '';
        document.getElementById('invoiceDate').value = d.invoiceDate || '';
        document.getElementById('poNumber').value = d.poNumber || '';

        // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±
        document.getElementById('saveBtn').innerText = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
        document.getElementById('saveBtn').className = "btn btn-warning";
        document.getElementById('formTitle').innerText = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©";
        document.getElementById('cancelBtn').style.display = 'inline-block';
        window.scrollTo(0,0);
    }

    function cancelEdit() {
        document.getElementById('editTransId').value = "";
        document.querySelectorAll('input').forEach(i => i.value = "");
        document.getElementById('saveBtn').innerText = "Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
        document.getElementById('saveBtn').className = "btn btn-success";
        document.getElementById('formTitle').innerText = "â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©";
        document.getElementById('cancelBtn').style.display = 'none';
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        document.getElementById('ratio').value = "0.20"; // Ø£Ùˆ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    }

    // --- Ø§Ù„Ø­Ø°Ù ---
    async function deleteTrans(id, amount, profit) {
        if(!confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„ØºØŸ")) return;
        await db.runTransaction(async (t) => {
            const siteRef = db.collection("budgets").doc(siteId);
            const siteDoc = await t.get(siteRef);
            
            t.delete(siteRef.collection("transactions").doc(id));
            t.update(siteRef, {
                totalSpent: siteDoc.data().totalSpent - amount,
                totalProfit: siteDoc.data().totalProfit - profit,
                currentBalance: siteDoc.data().currentBalance + amount
            });
        });
    }

    // --- Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (CSV) ---
    function processCSV() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù");
        
        Papa.parse(file, {
            header: false, encoding: "windows-1256", skipEmptyLines: true,
            complete: async function(results) {
                const rows = results.data;
                const batch = db.batch();
                const siteRef = db.collection("budgets").doc(siteId);
                
                let bSpent=0, bProfit=0;
                
                // Ù†Ø¨Ø¯Ø£ Ù…Ù† 1 (ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)
                for(let i=1; i<rows.length; i++){
                    const r = rows[i];
                    if(!r[0] || isNaN(parseFloat(r[3]))) continue;
                    
                    const amount = parseFloat(r[3]);
                    const ratio = parseFloat(r[4]);
                    
                    const newRef = siteRef.collection("transactions").doc();
                    batch.set(newRef, {
                        orderNumber: Number(r[0]),
                        date: r[1],
                        supplierName: r[2],
                        amountExclTax: amount,
                        companyRatio: ratio,
                        companyProfit: amount * ratio,
                        // ØªØ®Ù…ÙŠÙ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³Ù„
                        invoiceNum: r[5] || '',    // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¯Ø³
                        invoiceDate: r[6] || '',   // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ø¹
                        poNumber: r[7] || '',      // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù…Ù†
                        batchNumber: r[8] || '',
                        importedAt: new Date()
                    });
                    bSpent += amount; bProfit += (amount*ratio);
                }
                
                const cur = (await siteRef.get()).data();
                batch.update(siteRef, {
                    totalSpent: (cur.totalSpent||0) + bSpent,
                    totalProfit: (cur.totalProfit||0) + bProfit,
                    currentBalance: cur.currentBalance - bSpent
                });
                
                await batch.commit();
                alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
                location.reload();
            }
        });
    }

    async function clearAllData() {
        if(!confirm("ØªØ­Ø°ÙŠØ±: Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;
        const siteRef = db.collection("budgets").doc(siteId);
        const snaps = await siteRef.collection("transactions").get();
        const batch = db.batch();
        snaps.forEach(d => batch.delete(d.ref));
        
        const origin = (await siteRef.get()).data().totalAllocatedAmount;
        batch.update(siteRef, { totalSpent: 0, totalProfit: 0, currentBalance: origin });
        await batch.commit();
        location.reload();
    }

    function fmt(n) { return Number(n).toLocaleString('ar-EG', {maximumFractionDigits:2}); }
</script>
</body>
</html>
