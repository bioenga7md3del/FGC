<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحليل العقد - FGC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        /* --- تخصيص الجدول لهذه الصفحة فقط --- */
        .details-table-container {
            background: white; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-sm); 
            border: 1px solid var(--border-color); 
            overflow: hidden;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* ضمان عدم انكماش الجدول أكثر من اللازم */
        }

        .details-table th {
            background-color: #f8fafc;
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 0.9rem;
            padding: 18px 15px; /* تكبير المساحة */
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .details-table td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            color: var(--text-main);
            vertical-align: middle;
            font-size: 0.95rem;
        }

        .details-table tr:last-child td { border-bottom: none; }
        .details-table tr:hover td { background-color: #fcfcfc; }

        /* --- باقي التنسيقات --- */
        .print-header { display: none; text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
        .charts-row { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .chart-box { 
            background: white; border-radius: var(--radius); padding: 20px; 
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
            flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center;
        }
        .chart-box h4 { margin-top: 0; color: var(--text-secondary); margin-bottom: 15px; }
        
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        .stat-card {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
            text-align: center; position: relative; overflow: hidden;
        }
        .stat-card h3 { font-size: 0.9rem; color: var(--text-secondary); margin: 0 0 10px 0; }
        .stat-card p { font-size: 1.5rem; font-weight: 800; margin: 0; color: var(--text-main); }
        .stat-card.primary { border-bottom: 4px solid var(--primary); }
        .stat-card.danger { border-bottom: 4px solid var(--danger); }
        .stat-card.success { border-bottom: 4px solid var(--success); }
        .stat-card.accent { border-bottom: 4px solid var(--accent); }

        @media print {
            body { background: white; font-size: 12pt; }
            .navbar, .btn-print, .btn-back { display: none !important; }
            .print-header { display: block; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            .chart-box, .stat-card, .details-table-container { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000; padding: 5px; color: black; }
        }
    </style>
</head>
<body>

<div class="print-header">
    <img src="FGC.jpeg" style="height: 60px; margin-bottom: 10px;">
    <h1>تقرير تحليل عقد شامل</h1>
    <h2 id="printContractName" style="color:var(--primary);"></h2>
    <p>تاريخ التقرير: <span id="printDate"></span></p>
</div>

<nav class="navbar">
    <div class="nav-brand">
        <img src="FGC.jpeg" alt="Logo">
        <div>
            <h2>FGC System</h2>
            <span style="font-size: 0.8rem; color: #888;">تحليل العقود</span>
        </div>
    </div>
    <div style="display:flex; gap:10px;">
        <a href="dashboard.html" class="btn-logout btn-back" style="background:transparent; border:1px solid #ddd; color:var(--text-secondary);">
            <i class="fa-solid fa-arrow-right"></i> عودة
        </a>
        <button onclick="window.print()" class="btn-logout btn-print" style="background:var(--primary); color:white;">
            <i class="fa-solid fa-print"></i> طباعة
        </button>
    </div>
</nav>

<div class="container">
    
    <div class="welcome-section" style="border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 30px;">
        <h2 id="pageTitle" style="color:var(--primary); font-size: 1.8rem; margin-bottom: 10px;">جاري التحميل...</h2>
        <div id="contractMeta" style="color:var(--text-secondary); display:flex; gap: 20px; flex-wrap:wrap; font-size: 0.95rem;"></div>
    </div>

    <div class="stats-grid">
        <div class="stat-card primary">
            <h3><i class="fa-solid fa-calculator"></i> إجمالي العقد</h3>
            <p id="totalVal">0</p>
        </div>
        <div class="stat-card danger">
            <h3><i class="fa-solid fa-chart-pie"></i> إجمالي المصروف</h3>
            <p id="totalSpent" style="color:var(--danger)">0</p>
        </div>
        <div class="stat-card success">
            <h3><i class="fa-solid fa-wallet"></i> إجمالي المتبقي</h3>
            <p id="totalBal" style="color:var(--success)">0</p>
        </div>
        <div class="stat-card accent">
            <h3><i class="fa-solid fa-arrow-trend-up"></i> إجمالي الأرباح</h3>
            <p id="totalProfit" style="color:var(--accent)">0</p>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-box">
            <h4>نسبة الإنجاز المالي</h4>
            <div style="position: relative; height: 250px; width: 100%; display:flex; justify-content:center;">
                <canvas id="progressChart"></canvas>
            </div>
        </div>
        <div class="chart-box">
            <h4>توزيع الميزانية حسب البند</h4>
            <div style="position: relative; height: 250px; width: 100%;">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <h3 class="section-title">
        <i class="fa-solid fa-list-check"></i> تفاصيل المواقع والبنود المدرجة بالعقد
    </h3>

    <div class="details-table-container">
        <div style="overflow-x:auto;">
            <table class="details-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">الموقع / البند</th>
                        <th style="width: 10%;">التصنيف</th>
                        <th style="width: 15%;">الميزانية</th>
                        <th style="width: 15%;">المصروف</th>
                        <th style="width: 15%;">المتبقي</th>
                        <th style="width: 10%;">نسبة الصرف</th>
                        <th style="width: 5%;">الحالة</th>
                    </tr>
                </thead>
                <tbody id="sitesTableBody"></tbody>
            </table>
        </div>
    </div>
    
    <div style="height: 50px;"></div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const contractId = new URLSearchParams(window.location.search).get('id');
    if(!contractId) window.location.href = "dashboard.html";

    const catLabels = { 
        'spare_parts': '<span class="cat-badge" style="background:var(--primary)">قطع غيار</span>', 
        'labor': '<span class="cat-badge" style="background:var(--accent)">عمالة</span>', 
        'subcontractors': '<span class="cat-badge" style="background:#6b7280">مقاولي باطن</span>' 
    };

    Promise.all([
        db.collection('contracts').doc(contractId).get(),
        db.collection('budgets').where('contractId', '==', contractId).get()
    ]).then(([contractDoc, sitesSnap]) => {
        if(!contractDoc.exists) return alert("العقد غير موجود");
        
        const contract = contractDoc.data();
        const sites = [];
        sitesSnap.forEach(doc => sites.push({id: doc.id, ...doc.data()}));
        
        renderPage(contract, sites);
    });

    function renderPage(contract, sites) {
        document.getElementById('pageTitle').innerText = contract.name;
        document.getElementById('printContractName').innerText = contract.name;
        document.getElementById('printDate').innerText = new Date().toLocaleDateString('ar-EG');
        
        let info = [];
        if(contract.supervisingAuthority) info.push(`<span><i class="fa-solid fa-building-columns"></i> الجهة المشرفة: <b>${contract.supervisingAuthority}</b></span>`);
        if(contract.startDate) info.push(`<span><i class="fa-regular fa-calendar"></i> المدة: <b>${contract.startDate}</b> إلى <b>${contract.endDate}</b></span>`);
        document.getElementById('contractMeta').innerHTML = info.join('');

        let totalAllocated = 0, totalSpent = 0, totalProfit = 0;
        let catStats = { 'spare_parts': 0, 'labor': 0, 'subcontractors': 0 };

        const tbody = document.getElementById('sitesTableBody');
        tbody.innerHTML = '';

        if(sites.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#888;">لا توجد بنود في هذا العقد.</td></tr>';
        }

        sites.forEach(site => {
            totalAllocated += (site.totalAllocatedAmount || 0);
            totalSpent += (site.totalSpent || 0);
            totalProfit += (site.totalProfit || 0);
            
            const cat = site.category || 'spare_parts';
            catStats[cat] += (site.totalAllocatedAmount || 0);

            const percent = site.totalAllocatedAmount ? (site.totalSpent / site.totalAllocatedAmount) * 100 : 0;
            const statusColor = percent > 90 ? '#ef4444' : '#10b981';
            const statusText = percent > 90 ? 'حرجة' : 'جيدة';

            tbody.innerHTML += `
            <tr>
                <td style="font-weight:bold; color:var(--primary); font-size:1rem;">
                    <a href="details.html?id=${site.id}" style="text-decoration:none; color:inherit;">${site.itemName}</a>
                </td>
                <td>${catLabels[cat] || cat}</td>
                <td style="font-family:'Tajawal';">${fmt(site.totalAllocatedAmount)}</td>
                <td style="color:var(--danger); font-family:'Tajawal';">${fmt(site.totalSpent)}</td>
                <td style="color:var(--success); font-weight:bold; font-family:'Tajawal';">${fmt(site.currentBalance)}</td>
                <td>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="background:#e5e7eb; height:8px; border-radius:10px; width:100px; overflow:hidden;">
                            <div style="background:${statusColor}; width:${Math.min(percent,100)}%; height:100%;"></div>
                        </div>
                        <small style="min-width:35px;">${percent.toFixed(1)}%</small>
                    </div>
                </td>
                <td><span style="color:${statusColor}; font-weight:bold; font-size:0.85em;">${statusText}</span></td>
            </tr>`;
        });

        document.getElementById('totalVal').innerText = fmt(totalAllocated);
        document.getElementById('totalSpent').innerText = fmt(totalSpent);
        document.getElementById('totalBal').innerText = fmt(totalAllocated - totalSpent);
        document.getElementById('totalProfit').innerText = fmt(totalProfit);

        new Chart(document.getElementById('progressChart'), {
            type: 'doughnut',
            data: {
                labels: ['المصروف', 'المتبقي'],
                datasets: [{ 
                    data: [totalSpent, Math.max(0, totalAllocated - totalSpent)], 
                    backgroundColor: ['#ef4444', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        new Chart(document.getElementById('categoryChart'), {
            type: 'bar',
            data: {
                labels: ['قطع غيار', 'عمالة', 'مقاولي باطن'],
                datasets: [{ 
                    label: 'الميزانية الموزعة',
                    data: [catStats['spare_parts'], catStats['labor'], catStats['subcontractors']],
                    backgroundColor: ['#1e3a8a', '#f59e0b', '#6b7280'],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits: 2}); }
</script>
</body>
</html>
