<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحليل العقد - FGC</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="print-header">
    <h1>تقرير تحليل عقد شامل</h1>
    <h2 id="printContractName"></h2>
</div>

<div class="container">
    <div class="header-bar">
        <div class="header-title-box">
            <img src="FGC.jpeg" alt="Logo" class="logo-img" style="max-height: 60px;">
            <div>
                <h2 id="pageTitle">جاري التحميل...</h2>
                <div class="contract-meta" id="contractMeta"></div>
                <div style="margin-top: 5px;">
                    <a href="dashboard.html" class="btn btn-outline" style="font-size:0.8em; padding: 5px 10px;">
                        <i class="fa-solid fa-arrow-right"></i> العودة للرئيسية
                    </a>
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="window.print()" class="btn btn-outline"><i class="fa-solid fa-print"></i> طباعة التقرير</button>
        </div>
    </div>

    <div class="dashboard-top-section">
        <div class="stats-area">
            <div class="card" style="border-bottom:4px solid var(--primary);">
                <h3>إجمالي قيمة العقد</h3><p id="totalVal">0</p>
            </div>
            <div class="card" style="border-bottom:4px solid var(--danger);">
                <h3>إجمالي المصروف</h3><p id="totalSpent" style="color:var(--danger)">0</p>
            </div>
            <div class="card" style="border-bottom:4px solid var(--success);">
                <h3>إجمالي المتبقي</h3><p id="totalBal" style="color:var(--success)">0</p>
            </div>
            <div class="card" style="border-bottom:4px solid var(--accent);">
                <h3>إجمالي الأرباح</h3><p id="totalProfit" style="color:var(--accent)">0</p>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
        <div class="chart-area" style="flex:1; min-width: 300px;">
            <h4>نسبة الإنجاز المالي</h4>
            <div class="chart-container" style="height: 250px;">
                <canvas id="progressChart"></canvas>
            </div>
        </div>
        <div class="chart-area" style="flex:1; min-width: 300px;">
            <h4>توزيع الميزانية حسب البند</h4>
            <div class="chart-container" style="height: 250px;">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card" style="padding: 0; overflow: hidden;">
        <h3 style="padding: 20px; margin: 0; background: #fdfdfd; border-bottom: 1px solid #eee;">
            <i class="fa-solid fa-list-check"></i> تفاصيل المواقع والبنود المدرجة بالعقد
        </h3>
        <div class="table-container" style="box-shadow: none;">
            <table>
                <thead>
                    <tr>
                        <th>الموقع / البند</th>
                        <th>التصنيف</th>
                        <th>الميزانية</th>
                        <th>المصروف</th>
                        <th>المتبقي</th>
                        <th>نسبة الصرف</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="sitesTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCHZsLreB9fd8fkjnj87miAPDrZsKMOrDI", authDomain: "fgcbio.firebaseapp.com", projectId: "fgcbio", storageBucket: "fgcbio.firebasestorage.app", messagingSenderId: "924334872806", appId: "1:924334872806:web:fac89ce388b1ff2de24327" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const contractId = new URLSearchParams(window.location.search).get('id');
    if(!contractId) window.location.href = "dashboard.html";

    const catLabels = { 'spare_parts': 'قطع غيار', 'labor': 'عمالة', 'subcontractors': 'مقاولي باطن' };

    // تحميل البيانات
    Promise.all([
        db.collection('contracts').doc(contractId).get(),
        db.collection('budgets').where('contractId', '==', contractId).get()
    ]).then(([contractDoc, sitesSnap]) => {
        if(!contractDoc.exists) return alert("العقد غير موجود");
        
        const contract = contractDoc.data();
        const sites = [];
        sitesSnap.forEach(doc => sites.push({id: doc.id, ...doc.data()}));
        
        renderPage(contract, sites);
    });

    function renderPage(contract, sites) {
        document.getElementById('pageTitle').innerText = contract.name;
        document.getElementById('printContractName').innerText = contract.name;
        
        let info = [];
        if(contract.supervisingAuthority) info.push(`<i class="fa-solid fa-building"></i> ${contract.supervisingAuthority}`);
        if(contract.startDate) info.push(`<i class="fa-regular fa-calendar"></i> ${contract.startDate} - ${contract.endDate}`);
        document.getElementById('contractMeta').innerHTML = info.join(' | ');

        // الحسابات المجمعة
        let totalAllocated = 0, totalSpent = 0, totalProfit = 0;
        let catStats = { 'spare_parts': 0, 'labor': 0, 'subcontractors': 0 };

        const tbody = document.getElementById('sitesTableBody');
        tbody.innerHTML = '';

        sites.forEach(site => {
            totalAllocated += (site.totalAllocatedAmount || 0);
            totalSpent += (site.totalSpent || 0);
            totalProfit += (site.totalProfit || 0);
            
            const cat = site.category || 'spare_parts';
            catStats[cat] += (site.totalAllocatedAmount || 0); // نجمع الميزانية حسب التصنيف

            const percent = site.totalAllocatedAmount ? (site.totalSpent / site.totalAllocatedAmount) * 100 : 0;
            const status = percent > 90 ? '<span style="color:red; font-weight:bold">حرجة</span>' : '<span style="color:green">جيدة</span>';

            tbody.innerHTML += `
            <tr>
                <td><a href="details.html?id=${site.id}" style="text-decoration:none; color:var(--primary); font-weight:bold;">${site.itemName}</a></td>
                <td>${catLabels[cat] || cat}</td>
                <td>${fmt(site.totalAllocatedAmount)}</td>
                <td>${fmt(site.totalSpent)}</td>
                <td>${fmt(site.currentBalance)}</td>
                <td>
                    <div style="background:#eee; height:8px; border-radius:4px; width:100px; display:inline-block;">
                        <div style="background:${percent>90?'var(--danger)':'var(--primary)'}; width:${Math.min(percent,100)}%; height:100%; border-radius:4px;"></div>
                    </div>
                    <small>${percent.toFixed(1)}%</small>
                </td>
                <td>${status}</td>
            </tr>`;
        });

        // تحديث البطاقات
        document.getElementById('totalVal').innerText = fmt(totalAllocated);
        document.getElementById('totalSpent').innerText = fmt(totalSpent);
        document.getElementById('totalBal').innerText = fmt(totalAllocated - totalSpent);
        document.getElementById('totalProfit').innerText = fmt(totalProfit);

        // الرسم البياني 1: المصروف
        new Chart(document.getElementById('progressChart'), {
            type: 'doughnut',
            data: {
                labels: ['المصروف', 'المتبقي'],
                datasets: [{ data: [totalSpent, Math.max(0, totalAllocated - totalSpent)], backgroundColor: ['#c0392b', '#27ae60'] }]
            }
        });

        // الرسم البياني 2: التوزيع
        new Chart(document.getElementById('categoryChart'), {
            type: 'bar',
            data: {
                labels: ['قطع غيار', 'عمالة', 'مقاولي باطن'],
                datasets: [{ 
                    label: 'الميزانية الموزعة',
                    data: [catStats['spare_parts'], catStats['labor'], catStats['subcontractors']],
                    backgroundColor: ['#1a3c6d', '#e67e22', '#6c757d']
                }]
            }
        });
    }

    function fmt(n) { return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits: 2}); }
</script>
</body>
</html>
